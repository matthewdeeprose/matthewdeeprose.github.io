<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="Boilerplate" />
    <meta name="keywords" content="accessibility, presentation, blog" />
    <meta name="author" content="Matthew Deeprose" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Boilerplate</title>
    <link
      rel="stylesheet"
      id="lightCSS"
      href="light.css"
      media="(prefers-color-scheme: light)"
    />
    <link rel="stylesheet" id="mainCSS" href="main.css" media="all" />
    <link
      rel="stylesheet"
      id="darkCSS"
      href="dark.css"
      media="(prefers-color-scheme: dark)"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" id="printCSS" href="print.css" media="print" />
    <link rel="stylesheet" href="md-scripts/css/sortable-table.css" />
    <link rel="stylesheet" href="md-scripts/css/mermaid-controls.css" />
    <link rel="stylesheet" href="mathpix-scripts/css/mathpix-main.css" />
    <link rel="stylesheet" href="mathpix-scripts/css/mathpix-pdf-preview.css" />
    <link rel="stylesheet" href="md-scripts/css/chart-controls.css" />
    <link rel="stylesheet" href="md-scripts/css/markdown-editor.css" />
    <link rel="stylesheet" href="md-scripts/css/mermaid-view-controls.css" />
    <link rel="stylesheet" href="md-scripts/css/chart-view-controls.css" />
    <link rel="stylesheet" href="md-scripts/css/graph-builder.css" />
    <link rel="stylesheet" href="md-scripts/css/modal.css" />
    <link rel="stylesheet" href="file-upload.css" />
    <link rel="stylesheet" href="error-handler.css" />

    <link
      rel="stylesheet"
      href="md-scripts/css/mermaid-description-styles.css"
    />
    <script src="js/universal-notifications.js"></script>
    <meta property="og:title" content="Boilerplate - Matthew Deeprose" />
    <meta property="og:description" content="" />
    <meta
      property="og:image"
      content="https://matthewdeeprose.github.io/image.png"
    />
    <meta property="og:image:width" content="2500" />
    <meta property="og:image:height" content="1306" />
    <meta property="og:image:alt" content="" />
    <meta property="og:locale" content="en_GB" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://matthewdeeprose.github.io/boilerplate.html"
    />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="theme-color"
      content="#231F20"
      media="(prefers-color-scheme: dark)"
    />
    <meta
      name="theme-color"
      content="#FFFFF4"
      media="(prefers-color-scheme: light)"
    />
    <link rel="icon" href="favicon.ico" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed for matthewdeeprose.github.io"
      href="https://matthewdeeprose.github.io/feed.rss"
    />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Boilerplate - Matthew Deeprose" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:creator" content="@VLEguru" />
    <meta name="twitter:site" content="@VLEguru" />
    <meta
      name="twitter:image"
      content="https://matthewdeeprose.github.io/image.png"
    />
    <meta name="twitter:image:alt" content="" />
    <meta name="twitter:card" content="summary_large_image" />
    <style>
      .page-wrap > * {
        grid-column: 1/-1 !important;
        grid-row: auto !important;
      }
      /* wider border just for this page */
      @media (min-width: 60rem) {
        .page-wrap {
          margin: 0 5% 0 5%;
        }
      }

      /*style form to limit width and highlight the long label*/
      form {
        max-width: 750px;
      }
    </style>
    <script
      type="text/javascript"
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"
    ></script>
    <script>
      // MathJax loading timeout detection (add after MathJax script tag)
      (function () {
        const MATHJAX_TIMEOUT = 15000; // 15 seconds

        setTimeout(function () {
          if (
            !window.MathJax ||
            typeof window.MathJax.typesetPromise !== "function"
          ) {
            console.error("MathJax failed to load within timeout");
            console.warn("Attempting cache-busting reload...");

            // Remove the old script
            const oldScript = document.getElementById("MathJax-script");
            if (oldScript) oldScript.remove();

            // Add new script with cache buster
            const script = document.createElement("script");
            script.src =
              "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js?v=" +
              Date.now();
            script.id = "MathJax-script";
            script.async = true;
            document.head.appendChild(script);
          }
        }, MATHJAX_TIMEOUT);
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@4.1.0/cdn.min.js"></script>

    <!-- Logging Configuration Script - Must be loaded early -->
    <script>
      // Logging configuration (document level - available to all inline scripts)
      (function () {
        const LOG_LEVELS = {
          ERROR: 0,
          WARN: 1,
          INFO: 2,
          DEBUG: 3,
        };

        const DEFAULT_LOG_LEVEL = LOG_LEVELS.WARN;
        const ENABLE_ALL_LOGGING = false;
        const DISABLE_ALL_LOGGING = false;

        // Helper functions
        function shouldLog(level) {
          if (DISABLE_ALL_LOGGING) return false;
          if (ENABLE_ALL_LOGGING) return true;
          return level <= DEFAULT_LOG_LEVEL;
        }

        function logError(message, ...args) {
          if (shouldLog(LOG_LEVELS.ERROR)) console.error(message, ...args);
        }

        function logWarn(message, ...args) {
          if (shouldLog(LOG_LEVELS.WARN)) console.warn(message, ...args);
        }

        function logInfo(message, ...args) {
          if (shouldLog(LOG_LEVELS.INFO)) console.log(message, ...args);
        }

        function logDebug(message, ...args) {
          if (shouldLog(LOG_LEVELS.DEBUG)) console.log(message, ...args);
        }

        // Make logging functions available globally for all inline scripts
        window.AppLogging = {
          LOG_LEVELS: LOG_LEVELS,
          shouldLog: shouldLog,
          logError: logError,
          logWarn: logWarn,
          logInfo: logInfo,
          logDebug: logDebug,
        };

        logInfo(
          "Logging system initialised with level:",
          DEFAULT_LOG_LEVEL <= LOG_LEVELS.ERROR
            ? "ERROR"
            : DEFAULT_LOG_LEVEL <= LOG_LEVELS.WARN
            ? "WARN"
            : DEFAULT_LOG_LEVEL <= LOG_LEVELS.INFO
            ? "INFO"
            : "DEBUG"
        );
      })();
    </script>

    <script>
      // Check script loading order
      document.addEventListener("DOMContentLoaded", function () {
        window.AppLogging.logDebug(
          "[Script Loading Debug] DOM is loaded, checking for MermaidThemes"
        );
        if (window.MermaidThemes) {
          window.AppLogging.logDebug(
            "[Script Loading Debug] MermaidThemes is already loaded"
          );
        } else {
          window.AppLogging.logDebug(
            "[Script Loading Debug] MermaidThemes is NOT loaded yet"
          );

          // Add an interval to check when it becomes available
          const checkInterval = setInterval(function () {
            if (window.MermaidThemes) {
              window.AppLogging.logDebug(
                "[Script Loading Debug] MermaidThemes is now available"
              );
              clearInterval(checkInterval);
            }
          }, 100);

          // Clear interval after 5 seconds to avoid infinite checking
          setTimeout(function () {
            clearInterval(checkInterval);
            if (!window.MermaidThemes) {
              window.AppLogging.logWarn(
                "[Script Loading Debug] MermaidThemes still not available after 5 seconds"
              );
            }
          }, 5000);
        }
      });
    </script>
  </head>
  <body>
    <div class="page-wrap" id="start">
      <a class="skip-link" id="skipToContent" href="#main">Skip to content</a>
      <header class="page-header">
        <div id="banner">
          <div id="logo">
            <button
              id="modeToggle"
              aria-label="Change between light and dark theme"
              aria-pressed="false"
              onclick="toggle(this.id);"
            >
              <svg
                id="logoSVG"
                height="45"
                viewBox="0 0 21 21"
                width="45"
                xmlns="http://www.w3.org/2000/svg"
                aria-labelledby="svgTitle svgDesc"
                role="img"
              >
                <title id="svgTitle">Change theme</title>
                <desc id="svgDesc">Select to switch to light theme</desc>
                <g
                  fill="none"
                  fill-rule="evenodd"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  transform="translate(2 1)"
                >
                  <path d="m6.5 17.5h4" />
                  <path
                    d="m8.5 4c2.4852814 0 4.5 2.01471863 4.5 4.5 0 1.7663751-1.017722 3.2950485-2.4987786 4.031633l-.0012214.968367c0 1.1045695-.8954305 2-2 2s-2-.8954305-2-2l-.00021218-.9678653c-1.48160351-.7363918-2.49978782-2.2653584-2.49978782-4.0321347 0-2.48528137 2.01471863-4.5 4.5-4.5z"
                  />
                  <path d="m8.5 1.5v-1" />
                  <path d="m13.5 3.5 1-1" />
                  <path d="m2.5 3.5 1-1" transform="matrix(-1 0 0 1 6 0)" />
                  <path d="m13.5 13.5 1-1" transform="matrix(1 0 0 -1 0 26)" />
                  <path d="m2.5 13.5 1-1" transform="matrix(-1 0 0 -1 6 26)" />
                  <path d="m1.5 7.5h-1" />
                  <path d="m16.5 7.5h-1" />
                </g>
              </svg>
              <svg
                id="logoSVG-Off"
                height="45"
                viewBox="0 0 21 21"
                width="45"
                xmlns="http://www.w3.org/2000/svg"
                aria-labelledby="svgTitleX svgDescX"
              >
                <title id="svgTitleX">Change theme</title>
                <desc id="svgDescX">Select to switch to dark theme</desc>
                <g
                  fill="none"
                  fill-rule="evenodd"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  transform="translate(6 5)"
                >
                  <path d="m2.5 13.5h4" />
                  <path
                    d="m4.5 0c2.48528137 0 4.5 2.01471863 4.5 4.5 0 1.76637512-1.01772197 3.29504854-2.49877863 4.03163297l-.00122137.96836703c0 1.1045695-.8954305 2-2 2s-2-.8954305-2-2l-.00021218-.96786527c-1.48160351-.73639182-2.49978782-2.26535843-2.49978782-4.03213473 0-2.48528137 2.01471863-4.5 4.5-4.5z"
                  />
                </g>
              </svg>
            </button>
          </div>
          <span
            role="alert"
            class="hidden"
            aria-live="polite"
            id="lightDark"
          ></span>
          <div id="titleLink">Accessiblity Tools - BETA</div>
        </div>
      </header>
      <div id="main-navigation" class="page-nav">
        <nav aria-label="Main menu" class="topnav" id="myTopnav">
          <button
            id="menu"
            aria-controls="myTopnav"
            aria-labelledby="myTopnav"
            aria-expanded="false"
            class="icon"
            aria-haspopup="menu"
            onclick="menuAction()"
          >
            <span id="hamburger">
              <svg
                id="hamSVG"
                viewBox="0 0 100 80"
                width="20"
                height="20"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
                focusable="false"
                role="img"
              >
                <title id="hamSVGTitle">Menu</title>
                <desc id="hamSVGDesc">
                  Select to expand or collapse the menu
                </desc>
                <rect width="100" height="20"></rect>
                <rect y="30" width="100" height="20"></rect>
                <rect y="60" width="100" height="20"></rect>
              </svg>
            </span>
            <span id="arrow">
              <svg
                width="20"
                height="20"
                xmlns="http://www.w3.org/2000/svg"
                role="img"
                aria-hidden="true"
                focusable="false"
              >
                <title id="arrowSVGTitle">Menu</title>
                <desc id="arrowSVGDesc">
                  Select to expand or collapse the menu
                </desc>
                <g
                  stroke-width="4"
                  stroke-linejoin="round"
                  stroke-linecap="round"
                  stroke="currentColor"
                  fill-rule="evenodd"
                  fill="none"
                >
                  <path d="m7.499,6.497l-3.999,4.002l4,4.001" />
                  <path d="m16.5,10.5l-13,0" />
                </g>
              </svg>
            </span>
          </button>
          <a id="homeMenu" href="index.html">Home</a>
          <a href="presentations.html">Presentations</a>
          <a href="posts.html">Blog Posts</a>
          <a href="projects.html" aria-current="page" class="active"
            >Projects</a
          >
          <a href="about.html">About</a>
        </nav>
      </div>
      <main class="page-main" id="main">
        <!-- Toast notification system -->
        <div
          id="gb-toast-container"
          class="gb-toast-container"
          role="region"
          aria-live="polite"
          aria-label="Notifications"
        ></div>
        <fieldset id="toolSelection" class="">
          <legend>Tool in use</legend>
          <input
            type="radio"
            id="OpenRouter"
            name="presentation"
            value="OpenRouter"
            onclick="showOpenRouter()"
            checked=""
          />
          <label for="OpenRouter" class="radio">OpenRouter AI</label>
          <input
            type="radio"
            id="MarkdownEditorRadio"
            name="presentation"
            value="Markdown Editor"
            onclick="showMkdEd()"
          />
          <label for="MarkdownEditorRadio" class="radio">Markdown Editor</label>
          <input
            type="radio"
            id="GraphBuilder"
            name="presentation"
            value="Graph Builder"
            onclick="showGrhBld()"
          />
          <label for="GraphBuilder" class="radio">Graph Builder</label>
          <input
            type="radio"
            id="MathPix"
            name="presentation"
            value="MathPix"
            onclick="showMathPix()"
          />
          <label for="MathPix" class="radio">MathPix</label>
        </fieldset>
        <!--  Screen reader announcement area for radio button switching -->
        <span
          role="alert"
          class="sr-only"
          aria-live="polite"
          id="radioSRannounce"
        ></span>
        <div
          id="mathjax-status"
          style="
            display: none;
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px;
            background: #f44;
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
          "
        >
          MathJax loading issue - please refresh
        </div>
        <article class="standard" id="openrouter-app">
          <h1 id="top">OpenRouter Testing</h1>

          <div id="startHere">
            <div class="enhanced-model-selection-wrapper">
              <!-- Enhanced Model Selection -->
              <div class="model-selection">
                <label for="model-select"
                  ><strong>Select an AI Model:</strong></label
                >
                <select
                  name="model"
                  id="model-select"
                  class="enhanced-model-select"
                  aria-describedby="model-help"
                >
                  <option value="">Please select a model...</option>
                </select>
                <div id="model-help" class="sr-only">
                  Choose from the filtered list of AI models based on your
                  criteria
                </div>

                <!-- Keep existing model info display -->
                <div class="model-info" role="status" aria-live="polite">
                  <p>
                    Select a model to view detailed information about its
                    capabilities, pricing, and features.
                  </p>
                </div>
              </div>

              <!-- Advanced Filters Disclosure Widget -->
              <details
                class="model-filters-disclosure modelDetailsSummary"
                id="model-filters-disclosure"
              >
                <summary
                  class="filters-summary"
                  aria-describedby="filters-summary-desc"
                >
                  <span class="summary-text">Advanced Model Filters</span>
                  <span
                    class="filter-status"
                    id="filter-status"
                    aria-live="polite"
                  >
                    <!-- Will be populated with current filter info -->
                    <span class="models-count">Showing all models</span>
                    <span
                      class="active-filters"
                      id="active-filters-indicator"
                    ></span>
                  </span>
                </summary>

                <div id="filters-summary-desc" class="sr-only">
                  Expand to access advanced filtering options including search,
                  pricing, capabilities, and provider filters
                </div>

                <div
                  class="model-selection-controls"
                  role="group"
                  aria-labelledby="filters-content-heading"
                >
                  <div class="filters-grid">
                    <!-- Free Tier Filter -->
                    <fieldset class="filter-group">
                      <legend>Pricing Options</legend>
                      <div class="filter-option">
                        <label>
                          <input
                            type="checkbox"
                            id="filter-free-only"
                            aria-describedby="free-filter-desc"
                          />
                          <span>Show only free models</span>
                        </label>
                        <div id="free-filter-desc" class="sr-only">
                          Filter to display only models available in the free
                          tier
                        </div>
                      </div>
                      <div class="filter-option">
                        <label>
                          <input type="checkbox" id="filter-sort-by-cost" />
                          <span>Sort by cost (cheapest first)</span>
                        </label>
                      </div>
                    </fieldset>

                    <!-- Cost Range Filter -->
                    <fieldset class="filter-group">
                      <legend>Cost Range (per 1M tokens)</legend>
                      <div class="filter-option">
                        <label for="cost-range-select">Input cost range:</label>
                        <select
                          id="cost-range-select"
                          class="range-input"
                          aria-describedby="cost-range-desc"
                        >
                          <option value="">Any cost</option>
                          <option value="0-1">$0.01 - $1.00</option>
                          <option value="1-5">$1.00 - $5.00</option>
                          <option value="5-10">$5.00 - $10.00</option>
                          <option value="10-20">$10.00 - $20.00</option>
                          <option value="20-50">$20.00 - $50.00</option>
                          <option value="50+">$50.00+</option>
                        </select>
                        <div id="cost-range-desc" class="sr-only">
                          Filter models by their input token cost range
                        </div>
                      </div>
                    </fieldset>

                    <!-- Capabilities Filter -->
                    <fieldset class="filter-group">
                      <legend>Model Capabilities</legend>
                      <div class="filter-option">
                        <label>
                          <input
                            type="checkbox"
                            id="filter-vision"
                            value="vision"
                          />
                          <span>Vision/Image processing</span>
                        </label>
                      </div>
                      <div class="filter-option">
                        <label>
                          <input
                            type="checkbox"
                            id="filter-code"
                            value="code"
                          />
                          <span>Code generation</span>
                        </label>
                      </div>
                      <div class="filter-option">
                        <label>
                          <input
                            type="checkbox"
                            id="filter-reasoning"
                            value="reasoning"
                          />
                          <span>Advanced reasoning</span>
                        </label>
                      </div>
                      <div class="filter-option">
                        <label>
                          <input
                            type="checkbox"
                            id="filter-tools"
                            value="tools"
                          />
                          <span>Tool calling/Function calling</span>
                        </label>
                      </div>
                    </fieldset>

                    <!-- Provider Filter -->
                    <fieldset class="filter-group">
                      <legend>Model Provider</legend>
                      <div class="filter-option">
                        <label for="provider-select">Provider:</label>
                        <select
                          id="provider-select"
                          class="range-input"
                          aria-describedby="provider-desc"
                        >
                          <option value="">All providers</option>
                          <!-- Options will be populated dynamically -->
                        </select>
                        <div id="provider-desc" class="sr-only">
                          Filter models by their provider company
                        </div>
                      </div>
                    </fieldset>
                  </div>
                  <div class="search-container">
                    <label for="model-search" class="sr-only"
                      >Search models by name or provider</label
                    >
                    <input
                      type="text"
                      id="model-search"
                      class="search-input"
                      placeholder="Search models by name or provider..."
                      aria-describedby="search-help"
                    />
                    <div id="search-help" class="sr-only">
                      Type to filter models by name, provider, or description
                    </div>
                  </div>
                  <div class="controls-header">
                    <button
                      type="button"
                      class="reset-filters-btn"
                      id="reset-filters"
                      aria-describedby="reset-filters-desc"
                    >
                      Reset All Filters
                    </button>
                    <div id="reset-filters-desc" class="sr-only">
                      Clear all applied filters and show all available models
                    </div>
                  </div>
                  <!-- Model Count Display (inside disclosure) -->
                  <div
                    id="model-count"
                    class="model-count"
                    role="status"
                    aria-live="polite"
                  >
                    Loading models...
                  </div>
                </div>
              </details>
            </div>
            <!-- Input Controls -->
            <div
              class="input-controls"
              role="region"
              aria-label="Input Controls"
            >
              <div class="text-input">
                <label for="user-input"
                  ><strong>Enter your prompt:</strong></label
                >
                <textarea
                  id="user-input"
                  name="user-input"
                  rows="4"
                  placeholder="Type your message here..."
                  aria-describedby="input-help"
                ></textarea>
                <div id="input-help" class="help-text sr-only">
                  Enter text to process with the selected AI model
                </div>
              </div>

              <div class="file-handling">
                <!-- File Upload Section -->
                <div
                  class="file-upload-section"
                  role="region"
                  aria-label="File upload"
                >
                  <div class="file-upload-controls">
                    <input
                      type="file"
                      id="file-upload"
                      accept=".jpg,.jpeg,.png,.webp,.pdf"
                      aria-describedby="file-upload-help"
                      class="file-upload-input"
                    />
                    <label for="file-upload" class="file-upload-label">
                      <span class="file-upload-icon" aria-hidden="true"
                        >📎</span
                      >
                      <span class="file-upload-text"
                        >Choose file or drag here</span
                      >
                      <span class="file-upload-subtext"
                        >Images & PDFs supported</span
                      >
                    </label>
                    <div id="file-upload-help" class="help-text">
                      Supported: Images (JPG, PNG, WebP) up to 20MB, PDFs up to
                      512MB
                    </div>
                  </div>

                  <!-- File Preview Area (initially hidden) -->
                  <div class="file-preview" id="file-preview" hidden>
                    <div class="preview-header">
                      <div class="preview-info">
                        <span
                          class="preview-filename"
                          id="preview-filename"
                        ></span>
                        <span
                          class="preview-filesize"
                          id="preview-filesize"
                        ></span>
                      </div>
                      <button
                        class="preview-remove"
                        id="preview-remove"
                        aria-label="Remove file"
                        title="Remove file"
                      >
                        <svg
                          height="21"
                          viewBox="0 0 21 21"
                          width="21"
                          xmlns="http://www.w3.org/2000/svg"
                          aria-hidden="true"
                        >
                          <g
                            fill="none"
                            fill-rule="evenodd"
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            transform="translate(5 5)"
                          >
                            <path d="m10.5 10.5-10-10z" />
                            <path d="m10.5.5-10 10" />
                          </g>
                        </svg>
                      </button>
                    </div>

                    <div class="preview-content" id="preview-content">
                      <!-- Image preview or PDF info will be inserted here -->
                    </div>

                    <!-- Cost Estimation Display -->
                    <div
                      class="preview-cost-estimate"
                      id="preview-cost"
                      role="status"
                      aria-live="polite"
                    >
                      <!-- Cost information will be displayed here -->
                    </div>

                    <!-- Warning Messages -->
                    <div
                      class="response-size-warning"
                      id="response-warning"
                      role="alert"
                      hidden
                    >
                      <!-- Response size warnings will appear here -->
                    </div>
                  </div>
                </div>
              </div>
              <!-- Streaming Options -->
              <fieldset class="streaming-options">
                <legend>Response Streaming Options</legend>

                <div class="streaming-choices">
                  <label class="streaming-choice">
                    <input
                      type="radio"
                      name="streaming-mode"
                      value="none"
                      id="stream-none"
                      aria-describedby="stream-none-desc"
                    />
                    <span class="choice-label">No Streaming</span>
                    <span class="choice-description" id="stream-none-desc">
                      Wait for complete response before displaying formatted
                      content
                    </span>
                  </label>

                  <label class="streaming-choice" id="standard-streaming-label">
                    <input
                      type="radio"
                      name="streaming-mode"
                      value="standard"
                      id="stream-standard"
                      checked
                      aria-describedby="stream-standard-desc"
                    />
                    <span class="choice-label">Standard Streaming</span>
                    <span class="choice-description" id="stream-standard-desc">
                      Show response as plain text while generating, format when
                      complete
                    </span>
                    <span
                      class="reduced-motion-notice"
                      id="reduced-motion-notice"
                      style="display: none"
                    >
                      <br />
                      <em
                        >(Disabled: You have animations disabled in your system
                        settings)</em
                      >
                    </span>
                  </label>
                </div>
              </fieldset>
              <div class="processing-options">
                <!-- Processing Options begin -->
                <!-- Add this system prompt container before other parameters -->
                <div
                  class="system-prompt-container parameter-control"
                  role="region"
                  aria-labelledby="system-prompt-label"
                >
                  <div class="control-header">
                    <label id="system-prompt-label" for="system-prompt"
                      >System Instructions</label
                    >
                  </div>
                  <textarea
                    id="system-prompt"
                    name="system-prompt"
                    rows="3"
                    aria-describedby="system-prompt-description"
                    class="system-prompt-input"
                  ></textarea>
                  <div
                    id="system-prompt-description"
                    class="parameter-description"
                    aria-live="polite"
                  >
                    Provide context and instructions for how the AI should
                    behave.
                  </div>
                  <div class="preset-prompts">
                    <!-- Preset buttons will be dynamically added here -->
                  </div>
                </div>

                <!-- Existing parameter controls continue here -->
                <!-- Temperature Control Starts-->
                <div
                  class="parameter-control"
                  role="region"
                  aria-labelledby="temp-label"
                >
                  <div class="control-header">
                    <label id="temp-label" for="temperature"
                      >Response Creativity (Temperature)</label
                    >
                    <span class="current-value" aria-live="polite">
                      Current:
                      <output for="temperature" id="temp-output">0.8</output>
                    </span>
                  </div>

                  <div class="slider-container">
                    <input
                      type="range"
                      id="temperature"
                      min="0"
                      max="2"
                      step="0.1"
                      value="0.8"
                      aria-describedby="temp-description"
                    />
                    <div class="slider-labels">
                      <span>Focused (0.0)</span>
                      <span>Balanced (1.0)</span>
                      <span>Creative (2.0)</span>
                    </div>
                  </div>

                  <div id="temp-description" class="parameter-description">
                    Controls response creativity. Lower values give focused,
                    consistent responses. Higher values increase variety and
                    creativity.
                  </div>
                </div>
                <!-- Temperature Control Ends -->
                <!-- Top P Control Starts -->
                <div
                  class="parameter-control"
                  role="region"
                  aria-labelledby="topp-label"
                >
                  <div class="control-header">
                    <label id="topp-label" for="top-p"
                      >Response Diversity (Top P)</label
                    >
                    <span class="current-value" aria-live="polite">
                      Current: <output for="top-p" id="topp-output">1.0</output>
                    </span>
                  </div>

                  <div class="slider-container">
                    <input
                      type="range"
                      id="top-p"
                      min="0"
                      max="1"
                      step="0.05"
                      value="1"
                      aria-describedby="topp-description"
                    />
                    <div class="slider-labels">
                      <span>Focused (0.1)</span>
                      <span>Balanced (0.5)</span>
                      <span>Varied (1.0)</span>
                    </div>
                  </div>

                  <div id="topp-description" class="parameter-description">
                    Adjusts how varied the model's word choices can be.
                  </div>
                </div>
                <!-- Top P Control Ends -->
                <!-- Max Tokens Control Starts -->
                <div
                  class="parameter-control"
                  role="region"
                  aria-labelledby="max-tokens-label"
                >
                  <div class="control-header">
                    <label id="max-tokens-label" for="max-tokens-number"
                      >Maximum Response Length</label
                    >
                    <span class="current-value" aria-live="polite">
                      Current:
                      <output for="max-tokens-number" id="max-tokens-output"
                        >1024</output
                      >
                      tokens
                    </span>
                  </div>

                  <div class="tokens-input-group">
                    <!-- Numeric input for precise control -->
                    <div class="numeric-control">
                      <input
                        type="number"
                        id="max-tokens-number"
                        min="1"
                        aria-describedby="max-tokens-description max-tokens-limit"
                      />
                      <span id="max-tokens-limit" class="limit-indicator">
                        / <span class="available-tokens">4096</span> available
                      </span>
                    </div>

                    <!-- Preset buttons -->
                    <div
                      class="preset-button"
                      role="group"
                      aria-label="Quick length presets"
                    >
                      <button
                        class="tokenButton"
                        type="button"
                        data-preset="25"
                      >
                        25%
                      </button>
                      <button
                        class="tokenButton"
                        type="button"
                        data-preset="50"
                      >
                        50%
                      </button>
                      <button
                        class="tokenButton"
                        type="button"
                        data-preset="75"
                      >
                        75%
                      </button>
                    </div>
                  </div>

                  <!-- Slider for rough adjustments -->
                  <div class="slider-container">
                    <input
                      type="range"
                      id="max-tokens-slider"
                      min="1"
                      max="4096"
                      step="1"
                      value="1024"
                      aria-labelledby="max-tokens-label"
                      aria-describedby="max-tokens-description"
                    />
                    <div class="slider-labels">
                      <span>Short</span>
                      <span>Medium</span>
                      <span>Long</span>
                    </div>
                  </div>

                  <div
                    id="max-tokens-description"
                    class="parameter-description"
                  >
                    Controls maximum length of AI responses. Longer responses
                    cost more tokens.
                    <span class="cost-estimate"></span>
                  </div>
                </div>
                <!-- Max Tokens Control Ends -->
                <!-- Presence/Frequency Penalty Controls  Starts -->

                <div
                  class="parameter-control"
                  role="region"
                  aria-labelledby="repetition-label"
                >
                  <div class="control-header">
                    <label id="repetition-label"
                      >Response Variety (Repetition Control)</label
                    >
                    <span class="current-value" aria-live="polite">
                      Current:
                      <output id="repetition-output"
                        >Balanced (0.0, 0.0)</output
                      >
                    </span>
                  </div>

                  <div class="slider-container">
                    <div class="repetition-sliders">
                      <!-- Word Variety Slider -->
                      <div class="repetition-slider">
                        <label for="word-variety">Word Variety</label>
                        <input
                          type="range"
                          id="word-variety"
                          class="repetition-input"
                          min="-2"
                          max="2"
                          step="0.1"
                          value="0"
                          aria-describedby="repetition-description word-variety-label"
                        />
                        <div class="slider-labels">
                          <span>More Similar</span>
                          <span>Balanced</span>
                          <span>More Varied</span>
                        </div>
                        <div id="word-variety-label" class="slider-value">
                          Word variety: <output for="word-variety">0.0</output>
                        </div>
                      </div>

                      <!-- Phrase Variety Slider -->
                      <div class="repetition-slider">
                        <label for="phrase-variety">Phrase Variety</label>
                        <input
                          type="range"
                          id="phrase-variety"
                          class="repetition-input"
                          min="-2"
                          max="2"
                          step="0.1"
                          value="0"
                          aria-describedby="repetition-description phrase-variety-label"
                        />
                        <div class="slider-labels">
                          <span>More Similar</span>
                          <span>Balanced</span>
                          <span>More Varied</span>
                        </div>
                        <div id="phrase-variety-label" class="slider-value">
                          Phrase variety:
                          <output for="phrase-variety">0.0</output>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div
                    id="repetition-description"
                    class="parameter-description"
                  >
                    Controls how varied the AI's word and phrase choices will
                    be. Higher values create more diverse language, while lower
                    values allow more repetition. Values below 0 encourage
                    repetition, which can be useful for maintaining consistency.
                    <div class="parameter-status"></div>
                  </div>
                </div>

                <!-- Presence/Frequency Penalty Controls  Ends -->
                <!-- Processing Options Ends -->
              </div>
            </div>
            <!-- Tool Interface Container -->
            <div
              class="tool-interface"
              role="region"
              aria-label="Tool Interface"
            >
              <!-- Preview Area -->
              <div class="preview-area" role="region" aria-label="Preview area">
                <!-- Preview of files/content will render here -->
              </div>

              <!-- Action Controls -->
              <div class="action-controls">
                <button class="actionButton" id="process-btn" disabled>
                  Process with AI
                </button>
                <div class="processing-options">
                  <fieldset id="aiProcessingStatus" class="aiProcessing">
                    <legend>Status</legend>
                    <div id="statusAI" class="processing-status">
                      <!-- Updated status messages container -->
                      <div
                        class="status-messages"
                        role="log"
                        aria-label="Processing status history"
                        tabindex="0"
                        aria-atomic="false"
                        aria-live="polite"
                      >
                        <ul id="statusList" class="status-list"></ul>
                      </div>
                    </div>
                  </fieldset>
                  <!-- Status and Notification Container -->
                  <fieldset id="aiProcessingUpdates" class="aiProcessing">
                    <legend>Updates</legend>
                    <div class="status-feedback processing-status">
                      <!-- Retry Status Container -->
                      <div class="retry-status" style="display: none">
                        <strong>Retry status:</strong>
                        <span
                          id="retry-status"
                          role="status"
                          aria-live="polite"
                          class="retry-status"
                          style="display: none"
                        ></span>
                      </div>

                      <!-- Model Change Notification -->
                      <div
                        class="model-change-notification"
                        style="display: none"
                      >
                        <strong>Model change notification:</strong>
                        <span
                          id="model-change-notification"
                          role="alert"
                          class="model-change-notification"
                          style="display: none"
                        ></span>
                      </div>

                      <!-- Progress Indicator -->
                      <div
                        class="progress-container"
                        role="region"
                        aria-label="Request Progress"
                      >
                        <!-- Progress Steps -->
                        <div class="progress-steps" aria-hidden="true">
                          <div class="step" data-step="prepare">Preparing</div>
                          <div class="step" data-step="process">Processing</div>
                          <div class="step" data-step="complete">
                            Completing
                          </div>
                        </div>

                        <!-- Main Progress Bar -->
                        <div
                          id="progress-indicator"
                          class="progress-bar"
                          role="progressbar"
                          aria-valuemin="0"
                          aria-valuemax="100"
                          aria-valuenow="0"
                          aria-busy="false"
                        >
                          <div class="progress-fill"></div>
                        </div>

                        <!-- Status Text -->
                        <div
                          id="progress-status"
                          class="progress-status"
                          role="status"
                          aria-live="polite"
                        ></div>

                        <!-- Timing Information -->
                        <div class="timing-container" aria-live="polite">
                          <div class="stopwatch">
                            <span class="elapsed-time" id="elapsed-time"
                              >00:00.000</span
                            >
                            <span class="timing-status" id="timing-status"
                              >Ready</span
                            >
                          </div>
                          <div
                            class="timing-details"
                            id="timing-details"
                            role="status"
                            aria-label="Request timing details"
                            aria-live="polite"
                          ></div>
                        </div>
                      </div>

                      <!-- Status Container -->
                      <div
                        id="status-container"
                        role="status"
                        aria-live="polite"
                        class="status-container"
                      ></div>
                    </div>
                  </fieldset>
                </div>
              </div>
            </div>

            <!-- Results Container -->
            <div class="results-container">
              <h2 id="results-heading">Results</h2>
              <div class="results-content">
                <!-- Main results will appear here -->
              </div>
              <!-- Response size management controls -->
              <div
                class="response-management"
                id="response-management"
                hidden
                aria-live="polite"
              >
                <div class="response-size-alert" role="alert">
                  <span class="alert-icon" aria-hidden="true">⚠️</span>
                  <span class="alert-text">Large response detected</span>
                  <span class="response-size" id="response-size-value"></span>
                </div>

                <div
                  class="response-options"
                  role="group"
                  aria-label="Response display options"
                >
                  <button
                    type="button"
                    class="btn-secondary"
                    id="btn-show-summary"
                    aria-pressed="true"
                  >
                    Show Summary
                  </button>
                  <button
                    type="button"
                    class="btn-secondary"
                    id="btn-show-full"
                    aria-pressed="false"
                  >
                    Show Full Response
                  </button>
                  <button
                    type="button"
                    class="btn-secondary"
                    id="btn-download-response"
                  >
                    <span aria-hidden="true">💾</span> Download Response
                  </button>
                </div>

                <!-- Progressive disclosure area -->
                <div class="response-preview" id="response-preview" hidden>
                  <div class="preview-info" role="status">
                    <span id="preview-status"></span>
                  </div>
                </div>
              </div>
              <div class="download-options">
                <!-- Download buttons will appear here -->
              </div>
            </div>

            <!-- API Configuration -->
            <details class="openrouter-config" id="openrouter-api-config">
              <summary>OpenRouter API Configuration</summary>
              <form class="config-inputs" onsubmit="return false;">
                <label for="openrouter-api-key">API Key:</label>
                <div class="api-key-input-group">
                  <input
                    type="password"
                    id="openrouter-api-key"
                    placeholder="Enter OpenRouter API Key (sk-or-v1-...)"
                    autocomplete="off"
                    aria-describedby="api-key-help"
                  />
                  <button
                    type="button"
                    id="openrouter-toggle-visibility"
                    class="toggle-visibility-btn"
                    aria-label="Toggle API key visibility"
                    title="Show/hide API key"
                  >
                    <svg
                      height="40"
                      viewBox="0 0 21 21"
                      width="40"
                      xmlns="http://www.w3.org/2000/svg"
                      aria-hidden="true"
                    >
                      <g
                        fill="none"
                        fill-rule="evenodd"
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        transform="translate(2 5)"
                      >
                        <path
                          d="m8.5 11c3.1296136 0 5.9629469-1.83333333 8.5-5.5-2.5370531-3.66666667-5.3703864-5.5-8.5-5.5-3.12961358 0-5.96294692 1.83333333-8.5 5.5 2.53705308 3.66666667 5.37038642 5.5 8.5 5.5z"
                        />
                        <path
                          d="m8.5 2c.18463928 0 .36593924.01429736.54285316.04184538-.02850842.148891-.04285316.30184762-.04285316.45815462 0 1.38071187 1.1192881 2.5 2.5 2.5.156307 0 .3092636-.01434474.4576252-.04178957.0280774.17585033.0423748.35715029.0423748.54178957 0 1.93299662-1.5670034 3.5-3.5 3.5-1.93299662 0-3.5-1.56700338-3.5-3.5s1.56700338-3.5 3.5-3.5z"
                        />
                      </g>
                    </svg>
                    Show
                  </button>
                </div>
                <div id="api-key-help" class="config-help-text">
                  Your API key is stored locally in your browser and never
                  transmitted except to OpenRouter.
                </div>

                <div class="config-actions">
                  <button
                    id="openrouter-save-config"
                    type="button"
                    class="primary-button"
                  >
                    <svg
                      height="21"
                      viewBox="0 0 21 21"
                      width="21"
                      xmlns="http://www.w3.org/2000/svg"
                      aria-hidden="true"
                    >
                      <g
                        fill="none"
                        fill-rule="evenodd"
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        transform="translate(4 4)"
                      >
                        <path
                          d="m2.5.5h7l3 3v7c0 1.1045695-.8954305 2-2 2h-8c-1.1045695 0-2-.8954305-2-2v-8c0-1.1045695.8954305-2 2-2z"
                        />
                        <path
                          d="m4.50000081 8.5h4c.55228475 0 1 .44771525 1 1v3h-6v-3c0-.55228475.44771525-1 1-1z"
                        />
                        <path d="m3.5 3.5h2v2h-2z" />
                      </g>
                    </svg>
                    Save Configuration
                  </button>
                  <button
                    id="openrouter-clear-config"
                    type="button"
                    class="secondary-button"
                  >
                    <svg
                      height="21"
                      viewBox="0 0 21 21"
                      width="21"
                      xmlns="http://www.w3.org/2000/svg"
                      aria-hidden="true"
                    >
                      <g
                        fill="none"
                        fill-rule="evenodd"
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        transform="translate(3 2)"
                      >
                        <path
                          d="m2.5 2.5h10v12c0 1.1045695-.8954305 2-2 2h-6c-1.1045695 0-2-.8954305-2-2zm5-2c1.0543618 0 1.91816512.81587779 1.99451426 1.85073766l.00548574.14926234h-4c0-1.1045695.8954305-2 2-2z"
                        />
                        <path d="m.5 2.5h14" />
                        <path d="m5.5 5.5v8" />
                        <path d="m9.5 5.5v8" />
                      </g>
                    </svg>
                    Clear Stored Key
                  </button>
                </div>

                <div
                  id="openrouter-config-status"
                  role="status"
                  aria-live="polite"
                  class="config-status"
                ></div>
              </form>
            </details>

            <!-- Developer Panel -->
            <details open class="dev-panel" id="devPanel">
              <summary class="dev-panel">Developer Information</summary>
              <div class="api-stats">
                <dl>
                  <dt>API Credits Remaining:</dt>
                  <dd id="credits-remaining">...</dd>
                  <dt>Last Transaction Cost:</dt>
                  <dd id="last-cost" aria-hidden="true">...</dd>
                  <dt>Provider Information:</dt>
                  <dd id="provider-info" aria-hidden="true">...</dd>
                  <dt>Request Timing:</dt>
                  <dd id="request-timing" aria-hidden="true">...</dd>
                  <dt>Finish Reason:</dt>
                  <dd id="finish-reason" aria-hidden="true">...</dd>
                  <dt>Prompt Tokens:</dt>
                  <dd id="prompt-tokens" aria-hidden="true">...</dd>
                  <dt>Completion Tokens:</dt>
                  <dd id="completion-tokens" aria-hidden="true">...</dd>
                  <dt>Token Efficiency:</dt>
                  <dd id="token-efficiency" aria-hidden="true">...</dd>
                  <dt>Model Changes:</dt>
                  <dd id="model-changes" aria-hidden="true">None</dd>
                  <dt>Request:</dt>
                  <dt>
                    <pre><code id="original-request" class="language-json">...</code></pre>
                  </dt>
                  <dt>Response:</dt>
                  <dt>
                    <pre><code id="original-response" class="language-json">...</code></pre>
                  </dt>
                </dl>
              </div>
              <div
                id="dependency-report-container"
                class="dependency-report model-info"
              >
                <div class="dependency-header">
                  <h3>Dependency Analysis</h3>
                  <button
                    onclick="refreshDependencyAnalysis()"
                    class="refresh-button preset-buttons preset-button"
                    aria-label="Refresh dependency analysis"
                  >
                    ↻ Refresh
                  </button>
                </div>
                <div id="dependency-report" aria-live="polite"></div>
              </div>

              <!-- Debug Panel (initially hidden) -->
              <div
                id="response-debug-container"
                class="response-debug-container"
                style="display: none !important"
                aria-label="Response Debugging Panel"
              >
                <button
                  class="debug-toggle-button"
                  aria-expanded="false"
                  aria-controls="debug-content"
                  style="
                    display: none !important;
                    visibility: hidden !important;
                  "
                >
                  Toggle Debug View
                </button>
                <div
                  id="debug-content"
                  class="debug-content"
                  style="display: none"
                >
                  <div class="debug-panel raw-panel">
                    <div class="panel-header">
                      <h3>Raw Response</h3>
                      <button
                        id="download-raw"
                        class="download-button"
                        aria-label="Download raw response"
                      >
                        <span class="download-icon">⬇️</span> Download
                      </button>
                    </div>
                    <pre id="raw-response"></pre>
                  </div>
                  <div class="debug-panel formatted-panel">
                    <div class="panel-header">
                      <h3>Formatted Response</h3>
                      <button
                        id="download-formatted"
                        class="download-button"
                        aria-label="Download formatted response as HTML"
                      >
                        <span class="download-icon">⬇️</span> Download HTML
                      </button>
                    </div>
                    <div id="formatted-response"></div>
                  </div>
                  <div class="debug-panel semantic-panel">
                    <div class="panel-header">
                      <h3>Semantic Analysis</h3>
                      <button
                        id="download-semantic"
                        class="download-button"
                        aria-label="Download semantic analysis as JSON"
                      >
                        <span class="download-icon">⬇️</span> Download JSON
                      </button>
                    </div>
                    <pre id="semantic-analysis"></pre>
                  </div>
                </div>
              </div>
            </details>
          </div>
        </article>
        <article id="markdown-converter" class="standard">
          <h1>Markdown converter</h1>
          <details>
            <summary><h2>Instructions</h2></summary>
            <h3>Keyboard Shortcuts</h3>
            <ul class="keybMDshortcutsUL">
              <li class="keybMDshortcutsLI">
                <kbd>Ctrl</kbd> + <kbd>Enter</kbd> - Render markdown
              </li>
              <li class="keybMDshortcutsLI"><kbd>Esc</kbd> - Clear editor</li>
              <li class="keybMDshortcutsLI">
                <kbd>?</kbd> - Show/hide shortcuts
              </li>
            </ul>
            <span>These controls only work while the textbox is active.</span>
            <h3>Creating charts</h3>
            <p>Chart.js is supported.</p>
            <div class="codeWrapper">
              <pre><code class="language-json">
                ```chart
                {
                  "type": "line",
                  "data": {
                    "labels": ["January", "February", "March", "April", "May", "June", "July"],
                    "datasets": [{
                      "label": "Monthly Sales",
                      "data": [65, 59, 80, 81, 56, 55, 40],
                      "fill": false,
                      "tension": 0.1
                    }]
                  }
                }
                ```
          </code></pre>
            </div>
            <h4>Custom Chart Descriptions</h4>
            <p>
              You can provide your own custom descriptions for charts by adding
              a `descriptions` object within your chart configuration:
            </p>
            <div class="codeWrapper">
              <pre><code class="language-json">
"descriptions": {
    "short": "Your concise chart description here.",
    "detailed": "Your detailed HTML description here. You can use paragraphs, lists, and other HTML elements."
  }
          </code></pre>
              <h3>Creating charts</h3>
              <p>Chart.js is supported.</p>
              <div class="codeWrapper">
                <pre><code class="language-json">
                ```chart
                {
                  "type": "line",
                  "data": {
                    "labels": ["January", "February", "March", "April", "May", "June", "July"],
                    "datasets": [{
                      "label": "Monthly Sales",
                      "data": [65, 59, 80, 81, 56, 55, 40],
                      "fill": false,
                      "tension": 0.1
                    }]
                  }
                }
                ```
          </code></pre>
              </div>
            </div>
            <h3>Creating diagrams</h3>
            <p>Mermaid is supported.</p>
            <div class="codeWrapper">
              <pre><code class="language-markdown">
                ```mermaid
                graph TB
                    A[Start] --> B{Is it raining?}
                    B -->|Yes| C[Take umbrella]
                    B -->|No| D[Take sunglasses]
                    C --> E[Go out]
                    D --> E
                    E --> F[Return home]
                ```
          </code></pre>
            </div>
          </details>
          <div class="editor-section">
            <label for="markdown-input"
              >Enter Markdown text. LaTeX math, charts and mermaid
              supported:</label
            >
            <textarea
              id="markdown-input"
              aria-describedby="instructions editor-status"
              spellcheck="true"
              autocomplete="off"
              data-gramm="false"
            ></textarea>
            <p id="instructions" class="sr-only">
              Type or paste markdown content with LaTeX math expressions,
              charts, or code. Press Ctrl+Enter to render, Esc to clear. The
              content will be rendered as HTML below.
            </p>
            <div
              id="editor-status"
              class="status-message"
              role="status"
              aria-live="polite"
            ></div>
          </div>

          <div
            class="controls-section"
            role="toolbar"
            aria-label="Editor controls"
          >
            <button id="render-btn" type="button" aria-label="Render markdown">
              Render Markdown
            </button>
            <button id="clear-btn" type="button" aria-label="Clear editor">
              Clear
            </button>
            <button
              id="help-btn"
              type="button"
              aria-label="Show keyboard shortcuts"
            >
              Keyboard Shortcuts
            </button>
          </div>

          <div
            class="loading"
            id="loading-indicator"
            role="status"
            aria-label="Loading content"
          >
            <span class="sr-only">Loading...</span>
          </div>

          <section class="output-section">
            <h2>HTML Output:</h2>
            <div
              id="output"
              class="output"
              role="region"
              aria-live="polite"
              aria-atomic="true"
            ></div>
          </section>

          <div
            id="keyboard-shortcuts"
            class="keyboard-shortcuts"
            role="dialog"
            aria-label="Keyboard shortcuts"
          ></div>
        </article>

        <article id="graph-builder" class="standard">
          <h1>Graph Builder</h1>

          <div id="GraphBuilderContainer">
            <!-- Skip link for progress navigation -->
            <a
              href="#gb-data-input"
              class="gb-skip-progress-link sr-only-focusable"
              >Skip progress navigation</a
            >

            <!-- Progress indicator -->
            <nav aria-label="Chart creation progress" class="gb-progress">
              <ol class="gb-steps" aria-label="Chart creation steps">
                <li id="gb-step-1" class="gb-step active" aria-current="step">
                  <button
                    type="button"
                    class="gb-step-button"
                    data-target="data-input"
                    aria-describedby="gb-step-1-desc"
                  >
                    <span class="gb-step-number">1</span>
                    <span class="gb-step-label">Add Data</span>
                  </button>
                  <span id="gb-step-1-desc" class="sr-only"
                    >Step 1 of 4: Add your data</span
                  >
                </li>
                <li id="gb-step-2" class="gb-step">
                  <span
                    class="gb-step-non-interactive"
                    aria-describedby="gb-step-2-desc"
                  >
                    <span class="gb-step-number">2</span>
                    <span class="gb-step-label">Choose Chart</span>
                  </span>
                  <span id="gb-step-2-desc" class="sr-only"
                    >Step 2 of 4: Choose your chart type</span
                  >
                </li>
                <li id="gb-step-3" class="gb-step">
                  <span
                    class="gb-step-non-interactive"
                    aria-describedby="gb-step-3-desc"
                  >
                    <span class="gb-step-number">3</span>
                    <span class="gb-step-label">Configure</span>
                  </span>
                  <span id="gb-step-3-desc" class="sr-only"
                    >Step 3 of 4: Configure your chart</span
                  >
                </li>
                <li id="gb-step-4" class="gb-step">
                  <span
                    class="gb-step-non-interactive"
                    aria-describedby="gb-step-4-desc"
                  >
                    <span class="gb-step-number">4</span>
                    <span class="gb-step-label">Complete</span>
                  </span>
                  <span id="gb-step-4-desc" class="sr-only"
                    >Step 4 of 4: Your chart is complete</span
                  >
                </li>
              </ol>
            </nav>

            <!-- Screen 1: Data Input -->
            <section
              id="gb-data-input"
              class="gb-screen active"
              aria-labelledby="gb-data-heading"
            >
              <h2 id="gb-data-heading">Step 1: Add Your Data</h2>

              <!-- Data input method selection -->
              <fieldset class="gb-input-methods">
                <legend>How would you like to add your data?</legend>
                <div
                  class="gb-method-tabs"
                  role="tablist"
                  aria-label="Data input methods"
                >
                  <button
                    type="button"
                    id="gb-tab-form"
                    class="gb-tab-button active"
                    role="tab"
                    aria-controls="gb-form-panel"
                    aria-selected="true"
                  >
                    <span class="gb-tab-icon">✏️</span>
                    <span class="gb-tab-label">Enter Data</span>
                  </button>
                  <button
                    type="button"
                    id="gb-tab-paste"
                    class="gb-tab-button"
                    role="tab"
                    aria-controls="gb-paste-panel"
                    aria-selected="false"
                  >
                    <span class="gb-tab-icon">📋</span>
                    <span class="gb-tab-label">Paste CSV</span>
                  </button>
                  <button
                    type="button"
                    id="gb-tab-upload"
                    class="gb-tab-button"
                    role="tab"
                    aria-controls="gb-upload-panel"
                    aria-selected="false"
                  >
                    <span class="gb-tab-icon">📁</span>
                    <span class="gb-tab-label">Upload File</span>
                  </button>
                </div>
              </fieldset>

              <!-- Form-based data entry panel -->
              <div
                id="gb-form-panel"
                class="gb-input-panel active"
                role="tabpanel"
                aria-labelledby="gb-tab-form"
              >
                <h3>Enter your data row by row</h3>
                <form id="gb-data-form" class="gb-data-form">
                  <div class="gb-form-headers">
                    <label for="gb-column-1">Column 1 Name:</label>
                    <input
                      type="text"
                      id="gb-column-1"
                      name="column-1"
                      value="Category"
                      required
                      aria-describedby="gb-column-1-help"
                    />
                    <label for="gb-column-2">Column 2 Name:</label>
                    <input
                      type="text"
                      id="gb-column-2"
                      name="column-2"
                      value="Value"
                      required
                      aria-describedby="gb-column-2-help"
                    />
                  </div>

                  <div class="gb-help-text">
                    <p id="gb-column-1-help">
                      Name for your categories (e.g., Subject, Product, Region)
                    </p>
                    <p id="gb-column-2-help">
                      Name for your values (e.g., Score, Sales, Population)
                    </p>
                  </div>

                  <div id="gb-data-rows" class="gb-data-rows">
                    <!-- Data rows will be added here -->
                  </div>

                  <button
                    type="button"
                    id="gb-add-row"
                    class="gb-add-row-button"
                  >
                    + Add Row
                  </button>
                </form>
              </div>

              <!-- CSV paste panel -->
              <div
                id="gb-paste-panel"
                class="gb-input-panel"
                role="tabpanel"
                aria-labelledby="gb-tab-paste"
              >
                <h3>Paste your CSV data</h3>

                <div class="gb-paste-area">
                  <label for="gb-csv-input">Paste CSV data here:</label>
                  <textarea
                    id="gb-csv-input"
                    class="gb-csv-textarea"
                    rows="8"
                    placeholder="Paste your CSV data here..."
                    aria-describedby="gb-csv-help"
                  ></textarea>
                  <div id="gb-csv-help" class="gb-help-text">
                    <p>
                      Paste data with headers in the first row. Use commas to
                      separate values.
                    </p>
                    <p><strong>Example:</strong></p>
                    <pre class="gb-csv-example">
Category,Value
Mathematics,85
English,72
Science,91</pre
                    >
                  </div>
                </div>
              </div>

              <!-- File upload panel -->
              <div
                id="gb-upload-panel"
                class="gb-input-panel"
                role="tabpanel"
                aria-labelledby="gb-tab-upload"
              >
                <h3>Upload a CSV file</h3>
                <div class="gb-upload-area">
                  <label for="gb-file-input" class="gb-file-label">
                    <span class="gb-upload-icon">📁</span>
                    <span class="gb-upload-text"
                      >Click to select a CSV file</span
                    >
                    <input
                      type="file"
                      id="gb-file-input"
                      accept=".csv"
                      class="gb-file-input"
                    />
                  </label>
                  <p class="gb-help-text">
                    Select a CSV file from your computer or drag and drop one
                    into the box above. Maximum file size: 1MB.
                  </p>
                </div>
              </div>
              <!-- Data preview -->
              <div
                id="gb-data-preview"
                class="gb-data-preview"
                style="display: none"
              >
                <h3>Data Preview</h3>
                <div class="gb-preview-info">
                  <span id="gb-preview-stats" class="gb-preview-stats"></span>
                </div>
                <div class="gb-preview-table-container">
                  <table id="gb-preview-table" class="gb-preview-table">
                    <caption>
                      Preview of your data
                    </caption>
                    <thead id="gb-preview-thead"></thead>
                    <tbody id="gb-preview-tbody"></tbody>
                  </table>
                </div>
              </div>

              <!-- Navigation -->
              <div class="gb-navigation">
                <button
                  type="button"
                  id="gb-data-next"
                  class="gb-next-button"
                  disabled
                >
                  Next: Choose Chart Type
                </button>
              </div>
            </section>

            <!-- Screen 2: Chart Type Selection -->
            <section
              id="gb-chart-type"
              class="gb-screen"
              aria-labelledby="gb-chart-heading"
            >
              <h2 id="gb-chart-heading">Step 2: Choose Chart Type</h2>

              <div class="gb-chart-grid">
                <button
                  type="button"
                  class="gb-chart-option"
                  data-chart-type="bar"
                >
                  <div class="gb-chart-icon">
                    <svg viewBox="0 0 100 60" aria-hidden="true">
                      <rect
                        x="10"
                        y="40"
                        width="15"
                        height="15"
                        fill="currentColor"
                      />
                      <rect
                        x="30"
                        y="25"
                        width="15"
                        height="30"
                        fill="currentColor"
                      />
                      <rect
                        x="50"
                        y="35"
                        width="15"
                        height="20"
                        fill="currentColor"
                      />
                      <rect
                        x="70"
                        y="15"
                        width="15"
                        height="40"
                        fill="currentColor"
                      />
                    </svg>
                  </div>
                  <h3>Bar Chart</h3>
                  <p>Compare values across categories</p>
                </button>

                <button
                  type="button"
                  class="gb-chart-option"
                  data-chart-type="line"
                >
                  <div class="gb-chart-icon">
                    <svg viewBox="0 0 100 60" aria-hidden="true">
                      <polyline
                        points="10,45 30,30 50,35 70,20 90,25"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      />
                      <circle cx="10" cy="45" r="2" fill="currentColor" />
                      <circle cx="30" cy="30" r="2" fill="currentColor" />
                      <circle cx="50" cy="35" r="2" fill="currentColor" />
                      <circle cx="70" cy="20" r="2" fill="currentColor" />
                      <circle cx="90" cy="25" r="2" fill="currentColor" />
                    </svg>
                  </div>
                  <h3>Line Chart</h3>
                  <p>Show trends over time</p>
                </button>

                <button
                  type="button"
                  class="gb-chart-option"
                  data-chart-type="pie"
                >
                  <div class="gb-chart-icon">
                    <svg viewBox="0 0 100 60" aria-hidden="true">
                      <circle
                        cx="50"
                        cy="30"
                        r="20"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      />
                      <path
                        d="M 50,30 L 50,10 A 20,20 0 0,1 65,20 Z"
                        fill="currentColor"
                        opacity="0.7"
                      />
                      <path
                        d="M 50,30 L 65,20 A 20,20 0 0,1 60,45 Z"
                        fill="currentColor"
                        opacity="0.5"
                      />
                      <path
                        d="M 50,30 L 60,45 A 20,20 0 1,1 50,10 Z"
                        fill="currentColor"
                        opacity="0.3"
                      />
                    </svg>
                  </div>
                  <h3>Pie Chart</h3>
                  <p>Show parts of a whole</p>
                </button>

                <button
                  type="button"
                  class="gb-chart-option"
                  data-chart-type="doughnut"
                >
                  <div class="gb-chart-icon">
                    <svg viewBox="0 0 100 60" aria-hidden="true">
                      <circle
                        cx="50"
                        cy="30"
                        r="20"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      />
                      <circle
                        cx="50"
                        cy="30"
                        r="10"
                        fill="#fffff4"
                        stroke="currentColor"
                        stroke-width="2"
                      />
                      <path
                        d="M 50,30 L 50,10 A 20,20 0 0,1 65,20 Z"
                        fill="currentColor"
                        opacity="0.7"
                      />
                      <path
                        d="M 50,30 L 65,20 A 20,20 0 0,1 60,45 Z"
                        fill="currentColor"
                        opacity="0.5"
                      />
                    </svg>
                  </div>
                  <h3>Doughnut Chart</h3>
                  <p>Pie chart with center space</p>
                </button>

                <button
                  type="button"
                  class="gb-chart-option"
                  data-chart-type="scatter"
                >
                  <div class="gb-chart-icon">
                    <svg viewBox="0 0 100 60" aria-hidden="true">
                      <circle cx="20" cy="40" r="2" fill="currentColor" />
                      <circle cx="35" cy="25" r="2" fill="currentColor" />
                      <circle cx="45" cy="35" r="2" fill="currentColor" />
                      <circle cx="60" cy="20" r="2" fill="currentColor" />
                      <circle cx="75" cy="30" r="2" fill="currentColor" />
                      <circle cx="85" cy="15" r="2" fill="currentColor" />
                    </svg>
                  </div>
                  <h3>Scatter Plot</h3>
                  <p>Show relationships between variables</p>
                </button>

                <button
                  type="button"
                  class="gb-chart-option"
                  data-chart-type="bubble"
                >
                  <div class="gb-chart-icon">
                    <svg viewBox="0 0 100 60" aria-hidden="true">
                      <circle
                        cx="25"
                        cy="35"
                        r="4"
                        fill="currentColor"
                        opacity="0.7"
                      />
                      <circle
                        cx="45"
                        cy="25"
                        r="6"
                        fill="currentColor"
                        opacity="0.7"
                      />
                      <circle
                        cx="65"
                        cy="40"
                        r="3"
                        fill="currentColor"
                        opacity="0.7"
                      />
                      <circle
                        cx="80"
                        cy="20"
                        r="5"
                        fill="currentColor"
                        opacity="0.7"
                      />
                    </svg>
                  </div>
                  <h3>Bubble Chart</h3>
                  <p>Three-dimensional data visualization</p>
                </button>

                <button
                  type="button"
                  class="gb-chart-option"
                  data-chart-type="radar"
                >
                  <div class="gb-chart-icon">
                    <svg viewBox="0 0 100 60" aria-hidden="true">
                      <polygon
                        points="50,15 65,25 60,40 40,40 35,25"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      />
                      <polygon
                        points="50,20 60,27 57,37 43,37 40,27"
                        fill="currentColor"
                        opacity="0.3"
                      />
                    </svg>
                  </div>
                  <h3>Radar Chart</h3>
                  <p>Compare multiple variables</p>
                </button>

                <button
                  type="button"
                  class="gb-chart-option"
                  data-chart-type="polarArea"
                >
                  <div class="gb-chart-icon">
                    <svg viewBox="0 0 100 60" aria-hidden="true">
                      <path
                        d="M 50,30 L 50,10 A 20,20 0 0,1 65,20 Z"
                        fill="currentColor"
                        opacity="0.7"
                      />
                      <path
                        d="M 50,30 L 65,20 A 20,20 0 0,1 70,30 Z"
                        fill="currentColor"
                        opacity="0.5"
                      />
                      <path
                        d="M 50,30 L 70,30 A 20,20 0 0,1 50,50 Z"
                        fill="currentColor"
                        opacity="0.3"
                      />
                      <path
                        d="M 50,30 L 50,50 A 20,20 0 0,1 30,30 Z"
                        fill="currentColor"
                        opacity="0.6"
                      />
                    </svg>
                  </div>
                  <h3>Polar Area Chart</h3>
                  <p>Circular area visualization</p>
                </button>
              </div>

              <!-- Navigation -->
              <div class="gb-navigation">
                <button type="button" id="gb-chart-back" class="gb-back-button">
                  <span aria-hidden="true">← </span>Back to Data
                </button>
                <button
                  type="button"
                  id="gb-chart-next"
                  class="gb-next-button"
                  disabled
                >
                  Next: Configure Chart
                </button>
              </div>
            </section>

            <!-- Screen 3: Chart Configuration -->
            <section
              id="gb-configure"
              class="gb-screen"
              aria-labelledby="gb-config-heading"
            >
              <h2 id="gb-config-heading">Step 3: Configure Your Chart</h2>

              <div class="gb-config-layout">
                <!-- Live preview -->
                <div class="gb-config-preview">
                  <h3>Live Preview</h3>
                  <div id="gb-chart-preview" class="gb-chart-preview-container">
                    <!-- Chart preview will be rendered here -->
                  </div>
                </div>

                <!-- Configuration form -->
                <div class="gb-config-form">
                  <h3>Chart Settings</h3>

                  <div class="gb-config-group">
                    <label for="gb-chart-title">Chart Title:</label>
                    <input
                      type="text"
                      id="gb-chart-title"
                      name="chart-title"
                      placeholder="Enter chart title"
                    />
                  </div>

                  <div class="gb-config-group">
                    <label for="gb-x-axis-title">X-Axis Label:</label>
                    <input
                      type="text"
                      id="gb-x-axis-title"
                      name="x-axis-title"
                      placeholder="X-axis label"
                    />
                  </div>

                  <div class="gb-config-group">
                    <label for="gb-y-axis-title">Y-Axis Label:</label>
                    <input
                      type="text"
                      id="gb-y-axis-title"
                      name="y-axis-title"
                      placeholder="Y-axis label"
                    />
                  </div>

                  <div class="gb-config-group">
                    <label>
                      <input
                        type="checkbox"
                        id="gb-show-legend"
                        name="show-legend"
                        checked
                      />
                      Show Legend
                    </label>
                  </div>
                  <div class="gb-config-group">
                    <label>
                      <input
                        type="checkbox"
                        id="gb-show-grid"
                        name="show-grid"
                        checked
                      />
                      Show Grid Lines
                    </label>
                  </div>
                </div>
              </div>

              <!-- Navigation -->
              <div class="gb-navigation">
                <button
                  type="button"
                  id="gb-config-back"
                  class="gb-back-button"
                >
                  ← Back to Chart Type
                </button>
                <button
                  type="button"
                  id="gb-config-create"
                  class="gb-create-button"
                >
                  Create Chart
                </button>
              </div>
            </section>

            <!-- Screen 4: Result -->
            <section
              id="gb-result"
              class="gb-screen"
              aria-labelledby="gb-result-heading"
            >
              <h2 id="gb-result-heading">✓ Your Chart is Ready!</h2>

              <div class="gb-result-info">
                <p>
                  Your accessible chart has been created with all the features
                  you need.
                </p>
              </div>

              <!-- Generated chart container -->
              <div id="gb-final-chart" class="gb-final-chart-container">
                <!-- Final chart with all accessibility features will be rendered here -->
              </div>

              <!-- Navigation -->
              <div class="gb-navigation">
                <button
                  type="button"
                  id="gb-result-back"
                  class="gb-back-button"
                >
                  ← Back to Configure
                </button>
              </div>

              <!-- Result actions -->
              <div class="gb-result-actions">
                <button
                  type="button"
                  id="gb-use-in-document"
                  class="gb-action-button"
                >
                  📄 Use in Document
                </button>
                <button
                  type="button"
                  id="gb-save-template"
                  class="gb-action-button"
                >
                  💾 Save as Template
                </button>
                <button
                  type="button"
                  id="gb-create-another"
                  class="gb-action-button"
                >
                  🔄 Create Another Chart
                </button>
              </div>
            </section>
          </div>
        </article>

        <article class="standard" id="mathpix-app" style="display: none">
          <h1>MathPix Mathematics OCR</h1>

          <fieldset class="mathpix-mode-switcher">
            <legend>Input Method</legend>
            <div class="mathpix-mode-options">
              <label class="mathpix-mode-option">
                <input
                  type="radio"
                  name="mathpix-input-mode"
                  value="upload"
                  id="mathpix-upload-mode-radio"
                  checked
                />

                <svg
                  height="21"
                  class="mode-icon"
                  aria-hidden="true"
                  viewBox="0 0 21 21"
                  width="21"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g
                    fill="none"
                    fill-rule="evenodd"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    transform="translate(3 3)"
                  >
                    <path d="m11.5 4.5-3.978-4-4.022 4" />
                    <path d="m7.522.521v11.979" />
                    <path
                      d="m.5 9v4.5c0 1.1045695.8954305 2 2 2h10c1.1045695 0 2-.8954305 2-2v-4.5"
                    />
                  </g>
                </svg>
                <span class="mode-label">Upload File</span>
              </label>

              <label class="mathpix-mode-option">
                <input
                  type="radio"
                  name="mathpix-input-mode"
                  value="draw"
                  id="mathpix-draw-mode-radio"
                />
                <svg
                  class="mode-icon"
                  aria-hidden="true"
                  height="21"
                  viewBox="0 0 21 21"
                  width="21"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g
                    fill="none"
                    fill-rule="evenodd"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    transform="translate(3 3)"
                  >
                    <path
                      d="m14 1c.8284271.82842712.8284271 2.17157288 0 3l-9.5 9.5-4 1 1-3.9436508 9.5038371-9.55252193c.7829896-.78700064 2.0312313-.82943964 2.864366-.12506788z"
                    />
                    <path d="m6.5 14.5h8" />
                    <path d="m12.5 3.5 1 1" />
                  </g>
                </svg>
                <span class="mode-label">Draw Mathematics</span>
              </label>
            </div>
          </fieldset>

          <!-- Upload Container (wraps existing upload zone) -->
          <div id="mathpix-upload-container" class="mathpix-upload-container">
            <h2>Upload Mathematics</h2>
            <div
              id="mathpix-drop-zone"
              class="drop-zone file-upload-section"
              role="button"
              tabindex="0"
              aria-describedby="upload-instructions paste-instructions"
            >
              <p id="upload-instructions">
                <svg
                  aria-hidden="true"
                  height="40"
                  width="40"
                  viewBox="0 0 21 21"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g
                    fill="none"
                    fill-rule="evenodd"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    transform="translate(2 4)"
                  >
                    <path
                      d="m15.5 4.5c.000802-1.10737712-.8946285-2.00280762-1.999198-2.00280762l-5.000802.00280762-2-2h-4c-.55228475 0-1 .44771525-1 1v.99719238 2.00280762"
                    />
                    <path
                      d="m.81056316 5.74177845 1.31072322 5.24326075c.22257179.8903496 1.02254541 1.5149608 1.94029301 1.5149608h8.87667761c.9177969 0 1.7178001-.6246768 1.9403251-1.5150889l1.3108108-5.24508337c.1339045-.53580596-.1919011-1.07871356-.727707-1.21261805-.079341-.0198283-.1608148-.02983749-.2425959-.02983749l-13.43852073.00188666c-.55228474.00007754-.99985959.44785564-.99985959 1.00014038 0 .08170931.01003737.16310922.02985348.24237922z"
                    />
                  </g>
                </svg>
                Drop image or PDF here, or click to select.
                <br />
                <span class="help-text"
                  >Supports: JPEG, PNG, WebP, PDF (max 10MB)</span
                >
              </p>

              <input
                type="file"
                id="mathpix-file-input"
                accept="image/jpeg,image/png,image/webp,application/pdf"
                style="display: none"
                aria-label="Select mathematics file to upload"
              />
            </div>

            <!-- Paste Instructions -->
            <p
              id="paste-instructions"
              class="help-text"
              style="margin-top: 0.75rem; text-align: center"
            >
              <svg
                aria-hidden="true"
                height="16"
                width="16"
                viewBox="0 0 21 21"
                xmlns="http://www.w3.org/2000/svg"
                style="vertical-align: middle; margin-right: 0.25rem"
              >
                <g
                  fill="none"
                  fill-rule="evenodd"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  transform="translate(4 3)"
                >
                  <path
                    d="m3.5 1.5c-.44119105-.00021714-1.03893772-.0044496-1.99754087-.00501204-.51283429-.00116132-.93645365.3838383-.99544161.88103343l-.00701752.11906336v10.99753785c.00061498.5520447.44795562.9996604 1 1.0006148l10 .0061982c.5128356.0008356.9357441-.3849039.993815-.882204l.006185-.1172316v-11c0-.55228475-.4477152-1-1-1-.8704853-.00042798-1.56475733.00021399-2 0"
                  />
                  <path
                    d="m4.5.5h4c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-4c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1z"
                  />
                  <path d="m2.5 5.5h5" />
                  <path d="m2.5 7.5h7" />
                  <path d="m2.5 9.5h3" />
                  <path d="m2.5 11.5h6" />
                </g>
              </svg>
              <strong>Quick tip:</strong> You can paste images directly from
              your clipboard (Ctrl+V or Cmd+V)
            </p>
          </div>
          <!-- End Upload Container -->

          <!-- Phase 1C: Draw Container (Canvas Drawing Interface) -->
          <div
            id="mathpix-draw-container"
            class="mathpix-draw-container"
            style="display: none"
          >
            <h2 class="sr-only">Draw Mathematics</h2>

            <div class="mathpix-canvas-wrapper">
              <p class="mathpix-canvas-instructions">
                <svg
                  height="21"
                  viewBox="0 0 21 21"
                  width="21"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                >
                  <g
                    fill="none"
                    fill-rule="evenodd"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    transform="translate(3 3)"
                  >
                    <path
                      d="m14 1c.8284271.82842712.8284271 2.17157288 0 3l-9.5 9.5-4 1 1-3.9436508 9.5038371-9.55252193c.7829896-.78700064 2.0312313-.82943964 2.864366-.12506788z"
                    />
                    <path d="m6.5 14.5h8" />
                    <path d="m12.5 3.5 1 1" />
                  </g>
                </svg>
                Draw your mathematical expression using your mouse or touch
                input. The system will recognise handwritten mathematics.
              </p>

              <fieldset class="mathpix-canvas-size-controls">
                <legend class="sr-only">Canvas Size</legend>
                <div class="size-button-group">
                  <button
                    type="button"
                    class="mathpix-size-btn"
                    data-size="small"
                    aria-pressed="false"
                  >
                    <span aria-hidden="true">📐</span> Small (400×200)
                  </button>
                  <button
                    type="button"
                    class="mathpix-size-btn"
                    data-size="medium"
                    aria-pressed="false"
                  >
                    <span aria-hidden="true">📐</span> Medium (600×300)
                  </button>
                  <button
                    type="button"
                    class="mathpix-size-btn active"
                    data-size="large"
                    aria-pressed="true"
                  >
                    <span aria-hidden="true">📐</span> Large (800×400)
                  </button>
                  <button
                    type="button"
                    class="mathpix-size-btn"
                    data-size="xlarge"
                    aria-pressed="false"
                  >
                    <span aria-hidden="true">📐</span> Extra Large (1000×500)
                  </button>

                  <button
                    type="button"
                    id="mathpix-custom-size-btn"
                    class="mathpix-size-btn mathpix-custom-btn"
                    aria-label="Set custom canvas size"
                  >
                    <span aria-hidden="true">⚙️</span> Custom Size...
                  </button>
                </div>
              </fieldset>

              <div class="mathpix-canvas-container">
                <canvas
                  id="mathpix-draw-canvas"
                  class="mathpix-draw-canvas"
                  width="800"
                  height="400"
                >
                  Your browser does not support the canvas element...
                </canvas>
              </div>

              <div class="mathpix-canvas-controls">
                <button
                  type="button"
                  id="mathpix-clear-canvas-btn"
                  class="mathpix-canvas-btn mathpix-clear-btn"
                  aria-label="Clear all strokes from canvas"
                  disabled
                >
                  <svg
                    height="21"
                    aria-hidden="true"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(5 5)"
                    >
                      <path d="m10.5 10.5-10-10z" />
                      <path d="m10.5.5-10 10" />
                    </g>
                  </svg>
                  Clear Canvas
                </button>

                <button
                  type="button"
                  id="mathpix-undo-stroke-btn"
                  class="mathpix-canvas-btn mathpix-undo-btn"
                  aria-label="Undo last stroke"
                  disabled
                >
                  <svg
                    height="21"
                    viewBox="0 0 21 21"
                    aria-hidden="true"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(2 7)"
                    >
                      <path
                        d="m.5 6.5c3.33333333-4 6.33333333-6 9-6 2.6666667 0 5 1 7 3"
                      />
                      <path d="m.5 1.5v5h5" />
                    </g>
                  </svg>
                  Undo
                </button>

                <button
                  type="button"
                  id="mathpix-submit-strokes-btn"
                  class="mathpix-canvas-btn mathpix-submit-btn"
                  aria-label="Process handwritten mathematics"
                  disabled
                >
                  <svg
                    height="21"
                    viewBox="0 0 21 21"
                    aria-hidden="true"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(2 2)"
                    >
                      <path
                        d="m11.5779891 4.55941656c1.1699828.91516665 1.9220109 2.34005226 1.9220109 3.94058344 0 .48543539-.0691781.95471338-.1982137 1.39851335.3339576-.25026476.748773-.39851335 1.1982137-.39851335 1.1045695 0 2 .8954305 2 2s-.8954305 2-2 2c-1.104407 0-10.16182706 0-11 0-1.65685425 0-3-1.3431458-3-3 0-1.65685425 1.34314575-3 3-3 .03335948 0 .06659179.00054449.09968852.00162508.242805-1.19819586.9140534-2.24091357 1.84691265-2.96132058"
                      />
                      <path d="m6.5 2.5 2-2 2 2" />
                      <path d="m8.5.5v9" />
                    </g>
                  </svg>
                  Process Drawing
                </button>
              </div>

              <p class="mathpix-canvas-help help-text">
                <strong>Alternative:</strong> Drawing is only supported using
                stylus / mouse / touchpad / touch or other pointing devices. For
                other modes of input, please use the Upload mode to process
                images instead.
              </p>
            </div>
          </div>
          <!-- End Draw Container -->

          <!-- Upload Verification Preview (NEW - Phase 3.4) -->
          <div
            id="mathpix-upload-preview"
            class="mathpix-upload-preview"
            role="region"
            aria-label="PDF upload verification preview"
            hidden
          >
            <h3>Verify Your Upload</h3>

            <!-- PDF First Page Preview -->
            <div
              class="upload-preview-display"
              tabindex="0"
              role="region"
              aria-label="Scrollable PDF preview"
            >
              <canvas
                id="upload-preview-canvas"
                role="img"
                aria-label="Preview of first page of uploaded PDF"
              ></canvas>
            </div>

            <!-- File Information -->
            <dl class="upload-preview-info">
              <dt>Filename:</dt>
              <dd id="upload-preview-filename"></dd>

              <dt>Pages detected:</dt>
              <dd id="upload-preview-pages"></dd>

              <dt>File size:</dt>
              <dd id="upload-preview-size"></dd>
            </dl>

            <!-- Verification Actions -->
            <div class="upload-preview-actions">
              <button id="upload-preview-confirm" class="primary-button">
                <span aria-hidden="true">✓</span> Yes, this is the PDF!
              </button>
              <button id="upload-preview-cancel" class="secondary-button">
                <span aria-hidden="true">✗</span> No, I want to pick a different
                PDF.
              </button>
            </div>
          </div>

          <!-- Phase 3 MVP: Responsive Image Preview Container -->
          <div
            id="mathpix-image-preview-container"
            class="mathpix-image-preview-container"
            style="display: none"
            role="region"
            aria-label="Mathematics image preview"
          >
            <img
              id="mathpix-image-preview"
              class="mathpix-image-preview"
              alt="Preview of uploaded mathematics"
              style="display: none"
            />
            <div id="mathpix-file-info" class="mathpix-file-info">
              <!-- File information will be populated by JavaScript -->
            </div>

            <!-- Phase 2: User-configurable processing options (Text API only) -->
            <fieldset
              id="mathpix-processing-options"
              class="mathpix-processing-options"
              style="display: none"
            >
              <legend>
                <span aria-hidden="true">⚙️</span> Processing Options
              </legend>

              <!-- Equation Numbering Option -->
              <label class="mathpix-option-label">
                <input
                  type="checkbox"
                  id="mathpix-equation-numbering"
                  class="mathpix-option-checkbox"
                  checked
                  aria-describedby="mathpix-equation-numbering-desc"
                />
                <span class="mathpix-option-text"
                  >Include equation numbering</span
                >
              </label>
              <p
                id="mathpix-equation-numbering-desc"
                class="mathpix-option-description"
              >
                Adds equation tags like <code>\tag{1.2}</code> to numbered
                equations
              </p>

              <!-- Delimiter Format Selection -->
              <fieldset class="mathpix-delimiter-format">
                <legend class="mathpix-option-text">
                  Maths delimiter format
                </legend>

                <label class="mathpix-option-label mathpix-radio-label">
                  <input
                    type="radio"
                    name="mathpix-delimiters"
                    value="latex"
                    class="mathpix-option-radio"
                    checked
                    aria-describedby="mathpix-latex-delim-desc"
                  />
                  <span class="mathpix-option-text"> LaTeX format </span>
                </label>

                <label class="mathpix-option-label mathpix-radio-label">
                  <input
                    type="radio"
                    name="mathpix-delimiters"
                    value="markdown"
                    class="mathpix-option-radio"
                    aria-describedby="mathpix-markdown-delim-desc"
                  />
                  <span class="mathpix-option-text"> Markdown format </span>
                </label>

                <p
                  id="mathpix-latex-delim-desc"
                  class="mathpix-option-description visually-hidden"
                >
                  Standard LaTeX delimiters compatible with LaTeX documents
                </p>
                <p
                  id="mathpix-markdown-delim-desc"
                  class="mathpix-option-description visually-hidden"
                >
                  Markdown-compatible delimiters for Obsidian, Notion, and other
                  Markdown editors
                </p>
              </fieldset>

              <!-- Page Info Option -->
              <label class="mathpix-option-label">
                <input
                  type="checkbox"
                  id="mathpix-page-info"
                  class="mathpix-option-checkbox"
                  aria-describedby="mathpix-page-info-desc"
                />
                <span class="mathpix-option-text"
                  >Include page headers and numbers</span
                >
              </label>
              <p id="mathpix-page-info-desc" class="mathpix-option-description">
                Keeps page numbers, headers, and footers from source images
              </p>
            </fieldset>

            <div class="mathpix-preview-actions">
              <button
                id="mathpix-open-original-btn"
                class="mathpix-open-original-btn"
                aria-hidden="true"
                type="button"
                aria-label="Open original file in new window"
                style="display: none"
              >
                <svg
                  height="21"
                  viewBox="0 0 21 21"
                  width="21"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g
                    fill="none"
                    fill-rule="evenodd"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="8.5" cy="8.5" r="5" />
                    <path d="m17.571 17.5-5.571-5.5" />
                  </g>
                </svg>
                Open Original in New Window
              </button>
            </div>
            <div class="mathpix-preview-actions">
              <button
                id="mathpix-open-original-btn"
                class="mathpix-open-original-btn"
                aria-hidden="true"
                type="button"
                aria-label="Open original file in new window"
                style="display: none"
              >
                <svg
                  height="21"
                  viewBox="0 0 21 21"
                  width="21"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g
                    fill="none"
                    fill-rule="evenodd"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="8.5" cy="8.5" r="5" />
                    <path d="m17.571 17.5-5.571-5.5" />
                  </g>
                </svg>
                Open Original in New Window
              </button>
            </div>
          </div>

          <!-- Phase 3 MVP: Visual Progress Container (Stage 2) -->
          <div
            id="mathpix-progress-container"
            class="mathpix-progress-container"
            style="display: none"
            role="region"
            aria-label="Processing progress"
          >
            <div
              class="mathpix-progress-bar"
              role="progressbar"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-valuenow="0"
            >
              <div
                id="mathpix-progress-fill"
                class="mathpix-progress-fill"
              ></div>
            </div>
            <div id="mathpix-progress-label" class="mathpix-progress-label">
              Ready to process
            </div>
          </div>

          <!-- Phase 3 MVP: Responsive Comparison Container (Stage 3) -->
          <div
            id="mathpix-comparison-container"
            class="mathpix-comparison-container"
            style="display: none"
            role="region"
            aria-label="Original vs processed comparison"
          >
            <div class="mathpix-comparison-panel">
              <h3 class="mathpix-comparison-title">Original Mathematics</h3>
              <img
                id="mathpix-original-image"
                class="mathpix-original-image"
                alt="Original uploaded mathematics"
                style="display: none"
              />
              <div id="mathpix-original-info" class="mathpix-file-info">
                <!-- Original file information -->
              </div>
            </div>
            <div class="mathpix-comparison-panel">
              <div
                style="
                  justify-content: space-between;
                  align-items: center;
                  margin: 1.25rem 1.25rem 0.75rem 1.25rem;
                "
              >
                <h3
                  class="mathpix-comparison-title"
                  style="
                    font-weight: 600;
                    font-size: 1.1rem;
                    margin: 0;
                    padding-bottom: 0.5rem;
                    text-align: center;
                    flex: 1;
                  "
                >
                  Approximate Processed Output
                </h3>
                <button
                  id="mathpix-fullscreen-btn"
                  class="mathpix-zoom-button"
                  aria-label="View full screen"
                  title="View full screen"
                >
                  <svg
                    height="21"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(2 2)"
                    >
                      <path d="m16.5 5.5v-4.978l-5.5.014" />
                      <path d="m16.5.522-6 5.907" />
                      <path d="m11 16.521 5.5.002-.013-5.5" />
                      <path d="m16.5 16.429-6-5.907" />
                      <path d="m.5 5.5v-5h5.5" />
                      <path d="m6.5 6.429-6-5.907" />
                      <path d="m6 16.516-5.5.007v-5.023" />
                      <path d="m6.5 10.5-6 6" />
                    </g>
                  </svg>
                  Full Screen
                </button>
              </div>
              <div id="mathpix-rendered-output" class="mathpix-rendered-output">
                <!-- MathJax rendered output will appear here -->
              </div>
              <div class="mathpix-confidence-indicator">
                <span>Confidence:</span>
                <span
                  id="mathpix-confidence-badge"
                  class="mathpix-confidence-badge mathpix-confidence-high"
                >
                  <!-- Confidence percentage will be populated -->
                </span>
              </div>
            </div>
          </div>

          <!-- Output Area with Multi-Format Support -->
          <div id="mathpix-output-container" style="display: none">
            <h2>Mathematical Output</h2>
            <!-- Processing Metadata -->
            <div
              class="mathpix-metadata"
              role="region"
              aria-label="Processing information"
            >
              <dl class="mathpix-info-list">
                <dt>Confidence:</dt>
                <dd id="mathpix-confidence">-</dd>
                <dt>Type:</dt>
                <dd id="mathpix-type">-</dd>
                <dt>Available formats:</dt>
                <dd id="mathpix-formats">-</dd>
              </dl>
            </div>
            <!-- Line Data Section -->
            <div
              id="mathpix-line-data-section"
              class="line-data-section"
              hidden
            >
              <button
                id="mathpix-line-data-toggle"
                class="line-data-toggle"
                type="button"
                aria-expanded="false"
                aria-controls="mathpix-line-data-content"
                onclick="window.getMathPixController()?.toggleLineData()"
              >
                <span class="toggle-icon" aria-hidden="true">☐</span>
                <span class="toggle-text">Show Processing Details</span>
              </button>

              <div
                id="mathpix-line-data-content"
                class="line-data-content"
                role="region"
                aria-labelledby="mathpix-line-data-toggle"
                hidden
              >
                <!-- Line data summary and details will be populated by JavaScript -->
              </div>
            </div>
            <!-- Format Selection Radio Buttons -->
            <fieldset class="mathpix-format-selection">
              <legend>Choose output format:</legend>
              <div class="mathpix-format-options">
                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="latex"
                    id="mathpix-format-latex"
                    checked
                  />
                  <div class="format-content">
                    <span class="format-label">LaTeX</span>
                    <span class="format-description"
                      >Mathematical typesetting format</span
                    >
                  </div>
                </label>

                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="mathml"
                    id="mathpix-format-mathml"
                  />
                  <div class="format-content">
                    <span class="format-label">MathML</span>
                    <span class="format-description"
                      >Web-standard mathematical markup</span
                    >
                  </div>
                </label>

                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="asciimath"
                    id="mathpix-format-asciimath"
                  />
                  <div class="format-content">
                    <span class="format-label">AsciiMath</span>
                    <span class="format-description"
                      >Plain text mathematical notation</span
                    >
                  </div>
                </label>

                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="html"
                    id="mathpix-format-html"
                  />
                  <div class="format-content">
                    <span class="format-label">HTML</span>
                    <span class="format-description">Web display format</span>
                  </div>
                </label>

                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="markdown"
                    id="mathpix-format-markdown"
                  />
                  <div class="format-content">
                    <span class="format-label">Markdown</span>
                    <span class="format-description"
                      >Document format with inline maths</span
                    >
                  </div>
                </label>

                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="json"
                    id="mathpix-format-json"
                  />
                  <div class="format-content">
                    <span class="format-label">Raw JSON</span>
                    <span class="format-description"
                      >Complete API response data</span
                    >
                  </div>
                </label>

                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="table-html"
                    id="mathpix-format-table-html"
                  />
                  <div class="format-content">
                    <span class="format-label">Table (HTML)</span>
                    <span class="format-description">HTML table format</span>
                  </div>
                </label>

                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="table-markdown"
                    id="mathpix-format-table-markdown"
                  />
                  <div class="format-content">
                    <span class="format-label">Table (Markdown)</span>
                    <span class="format-description"
                      >Markdown table format</span
                    >
                  </div>
                </label>

                <label class="mathpix-format-option">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="table-tsv"
                    id="mathpix-format-table-tsv"
                  />
                  <div class="format-content">
                    <span class="format-label">Table (TSV)</span>
                    <span class="format-description">Tab-separated values</span>
                  </div>
                </label>

                <!-- Phase 4: Chemistry Format Option (initially hidden) -->
                <label class="mathpix-format-option" style="display: none">
                  <input
                    type="radio"
                    name="mathpix-format"
                    value="smiles"
                    id="mathpix-format-smiles"
                  />
                  <div class="format-content">
                    <span class="format-label">SMILES</span>
                    <span class="format-description"
                      >Chemistry notation (Simplified Molecular-Input Line-Entry
                      System)</span
                    >
                  </div>
                </label>
              </div>
            </fieldset>

            <!-- Output Display Area -->
            <div class="mathpix-output-display">
              <!-- LaTeX Output -->
              <div
                id="mathpix-output-latex"
                class="mathpix-format-panel active"
                role="region"
                aria-labelledby="mathpix-format-latex"
              >
                <div class="code-block-wrapper">
                  <pre><code id="mathpix-content-latex" class="language-latex"></code></pre>
                </div>
              </div>

              <!-- MathML Output -->
              <div
                id="mathpix-output-mathml"
                class="mathpix-format-panel"
                role="region"
                aria-labelledby="mathpix-format-mathml"
              >
                <div class="code-block-wrapper">
                  <pre><code id="mathpix-content-mathml" class="language-xml"></code></pre>
                </div>
              </div>

              <!-- AsciiMath Output -->
              <div
                id="mathpix-output-asciimath"
                class="mathpix-format-panel"
                role="region"
                aria-labelledby="mathpix-format-asciimath"
              >
                <div class="code-block-wrapper">
                  <pre><code id="mathpix-content-asciimath" class="language-none"></code></pre>
                </div>
              </div>

              <!-- HTML Output -->
              <div
                id="mathpix-output-html"
                class="mathpix-format-panel"
                role="region"
                aria-labelledby="mathpix-format-html"
              >
                <!-- HTML Preview Controls -->
                <div class="html-preview-controls" style="display: none">
                  <div class="preview-control-header">
                    <button
                      type="button"
                      id="html-expand-toggle"
                      class="preview-toggle-btn"
                      aria-expanded="false"
                    >
                      <span
                        id="html-toggle-icon"
                        class="toggle-icon"
                        aria-hidden="true"
                        >▼</span
                      >
                      <span id="html-toggle-text" class="toggle-text"
                        >Show Full Content</span
                      >
                    </button>
                    <div class="preview-info">
                      <span class="preview-stats">
                        Showing
                        <span id="html-visible-lines" class="line-count"
                          >10</span
                        >
                        of
                        <span id="html-total-lines" class="line-count">0</span>
                        lines
                      </span>
                      <span id="html-size-info" class="size-info"></span>
                    </div>
                  </div>
                  <div
                    id="html-preview-summary"
                    class="preview-summary"
                    style="display: none"
                  >
                    <small
                      >Contains: <span id="html-content-summary"></span
                    ></small>
                  </div>
                </div>

                <div class="code-block-wrapper">
                  <pre><code id="mathpix-content-html" class="language-html"></code></pre>
                </div>

                <!-- HTML Preview -->
                <div class="mathpix-html-preview">
                  <h4>Preview:</h4>
                  <div
                    id="mathpix-html-preview-content"
                    class="preview-content"
                  ></div>
                </div>
              </div>

              <!-- Markdown Output -->
              <div
                id="mathpix-output-markdown"
                class="mathpix-format-panel"
                role="region"
                aria-labelledby="mathpix-format-markdown"
              >
                <div class="code-block-wrapper">
                  <pre><code id="mathpix-content-markdown" class="language-markdown"></code></pre>
                </div>
              </div>

              <!-- JSON Output -->
              <div
                id="mathpix-output-json"
                class="mathpix-format-panel"
                role="region"
                aria-labelledby="mathpix-format-json"
              >
                <div class="code-block-wrapper">
                  <pre><code id="mathpix-content-json" class="language-json"></code></pre>
                </div>
              </div>

              <!-- Phase 4: SMILES Chemistry Output -->
              <div
                id="mathpix-output-smiles"
                class="mathpix-format-panel"
                role="region"
                aria-labelledby="mathpix-format-smiles"
              >
                <div class="code-block-wrapper">
                  <pre><code id="mathpix-content-smiles" class="language-markup"></code></pre>
                </div>
              </div>
            </div>
            <!-- Table HTML Format -->
            <div
              id="mathpix-output-table-html"
              class="mathpix-format-panel"
              role="region"
              aria-labelledby="mathpix-format-table-html"
              data-format="table-html"
            >
              <div class="code-block-wrapper">
                <div
                  class="table-styling-control"
                  style="
                    margin-bottom: 1rem;
                    padding: 0.75rem;
                    background: var(--background-secondary);
                    border-radius: 4px;
                  "
                >
                  <label
                    style="
                      display: flex;
                      align-items: center;
                      gap: 0.5rem;
                      cursor: pointer;
                    "
                  >
                    <input
                      type="checkbox"
                      id="mathpix-preserve-table-styles"
                      checked
                      style="cursor: pointer"
                    />
                    <span>Preserve inline table styling</span>
                  </label>
                  <p
                    class="help-text"
                    style="
                      margin: 0.5rem 0 0 1.75rem;
                      font-size: 0.85em;
                      color: var(--text-secondary);
                    "
                  >
                    Unchecked: removes inline styles for custom CSS styling
                  </p>
                </div>
                <pre class="code-block-container language-html" tabindex="0">
      <code id="mathpix-content-table-html" class="language-html"></code>
    </pre>
              </div>
            </div>

            <!-- Table Markdown Format -->
            <div
              id="mathpix-output-table-markdown"
              class="mathpix-format-panel"
              role="region"
              aria-labelledby="mathpix-format-table-markdown"
              data-format="table-markdown"
            >
              <div class="code-block-wrapper">
                <pre
                  class="code-block-container language-markdown"
                  tabindex="0"
                >
      <code id="mathpix-content-table-markdown" class="language-markdown"></code>
    </pre>
              </div>
            </div>

            <!-- Table TSV Format -->
            <div
              id="mathpix-output-table-tsv"
              class="mathpix-format-panel"
              role="region"
              aria-labelledby="mathpix-format-table-tsv"
              data-format="table-tsv"
            >
              <div class="code-block-wrapper">
                <pre class="code-block-container" tabindex="0">
      <code id="mathpix-content-table-tsv"></code>
    </pre>
              </div>
            </div>
          </div>

          <!-- Phase 2.1: PDF Document Processing Interface (Initially Hidden) -->
          <div
            id="mathpix-pdf-interface"
            style="display: none"
            role="region"
            aria-label="PDF document processing"
          >
            <h2>PDF Document Processing</h2>

            <!-- PDF Upload Section -->
            <div class="mathpix-pdf-upload-container">
              <div
                id="mathpix-pdf-drop-zone"
                class="drop-zone mathpix-pdf-drop-zone"
                role="button"
                tabindex="0"
                aria-describedby="pdf-upload-instructions"
              >
                <p id="pdf-upload-instructions">
                  <svg
                    aria-hidden="true"
                    height="40"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(2 2)"
                    >
                      <path
                        d="m11.5779891 4.55941656c1.1699828.91516665 1.9220109 2.34005226 1.9220109 3.94058344 0 .48543539-.0691781.95471338-.1982137 1.39851335.3339576-.25026476.748773-.39851335 1.1982137-.39851335 1.1045695 0 2 .8954305 2 2s-.8954305 2-2 2c-1.104407 0-10.16182706 0-11 0-1.65685425 0-3-1.3431458-3-3 0-1.65685425 1.34314575-3 3-3 .03335948 0 .06659179.00054449.09968852.00162508.242805-1.19819586.9140534-2.24091357 1.84691265-2.96132058"
                      />
                      <path d="m6.5 2.5 2-2 2 2" />
                      <path d="m8.5.5v9" />
                    </g>
                  </svg>
                  Drop PDF document here, or click to select
                  <br />
                  <span class="help-text"
                    >Supports: PDF documents (max 512MB)</span
                  >
                </p>
                <input
                  type="file"
                  id="mathpix-pdf-file-input"
                  accept="application/pdf"
                  style="display: none"
                  aria-label="Select PDF document for processing"
                />
              </div>
            </div>

            <!-- PDF Processing Options -->
            <div
              id="mathpix-pdf-options"
              class="mathpix-pdf-options"
              style="display: none"
            >
              <h3>Processing Options</h3>

              <!-- Page Range Selection -->
              <fieldset class="mathpix-option-group">
                <legend>Page Range</legend>
                <div class="mathpix-radio-group">
                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-page-range"
                      value="all"
                      id="pdf-pages-all"
                      checked
                    />
                    <span class="option-content">
                      <span class="option-label">All Pages</span>
                      <span class="option-description"
                        >Process entire document</span
                      >
                    </span>
                  </label>

                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-page-range"
                      value="first-10"
                      id="pdf-pages-first-10"
                    />
                    <span class="option-content">
                      <span class="option-label">First 10 Pages</span>
                      <span class="option-description"
                        >Cost-effective preview</span
                      >
                    </span>
                  </label>

                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-page-range"
                      value="custom"
                      id="pdf-pages-custom"
                    />
                    <span class="option-content">
                      <span class="option-label">Custom Range</span>
                      <span class="option-description"
                        >Specify page numbers</span
                      >
                    </span>
                  </label>
                </div>

                <div
                  id="pdf-custom-range"
                  class="mathpix-custom-range"
                  style="display: none"
                >
                  <label for="pdf-page-numbers"
                    >Page numbers (e.g., 1-5, 7, 10-12):</label
                  >
                  <input
                    type="text"
                    id="pdf-page-numbers"
                    placeholder="1-5, 7, 10-12"
                    aria-describedby="pdf-range-help"
                  />
                  <div id="pdf-range-help" class="help-text">
                    Use commas for individual pages, hyphens for ranges
                  </div>
                </div>
              </fieldset>

              <!-- Output Format Selection -->
              <fieldset class="mathpix-option-group">
                <legend>Output Formats</legend>
                <div class="mathpix-format-options">
                  <!-- Select All Formats Option -->
                  <label class="mathpix-format-checkbox select-all-option">
                    <input type="checkbox" id="select-all-formats" checked />
                    <span class="format-content">
                      <span class="format-label"
                        >Select All Available Formats</span
                      >
                      <span class="format-description"
                        >Choose all export formats for comprehensive
                        output</span
                      >
                    </span>
                  </label>

                  <label class="mathpix-format-checkbox">
                    <input
                      type="checkbox"
                      id="pdf-format-mmd"
                      value="mmd"
                      checked
                      disabled
                    />
                    <span class="format-content">
                      <span class="format-label">MMD (MathPix Markdown)</span>
                      <span class="format-description"
                        >Base format - always included</span
                      >
                    </span>
                  </label>

                  <label class="mathpix-format-checkbox">
                    <input
                      type="checkbox"
                      id="pdf-format-md"
                      value="md"
                      checked
                    />
                    <span class="format-content">
                      <span class="format-label">MD (Plain Markdown)</span>
                      <span class="format-description"
                        >Standard Markdown for broad compatibility</span
                      >
                    </span>
                  </label>

                  <label class="mathpix-format-checkbox">
                    <input
                      type="checkbox"
                      id="pdf-format-html"
                      value="html"
                      checked
                    />
                    <span class="format-content">
                      <span class="format-label">HTML</span>
                      <span class="format-description"
                        >Web-ready format with MathML</span
                      >
                    </span>
                  </label>

                  <label class="mathpix-format-checkbox">
                    <input
                      type="checkbox"
                      id="pdf-format-latex"
                      value="tex.zip"
                      checked
                    />
                    <span class="format-content">
                      <span class="format-label">LaTeX</span>
                      <span class="format-description"
                        >Academic typesetting format (ZIP file)</span
                      >
                    </span>
                  </label>

                  <label class="mathpix-format-checkbox">
                    <input
                      type="checkbox"
                      id="pdf-format-docx"
                      value="docx"
                      checked
                    />
                    <span class="format-content">
                      <span class="format-label">DOCX</span>
                      <span class="format-description"
                        >Microsoft Word format</span
                      >
                    </span>
                  </label>
                </div>
              </fieldset>

              <!-- Maths Delimiter Format Selection (Phase 5, Feature 1) -->
              <fieldset class="mathpix-option-group mathpix-delimiter-options">
                <legend>Maths Delimiter Format for MMD output</legend>

                <div class="mathpix-radio-group">
                  <!-- Markdown Style -->
                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-math-delimiters"
                      value="markdown"
                      id="pdf-delim-markdown"
                      aria-describedby="pdf-delim-markdown-desc"
                      checked
                    />
                    <span class="option-content">
                      <span class="option-label">Markdown Style</span>
                    </span>
                  </label>

                  <!-- LaTeX Style -->
                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-math-delimiters"
                      value="latex"
                      id="pdf-delim-latex"
                      aria-describedby="pdf-delim-latex-desc"
                    />
                    <span class="option-content">
                      <span class="option-label">LaTeX Style</span>
                    </span>
                  </label>

                  <!-- Custom Style (Advanced) -->
                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-math-delimiters"
                      value="custom"
                      id="pdf-delim-custom"
                      aria-describedby="pdf-delim-custom-desc"
                    />
                    <span class="option-content">
                      <span class="option-label">Custom Delimiters</span>
                      <span
                        class="option-description"
                        id="pdf-delim-custom-desc"
                      >
                        Specify your own delimiter preferences
                      </span>
                    </span>
                  </label>
                </div>

                <!-- Custom Delimiter Input (Hidden by default) -->
                <div
                  id="pdf-custom-delimiters"
                  class="mathpix-custom-delimiters"
                  style="display: none"
                >
                  <div class="delimiter-input-group">
                    <label for="pdf-inline-delim-start">
                      Inline Start:
                      <input
                        type="text"
                        id="pdf-inline-delim-start"
                        value="$"
                        placeholder="e.g., $"
                        maxlength="10"
                        aria-label="Inline mathematics start delimiter"
                      />
                    </label>
                    <label for="pdf-inline-delim-end">
                      Inline End:
                      <input
                        type="text"
                        id="pdf-inline-delim-end"
                        value="$"
                        placeholder="e.g., $"
                        maxlength="10"
                        aria-label="Inline mathematics end delimiter"
                      />
                    </label>
                  </div>

                  <div class="delimiter-input-group">
                    <label for="pdf-display-delim-start">
                      Display Start:
                      <input
                        type="text"
                        id="pdf-display-delim-start"
                        value="$$"
                        placeholder="e.g., $$"
                        maxlength="10"
                        aria-label="Display mathematics start delimiter"
                      />
                    </label>
                    <label for="pdf-display-delim-end">
                      Display End:
                      <input
                        type="text"
                        id="pdf-display-delim-end"
                        value="$$"
                        placeholder="e.g., $$"
                        maxlength="10"
                        aria-label="Display mathematics end delimiter"
                      />
                    </label>
                  </div>

                  <p class="help-text">
                    Preview: Inline <code id="inline-preview">$x^2$</code> |
                    Display <code id="display-preview">$$E = mc^2$$</code>
                  </p>
                </div>
              </fieldset>

              <!-- Phase 5, Feature 2: Equation & Section Numbering Options -->
              <fieldset class="mathpix-option-group mathpix-numbering-options">
                <legend>Equation & Section Numbering</legend>
                <p class="option-group-description">
                  Control how equations and sections are numbered in the output
                </p>

                <!-- Equation Numbering Checkboxes -->
                <div class="mathpix-checkbox-group">
                  <label class="mathpix-option mathpix-checkbox-option">
                    <input
                      type="checkbox"
                      id="pdf-equation-tags"
                      value="true"
                      checked
                    />
                    <span class="option-content">
                      <span class="option-label"
                        >Include Equation Numbering</span
                      >
                      <span class="option-description">
                        Adds equation tags like <code>\tag{1.2}</code> to
                        numbered equations.
                        <br />
                        <strong>Note:</strong> Automatically enables idiomatic
                        equation environments.
                      </span>
                    </span>
                  </label>

                  <label class="mathpix-option mathpix-checkbox-option">
                    <input
                      type="checkbox"
                      id="pdf-idiomatic-arrays"
                      value="true"
                      checked
                    />
                    <span class="option-content">
                      <span class="option-label"
                        >Use Idiomatic Equation Environments</span
                      >
                      <span class="option-description">
                        Uses <code>aligned</code>, <code>gathered</code>, or
                        <code>cases</code> instead of
                        <code>array</code> environment for equation lists.
                        <br />
                        <strong>Recommended:</strong> Better formatting and
                        equation numbering support.
                      </span>
                    </span>
                  </label>
                </div>

                <!-- Section Numbering Radio Buttons -->
                <div class="mathpix-radio-group" style="margin-top: 1.5rem">
                  <p class="option-group-label">Section Numbering:</p>

                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-section-numbering"
                      value="preserve"
                      id="pdf-section-preserve"
                      checked
                    />
                    <span class="option-content">
                      <span class="option-label"
                        >Preserve Existing Numbering</span
                      >
                      <span class="option-description">
                        Keep section numbers exactly as they appear in the
                        original document
                      </span>
                    </span>
                  </label>

                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-section-numbering"
                      value="auto"
                      id="pdf-section-auto"
                    />
                    <span class="option-content">
                      <span class="option-label"
                        >Automatically Number Sections</span
                      >
                      <span class="option-description">
                        Generate sequential numbering for all sections and
                        subsections
                      </span>
                    </span>
                  </label>

                  <label class="mathpix-option">
                    <input
                      type="radio"
                      name="pdf-section-numbering"
                      value="remove"
                      id="pdf-section-remove"
                    />
                    <span class="option-content">
                      <span class="option-label"
                        >Remove All Section Numbering</span
                      >
                      <span class="option-description">
                        Strip existing numbering from sections and subsections
                      </span>
                    </span>
                  </label>
                </div>
              </fieldset>

              <!-- Processing Actions -->
              <div class="mathpix-pdf-actions">
                <button
                  type="button"
                  id="mathpix-pdf-process-btn"
                  class="mathpix-process-btn"
                >
                  <svg
                    height="21"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(2 2)"
                    >
                      <path
                        d="m11.5779891 4.55941656c1.1699828.91516665 1.9220109 2.34005226 1.9220109 3.94058344 0 .48543539-.0691781.95471338-.1982137 1.39851335.3339576-.25026476.748773-.39851335 1.1982137-.39851335 1.1045695 0 2 .8954305 2 2s-.8954305 2-2 2c-1.104407 0-10.16182706 0-11 0-1.65685425 0-3-1.3431458-3-3 0-1.65685425 1.34314575-3 3-3 .03335948 0 .06659179.00054449.09968852.00162508.242805-1.19819586.9140534-2.24091357 1.84691265-2.96132058"
                      />
                      <path d="m6.5 2.5 2-2 2 2" />
                      <path d="m8.5.5v9" />
                    </g>
                  </svg>
                  Process PDF Document
                </button>
                <button
                  type="button"
                  id="mathpix-pdf-cancel-btn"
                  class="mathpix-cancel-btn"
                >
                  Cancel
                </button>
              </div>
            </div>

            <!-- PDF Processing Progress -->
            <div
              id="mathpix-pdf-progress"
              class="mathpix-pdf-progress"
              style="display: none"
            >
              <h3>Processing Document</h3>

              <div class="mathpix-progress-bar-container">
                <div
                  class="mathpix-progress-bar"
                  role="progressbar"
                  aria-valuemin="0"
                  aria-valuemax="100"
                  aria-valuenow="0"
                  aria-label="Document processing progress"
                >
                  <div
                    id="mathpix-pdf-progress-fill"
                    class="mathpix-progress-fill"
                  ></div>
                </div>
                <div
                  id="mathpix-pdf-progress-text"
                  class="mathpix-progress-text"
                >
                  Uploading document...
                </div>
              </div>

              <div class="mathpix-progress-details">
                <div id="mathpix-pdf-status" class="mathpix-status-text">
                  Starting processing...
                </div>
                <div id="mathpix-pdf-timing" class="mathpix-timing-text">
                  Estimated time remaining: calculating...
                </div>
              </div>
            </div>

            <!-- Enhanced Progress Display -->
            <div
              id="pdf-progress-enhanced"
              class="progress-container-enhanced"
              style="display: none"
            >
              <!-- Progress Header -->
              <div class="progress-header">
                <div class="progress-title-section">
                  <h3 class="progress-title">
                    <svg
                      id="pdf-progress-icon"
                      class="progress-icon"
                      aria-hidden="true"
                      height="21"
                      viewBox="0 0 21 21"
                      width="21"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <g
                        fill="none"
                        fill-rule="evenodd"
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        transform="translate(3 3)"
                      >
                        <path
                          d="m7.5.5c.35132769 0 .69661025.02588228 1.03404495.07584411l.50785434 1.53911115c.44544792.12730646.86820077.30839026 1.26078721.53578009l1.4600028-.70360861c.5166435.39719686.9762801.86487779 1.3645249 1.388658l-.7293289 1.44720284c.2201691.39604534.3936959.82158734.5131582 1.2692035l1.5298263.5338186c.0390082.29913986.0591302.60421522.0591302.91399032 0 .35132769-.0258823.69661025-.0758441 1.03404495l-1.5391112.50785434c-.1273064.44544792-.3083902.86820077-.5357801 1.26078721l.7036087 1.4600028c-.3971969.5166435-.8648778.9762801-1.388658 1.3645249l-1.4472029-.7293289c-.39604532.2201691-.82158732.3936959-1.26920348.5131582l-.5338186 1.5298263c-.29913986.0390082-.60421522.0591302-.91399032.0591302-.35132769 0-.69661025-.0258823-1.03404495-.0758441l-.50785434-1.5391112c-.44544792-.1273064-.86820077-.3083902-1.26078723-.5357801l-1.46000277.7036087c-.51664349-.3971969-.97628006-.8648778-1.36452491-1.388658l.72932886-1.4472029c-.2203328-.39633993-.39395403-.82222042-.51342462-1.27020241l-1.52968981-.53381682c-.03892294-.29882066-.05900023-.60356226-.05900023-.91299317 0-.35132769.02588228-.69661025.07584411-1.03404495l1.53911115-.50785434c.12730646-.44544792.30839026-.86820077.53578009-1.26078723l-.70360861-1.46000277c.39719686-.51664349.86487779-.97628006 1.388658-1.36452491l1.44720284.72932886c.39633995-.2203328.82222044-.39395403 1.27020243-.51342462l.53381682-1.52968981c.29882066-.03892294.60356226-.05900023.91299317-.05900023z"
                          stroke-width=".933"
                        />
                        <circle cx="7.5" cy="7.5" r="3" />
                      </g>
                    </svg>
                    <span id="pdf-progress-title">Processing Document</span>
                  </h3>
                  <div id="pdf-progress-subtitle" class="progress-subtitle">
                    Preparing your document for analysis...
                  </div>
                </div>
                <div class="progress-actions">
                  <button
                    type="button"
                    id="pdf-cancel-btn"
                    class="cancel-btn"
                    style="display: none"
                  >
                    <svg
                      height="21"
                      viewBox="0 0 21 21"
                      width="21"
                      xmlns="http://www.w3.org/2000/svg"
                      aria-hidden="true"
                    >
                      <g
                        fill="none"
                        fill-rule="evenodd"
                        stroke="currentColor"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        transform="translate(5 5)"
                      >
                        <path d="m10.5 10.5-10-10z" />
                        <path d="m10.5.5-10 10" />
                      </g>
                    </svg>
                    Cancel
                  </button>
                </div>
              </div>

              <!-- Progress Bar Section -->
              <div class="progress-bar-section">
                <div class="progress-bar-container">
                  <div id="pdf-progress-bar-enhanced" class="progress-bar">
                    <div id="pdf-progress-fill-enhanced" class="progress-fill">
                      <div class="progress-shine"></div>
                    </div>
                  </div>
                  <div class="progress-percentage-display">
                    <span
                      id="pdf-progress-percentage-enhanced"
                      class="progress-percentage"
                      >0%</span
                    >
                  </div>
                </div>
              </div>

              <!-- Detailed Status Section -->
              <div class="progress-details-enhanced">
                <div class="progress-status-row">
                  <div class="status-left">
                    <div id="pdf-progress-text-enhanced" class="progress-text">
                      Starting document analysis...
                    </div>
                    <div id="pdf-detailed-status" class="detailed-status">
                      <span id="current-stage" class="current-stage"
                        >Initializing</span
                      >
                      <span class="stage-separator">•</span>
                      <span id="stage-progress" class="stage-progress"
                        >Preparing upload...</span
                      >
                    </div>
                  </div>
                  <div class="status-right">
                    <div id="pdf-processing-time" class="processing-time">
                      <div class="time-section">
                        <span class="time-label">Elapsed:</span>
                        <span id="elapsed-time" class="time-value">00:00</span>
                      </div>
                      <div
                        id="estimated-remaining"
                        class="time-section time-estimate"
                        style="display: none"
                      >
                        <span class="time-label">Est. remaining:</span>
                        <span id="remaining-time" class="time-value"
                          >00:00</span
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Stage Progress Indicators -->
              <div id="progress-stages" class="progress-stages">
                <div class="stage-indicator" data-stage="upload">
                  <div class="stage-dot"></div>
                  <div class="stage-label">Upload</div>
                </div>
                <div class="stage-indicator" data-stage="validation">
                  <div class="stage-dot"></div>
                  <div class="stage-label">Validation</div>
                </div>
                <div class="stage-indicator" data-stage="queue">
                  <div class="stage-dot"></div>
                  <div class="stage-label">Queue</div>
                </div>
                <div class="stage-indicator" data-stage="processing">
                  <div class="stage-dot"></div>
                  <div class="stage-label">Processing</div>
                </div>
                <div class="stage-indicator" data-stage="download">
                  <div class="stage-dot"></div>
                  <div class="stage-label">Results</div>
                </div>
              </div>
            </div>

            <!-- Content Summary Display -->
            <div
              id="content-summary-display"
              class="content-summary-container"
              style="display: none"
            >
              <!-- Content summary will be populated by JavaScript -->
            </div>

            <!-- PDF Results Display -->
            <div
              id="mathpix-pdf-results"
              class="mathpix-pdf-results"
              style="display: none"
            >
              <h3>Document Processing Results</h3>

              <!-- Document Information -->
              <div class="mathpix-document-info">
                <dl class="mathpix-doc-details">
                  <dt>Document:</dt>
                  <dd id="mathpix-doc-name">-</dd>
                  <dt>Pages processed:</dt>
                  <dd id="mathpix-doc-pages">-</dd>
                  <dt>Processing time:</dt>
                  <dd id="mathpix-doc-time">-</dd>
                  <dt>Formats generated:</dt>
                  <dd id="mathpix-doc-formats">-</dd>
                </dl>

                <!-- Integrated Page Statistics -->
                <div
                  id="mathpix-page-statistics"
                  class="mathpix-page-statistics"
                  style="display: none"
                >
                  <h4 class="stats-heading">Document Content Summary:</h4>
                  <dl class="page-content-summary">
                    <div class="stat-item">
                      <dt>Lines:</dt>
                      <dd id="page-stat-lines">0</dd>
                    </div>
                    <div class="stat-item">
                      <dt>Mathematics:</dt>
                      <dd id="page-stat-math">0</dd>
                    </div>
                    <div class="stat-item">
                      <dt>Tables:</dt>
                      <dd id="page-stat-tables">0</dd>
                    </div>
                    <div class="stat-item">
                      <dt>Handwritten:</dt>
                      <dd id="page-stat-handwritten">0</dd>
                    </div>
                    <div class="stat-item">
                      <dt>Printed:</dt>
                      <dd id="page-stat-printed">0</dd>
                    </div>
                  </dl>
                </div>
              </div>

              <!-- Format Tabs for Results -->
              <div class="mathpix-results-tabs">
                <div class="mathpix-tab-headers" role="tablist">
                  <button
                    type="button"
                    id="tab-mmd"
                    class="mathpix-tab-header"
                    role="tab"
                    aria-controls="panel-mmd"
                    aria-selected="false"
                    tabindex="-1"
                    data-format="mmd"
                  >
                    MMD
                  </button>
                  <button
                    type="button"
                    id="tab-md"
                    class="mathpix-tab-header"
                    role="tab"
                    aria-controls="panel-md"
                    aria-selected="false"
                    tabindex="-1"
                    data-format="md"
                    style="display: none"
                  >
                    MD
                  </button>
                  <button
                    type="button"
                    id="tab-html"
                    class="mathpix-tab-header"
                    role="tab"
                    aria-controls="panel-html"
                    aria-selected="false"
                    tabindex="-1"
                    data-format="html"
                  >
                    HTML
                  </button>
                  <button
                    type="button"
                    id="tab-latex"
                    class="mathpix-tab-header"
                    role="tab"
                    aria-controls="panel-latex"
                    aria-selected="false"
                    tabindex="-1"
                    data-format="latex"
                    style="display: none"
                  >
                    LaTeX
                  </button>
                  <button
                    type="button"
                    id="tab-docx"
                    class="mathpix-tab-header"
                    role="tab"
                    aria-controls="panel-docx"
                    aria-selected="false"
                    tabindex="-1"
                    data-format="docx"
                    style="display: none"
                  >
                    DOCX
                  </button>
                </div>

                <!-- MMD Results Panel -->
                <div
                  id="panel-mmd"
                  class="mathpix-tab-panel active"
                  role="tabpanel"
                  aria-labelledby="tab-mmd"
                >
                  <div class="mathpix-format-header">
                    <h4>Markdown (MMD) Output</h4>
                    <div class="mathpix-format-actions">
                      <button
                        type="button"
                        class="mathpix-copy-btn"
                        data-format="mmd"
                      >
                        <svg
                          height="21"
                          viewBox="0 0 21 21"
                          width="21"
                          xmlns="http://www.w3.org/2000/svg"
                          aria-hidden="true"
                        >
                          <g
                            fill="none"
                            fill-rule="evenodd"
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            transform="translate(4 3)"
                          >
                            <path
                              d="m3.5 1.5c-.44119105-.00021714-1.03893772-.0044496-1.99754087-.00501204-.51283429-.00116132-.93645365.3838383-.99544161.88103343l-.00701752.11906336v10.99753785c.00061498.5520447.44795562.9996604 1 1.0006148l10 .0061982c.5128356.0008356.9357441-.3849039.993815-.882204l.006185-.1172316v-11c0-.55228475-.4477152-1-1-1-.8704853-.00042798-1.56475733.00021399-2 0"
                            />
                            <path
                              d="m4.5.5h4c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-4c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1z"
                            />
                            <path d="m2.5 5.5h5" />
                            <path d="m2.5 7.5h7" />
                            <path d="m2.5 9.5h3" />
                            <path d="m2.5 11.5h6" />
                          </g>
                        </svg>
                        Copy
                      </button>
                      <button
                        type="button"
                        class="mathpix-download-btn"
                        data-format="mmd"
                      >
                        <span aria-hidden="true">📥</span> Download
                      </button>
                    </div>
                  </div>
                  <div class="code-block-wrapper">
                    <pre><code id="mathpix-pdf-content-mmd" class="language-markdown"></code></pre>
                  </div>
                </div>

                <!-- MD Results Panel (Feature 3) -->
                <div
                  id="panel-md"
                  class="mathpix-tab-panel"
                  role="tabpanel"
                  aria-labelledby="tab-md"
                >
                  <div class="mathpix-format-header">
                    <h4>Plain Markdown (MD) Output</h4>
                    <div class="mathpix-format-actions">
                      <button
                        type="button"
                        class="mathpix-copy-btn"
                        data-format="md"
                      >
                        <svg
                          height="21"
                          viewBox="0 0 21 21"
                          width="21"
                          xmlns="http://www.w3.org/2000/svg"
                          aria-hidden="true"
                        >
                          <g
                            fill="none"
                            fill-rule="evenodd"
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            transform="translate(4 3)"
                          >
                            <path
                              d="m3.5 1.5c-.44119105-.00021714-1.03893772-.0044496-1.99754087-.00501204-.51283429-.00116132-.93645365.3838383-.99544161.88103343l-.00701752.11906336v10.99753785c.00061498.5520447.44795562.9996604 1 1.0006148l10 .0061982c.5128356.0008356.9357441-.3849039.993815-.882204l.006185-.1172316v-11c0-.55228475-.4477152-1-1-1-.8704853-.00042798-1.56475733.00021399-2 0"
                            />
                            <path
                              d="m4.5.5h4c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-4c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1z"
                            />
                            <path d="m2.5 5.5h5" />
                            <path d="m2.5 7.5h7" />
                            <path d="m2.5 9.5h3" />
                            <path d="m2.5 11.5h6" />
                          </g>
                        </svg>
                        Copy
                      </button>
                      <button
                        type="button"
                        class="mathpix-download-btn"
                        data-format="md"
                      >
                        <span aria-hidden="true">📥</span> Download
                      </button>
                    </div>
                  </div>
                  <div class="code-block-wrapper">
                    <pre><code id="mathpix-pdf-content-md" class="language-markdown"></code></pre>
                  </div>
                </div>

                <!-- HTML Results Panel -->
                <div
                  id="panel-html"
                  class="mathpix-tab-panel"
                  role="tabpanel"
                  aria-labelledby="tab-html"
                >
                  <div class="mathpix-format-header">
                    <h4>HTML Output</h4>
                    <div class="mathpix-format-actions">
                      <button
                        type="button"
                        class="mathpix-copy-btn"
                        data-format="html"
                      >
                        <svg
                          height="21"
                          viewBox="0 0 21 21"
                          width="21"
                          xmlns="http://www.w3.org/2000/svg"
                          aria-hidden="true"
                        >
                          <g
                            fill="none"
                            fill-rule="evenodd"
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            transform="translate(4 3)"
                          >
                            <path
                              d="m3.5 1.5c-.44119105-.00021714-1.03893772-.0044496-1.99754087-.00501204-.51283429-.00116132-.93645365.3838383-.99544161.88103343l-.00701752.11906336v10.99753785c.00061498.5520447.44795562.9996604 1 1.0006148l10 .0061982c.5128356.0008356.9357441-.3849039.993815-.882204l.006185-.1172316v-11c0-.55228475-.4477152-1-1-1-.8704853-.00042798-1.56475733.00021399-2 0"
                            />
                            <path
                              d="m4.5.5h4c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-4c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1z"
                            />
                            <path d="m2.5 5.5h5" />
                            <path d="m2.5 7.5h7" />
                            <path d="m2.5 9.5h3" />
                            <path d="m2.5 11.5h6" />
                          </g>
                        </svg>
                        Copy
                      </button>
                      <button
                        type="button"
                        class="mathpix-download-btn"
                        data-format="html"
                      >
                        <span aria-hidden="true">📥</span> Download
                      </button>
                      <button
                        type="button"
                        class="mathpix-preview-btn"
                        data-format="html"
                      >
                        <span aria-hidden="true">👁️</span> Preview
                      </button>
                    </div>
                  </div>
                  <div class="code-block-wrapper">
                    <pre><code id="mathpix-pdf-content-html" class="language-html"></code></pre>
                  </div>

                  <!-- HTML Preview Area -->
                  <div
                    id="mathpix-html-preview-area"
                    class="mathpix-html-preview-area"
                    style="display: none"
                  >
                    <h5>HTML Preview:</h5>
                    <div
                      id="mathpix-html-preview-frame"
                      class="mathpix-preview-frame"
                    >
                      <!-- HTML preview will be rendered here -->
                    </div>
                  </div>
                </div>

                <!-- LaTeX Results Panel -->
                <div
                  id="panel-latex"
                  class="mathpix-tab-panel"
                  role="tabpanel"
                  aria-labelledby="tab-latex"
                >
                  <div class="mathpix-format-header">
                    <h4>LaTeX Output</h4>
                    <div class="mathpix-format-actions">
                      <button
                        type="button"
                        class="mathpix-copy-btn"
                        data-format="latex"
                      >
                        <svg
                          height="21"
                          viewBox="0 0 21 21"
                          width="21"
                          xmlns="http://www.w3.org/2000/svg"
                          aria-hidden="true"
                        >
                          <g
                            fill="none"
                            fill-rule="evenodd"
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            transform="translate(4 3)"
                          >
                            <path
                              d="m3.5 1.5c-.44119105-.00021714-1.03893772-.0044496-1.99754087-.00501204-.51283429-.00116132-.93645365.3838383-.99544161.88103343l-.00701752.11906336v10.99753785c.00061498.5520447.44795562.9996604 1 1.0006148l10 .0061982c.5128356.0008356.9357441-.3849039.993815-.882204l.006185-.1172316v-11c0-.55228475-.4477152-1-1-1-.8704853-.00042798-1.56475733.00021399-2 0"
                            />
                            <path
                              d="m4.5.5h4c.55228475 0 1 .44771525 1 1s-.44771525 1-1 1h-4c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1z"
                            />
                            <path d="m2.5 5.5h5" />
                            <path d="m2.5 7.5h7" />
                            <path d="m2.5 9.5h3" />
                            <path d="m2.5 11.5h6" />
                          </g>
                        </svg>
                        Copy
                      </button>
                      <button
                        type="button"
                        class="mathpix-download-btn"
                        data-format="latex"
                      >
                        <span aria-hidden="true">📥</span> Download
                      </button>
                    </div>
                  </div>
                  <div class="code-block-wrapper">
                    <pre><code id="mathpix-pdf-content-latex" class="language-latex"></code></pre>
                  </div>
                </div>

                <!-- DOCX Results Panel -->
                <div
                  id="panel-docx"
                  class="mathpix-tab-panel"
                  role="tabpanel"
                  aria-labelledby="tab-docx"
                >
                  <div class="mathpix-format-header">
                    <h4>DOCX Output</h4>
                    <div class="mathpix-format-actions">
                      <button
                        type="button"
                        class="mathpix-download-btn"
                        data-format="docx"
                      >
                        <span aria-hidden="true">📥</span> Download DOCX
                      </button>
                    </div>
                  </div>
                  <div id="mathpix-pdf-content-docx" class="mathpix-docx-info">
                    <p>
                      <svg
                        height="21"
                        viewBox="0 0 21 21"
                        width="21"
                        xmlns="http://www.w3.org/2000/svg"
                        aria-hidden="true"
                      >
                        <g
                          fill="none"
                          fill-rule="evenodd"
                          stroke="currentColor"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          transform="translate(4 3)"
                        >
                          <path
                            d="m12.5 12.5v-10c0-1.1045695-.8954305-2-2-2h-8c-1.1045695 0-2 .8954305-2 2v10c0 1.1045695.8954305 2 2 2h8c1.1045695 0 2-.8954305 2-2z"
                          />
                          <path d="m3.5 5.5h5" />
                          <path d="m3.5 7.5h6" />
                          <path d="m3.5 9.5h3" />
                        </g>
                      </svg>
                      DOCX file generated successfully. Click download to save
                      the Microsoft Word document.
                    </p>
                  </div>
                </div>
              </div>
              <!-- Page Navigation with Integrated Statistics -->
              <div
                id="mathpix-page-navigation"
                class="mathpix-page-navigation"
                style="display: none"
              >
                <div class="mathpix-page-nav-controls">
                  <button id="mathpix-prev-page" class="mathpix-nav-button">
                    <span aria-hidden="true">←</span> Previous Page
                  </button>
                  <div class="mathpix-page-info">
                    Page <span id="mathpix-page-current">1</span> of
                    <span id="mathpix-page-total">1</span>
                  </div>
                  <button id="mathpix-next-page" class="mathpix-nav-button">
                    Next Page <span aria-hidden="true">→</span>
                  </button>
                </div>

                <!-- Integrated Page Content Statistics -->
                <div
                  id="mathpix-page-statistics"
                  class="mathpix-page-statistics"
                >
                  <h4 class="stats-heading">Page Content Analysis:</h4>
                  <dl class="page-content-summary">
                    <div class="stat-item">
                      <dt>Lines:</dt>
                      <dd id="page-stat-lines">0</dd>
                    </div>
                    <div class="stat-item">
                      <dt>Mathematics:</dt>
                      <dd id="page-stat-math">0</dd>
                    </div>
                    <div class="stat-item">
                      <dt>Tables:</dt>
                      <dd id="page-stat-tables">0</dd>
                    </div>
                    <div class="stat-item">
                      <dt>Handwritten:</dt>
                      <dd id="page-stat-handwritten">0</dd>
                    </div>
                    <div class="stat-item">
                      <dt>Printed:</dt>
                      <dd id="page-stat-printed">0</dd>
                    </div>
                  </dl>
                </div>
              </div>
              <!-- Processing Actions -->
              <div class="mathpix-pdf-final-actions">
                <button
                  type="button"
                  id="mathpix-process-another-pdf"
                  class="mathpix-process-another-btn"
                >
                  <svg
                    height="21"
                    aria-hidden="true"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(4 3)"
                    >
                      <path
                        d="m12.5 12.5v-10c0-1.1045695-.8954305-2-2-2h-8c-1.1045695 0-2 .8954305-2 2v10c0 1.1045695.8954305 2 2 2h8c1.1045695 0 2-.8954305 2-2z"
                      />
                      <path d="m3.5 5.5h5" />
                      <path d="m3.5 7.5h6" />
                      <path d="m3.5 9.5h3" />
                    </g>
                  </svg>
                  Process Another PDF
                </button>
                <button
                  type="button"
                  id="mathpix-clear-pdf-results"
                  class="mathpix-clear-results-btn"
                >
                  Clear Results
                </button>
              </div>
            </div>
          </div>
          <!-- API Configuration (Development Only) -->
          <details class="mathpix-config">
            <summary>API Configuration</summary>
            <form class="config-inputs" onsubmit="return false;">
              <label for="mathpix-app-id">App ID:</label>
              <input
                type="text"
                id="mathpix-app-id"
                placeholder="Enter MathPix App ID"
              />

              <label for="mathpix-app-key">App Key:</label>
              <input
                type="password"
                id="mathpix-app-key"
                placeholder="Enter MathPix App Key"
                autocomplete="off"
              />

              <button id="mathpix-save-config" type="button">
                Save Configuration
              </button>
            </form>
          </details>
        </article>

        <div id="panel">
          <button class="panelButton" onclick="topFunction()" id="myBtn">
            <svg
              id="svgUP"
              height="50"
              viewBox="0 0 21 21"
              width="50"
              xmlns="http://www.w3.org/2000/svg"
              role="img"
              aria-labelledby="svgTitle2 svgDesc2"
            >
              <title id="svgTitle2">Top.</title>
              <desc id="svgDesc2">Move to the top of the page.</desc>
              <g
                fill="none"
                fill-rule="evenodd"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                transform="translate(2 2)"
              >
                <circle cx="8.5" cy="8.5" r="8" />
                <path d="m11.5 7.5-3-3-3 3" />
                <path d="m8.5 4.5v8" />
              </g>
            </svg>
            <br />
            <span id="myBtnTop" class="panelLabel">Top</span>
          </button>
          <button class="panelButton" onclick="bottomFunction()" id="myBtn2">
            <svg
              id="svgDOWN"
              height="50"
              viewBox="0 0 21 21"
              width="50"
              xmlns="http://www.w3.org/2000/svg"
              role="img"
              aria-labelledby="svgTitle3 svgDesc3"
            >
              <title id="svgTitle3">Bottom.</title>
              <desc id="svgDesc3">Move to the bottom of the page.</desc>
              <g
                fill="none"
                fill-rule="evenodd"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                transform="translate(3 2)"
              >
                <circle cx="8.5" cy="8.5" r="8" />
                <path d="m5.5 9.5 3 3 3-3" />
                <path d="m8.5 12.5v-8" />
              </g>
            </svg>
            <br />
            <span id="myBtnBottom" class="panelLabel">Bottom</span>
          </button>
        </div>
      </main>
      <aside class="page-sidebar related">
        <section class="related">
          <h2>Related content</h2>
          <ul class="relUL">
            <li><a href="#">TBC</a></li>
            <li><a href="#">TBC</a></li>
            <li><a href="#">TBC</a></li>
          </ul>
        </section>
      </aside>
      <footer class="page-footer">
        <div id="RSS"><a id="rssA" href="feed.rss">RSS</a></div>
        <div id="SiteMap"><a href="siteMap.html">Site Map</a></div>
        <div id="AccessibilityFoot">
          <a href="Accessibility_Statement.html">Accessibility Statement</a>
        </div>
        <div id="twitterFoot">
          <a href="https://twitter.com/vleguru?ref_src=twsrc%5Etfw"
            >Follow on Twitter</a
          >
        </div>
        <div id="YouTubeChannelFoot">
          <a href="https://www.youtube.com/channel/UCKypjo59GE79UEjoLtzKEtQ"
            >YouTube Channel</a
          >
        </div>
        <div id="aboutCodePen">
          <a href="https://codepen.io/matthewdeeprose/">CodePen</a>
        </div>
        <p></p>
        <div id="aboutFoot">
          <a href="https://www.linkedin.com/in/mattdeeprose/"
            >&#169; Matthew Deeprose</a
          >
        </div>
      </footer>
    </div>
    <!-- Load dependencies -->
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it.min.js"></script>

    <!-- Load markdown-it plugins -->
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-sub.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-sup.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-footnote.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-deflist.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-abbr.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-emoji.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-ins.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit//markdown-it-mark.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-task-lists.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-container.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdownItAnchor.umd.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit//markdownItTocDoneRight.umd.min.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-attrs.browser.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-multimd-table.min.js"></script>
    <script
      type="module"
      src="https://matthewdeeprose.github.io/markdownit/markdown-it-tab-bridge.js"
    ></script>
    <script
      type="module"
      src="https://matthewdeeprose.github.io/markdownit/markdown-it-tab.js"
    ></script>
    <script
      type="module"
      src="https://matthewdeeprose.github.io/markdownit/markdown-it-helper.js"
    ></script>
    <script src="https://matthewdeeprose.github.io/markdownit/markdown-it-tab-handler.js"></script>
    <script src="https://matthewdeeprose.github.io/markdownit/chart.min.js"></script>
    <script src="md-scripts/charts/chart-data-manager.js"></script>
    <script src="md-scripts/charts/chart-template-manager.js"></script>
    <script src="md-scripts/charts/chart-suggestion-engine.js"></script>
    <script src="md-scripts/charts/chart-builder.js"></script>
    <script src="md-scripts/charts/chart-builder-state.js"></script>
    <script src="md-scripts/charts/chart-template-library.js"></script>
    <!-- Graph Builder Modules (load in dependency order) -->
    <script src="md-scripts/charts/graph-builder-utils.js"></script>
    <script src="md-scripts/charts/graph-builder-notifications.js"></script>
    <script src="md-scripts/charts/graph-builder-data.js"></script>
    <script src="md-scripts/charts/graph-builder-ui.js"></script>
    <script src="md-scripts/charts/graph-builder-charts.js"></script>
    <script src="md-scripts/charts/graph-builder-core.js"></script>
    <script src="md-scripts/charts/graph-builder-sizing-integration.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js"></script>

    <!-- Fix for implicit figures module -->
    <script type="module">
      import markdownItImplicitFigures from "https://matthewdeeprose.github.io/markdownit/markdown-it-implicit-figures.js";
      window.markdownitImplicitFigures = markdownItImplicitFigures;
    </script>

    <!-- Load sortable table integration for markdown-it -->
    <script src="md-scripts/markdown-utils/markdown-it-sortable-tables-combined.js"></script>

    <!-- Load our markdown editor implementation -->
    <script src="md-scripts/markdown-utils/markdown-editor.js"></script>
    <script src="md-scripts/mermaid/mermaid-theme.js"></script>
    <link rel="stylesheet" href="md-scripts/css/mermaid-theme.css" />
    <script src="md-scripts/charts/chart-view-controls.js"></script>

    <!-- MathPix -->
    <script src="mathpix-scripts/testing/mathpix-refactor-tests.js"></script>
    <script
      type="module"
      src="mathpix-scripts/testing/mathpix-pdf-testing-suite.js"
    ></script>

    <script src="mathpix-scripts/testing/mathpix-phase31-testing.js"></script>
    <script
      type="module"
      src="mathpix-scripts/testing/mathpix-final-actions-protection.js"
    ></script>
    <script
      type="module"
      src="mathpix-scripts/testing/mathpix-phase2-tests.js"
    ></script>
    <script
      type="module"
      src="mathpix-scripts/core/mathpix-latex-transformer.js"
    ></script>
    <script
      type="module"
      src="mathpix-scripts/core/mathpix-strokes-canvas.js"
    ></script>
    <script
      type="module"
      src="mathpix-scripts/core/mathpix-strokes-api-client.js"
    ></script>
    <script
      type="module"
      src="mathpix-scripts/ui/components/mathpix-mode-switcher.js"
    ></script>

    <script
      type="module"
      src="mathpix-scripts/testing/mathpix-phase32-testing.js"
    ></script>
    <!-- Phase 4: Chemistry Testing Suite -->
    <script
      type="module"
      src="mathpix-scripts/testing/mathpix-phase4-testing.js"
    ></script>

    <!-- Initialize the editor -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        MarkdownEditor.init();
      });
    </script>
    <script type="module">
      // UI Navigation Functions
      function menuAction() {
        let menuSwitch = document.getElementById("myTopnav");
        if (menuSwitch.className === "topnav") {
          menuSwitch.className += " responsive";
        } else {
          menuSwitch.className = "topnav";
        }
        let menuAriaAttrib = document
          .getElementById("menu")
          .getAttribute("aria-expanded");
        if (menuAriaAttrib === "true") {
          menuAriaAttrib = "false";
        } else {
          menuAriaAttrib = "true";
        }
        document
          .getElementById("menu")
          .setAttribute("aria-expanded", menuAriaAttrib);
      }

      // Scroll Functions
      let mybutton = document.getElementById("myBtn");
      let mybutton2 = document.getElementById("myBtn2");

      window.onscroll = function () {
        scrollFunction();
      };

      function scrollFunction() {
        if (
          document.body.scrollTop > 660 ||
          document.documentElement.scrollTop > 660
        ) {
          mybutton.style.display = "block";
          mybutton2.style.display = "block";
        } else {
          mybutton.style.display = "none";
          mybutton2.style.display = "none";
        }
      }

      function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
        document.getElementById("skipToContent").focus();
      }

      function bottomFunction() {
        window.scrollTo(0, document.body.scrollHeight);
        document.getElementById("rssA").focus();
      }

      // Theme Functions
      let themePref = localStorage.getItem("theme");
      window.AppLogging.logDebug(
        "Has a theme preference been saved?",
        themePref
      );

      function setLight() {
        let buttonStatus = document.getElementById("lightDark");
        let theButton = document.getElementById("modeToggle");
        const d = matchMedia("(prefers-color-scheme: dark)");
        let dt;
        if (d.matches) {
          dt = "dark";
          window.AppLogging.logDebug("Prefers dark theme in OS");
        } else {
          dt = "light";
          window.AppLogging.logDebug("Prefers light theme in OS");
        }
        if (dt == "dark" && themePref == "Dark") {
          theButton.setAttribute("aria-pressed", "true");
        } else if (dt == "light" && themePref == "Dark") {
          theButton.setAttribute("aria-pressed", "true");
        } else if (dt == "dark" && !themePref) {
          theButton.setAttribute("aria-pressed", "true");
        } else {
          theButton.setAttribute("aria-pressed", "false");
        }
      }
      setLight();

      function toggle(btnID) {
        let buttonStatus = document.getElementById("lightDark");
        let theButton = document.getElementById(btnID);

        if (theButton.getAttribute("aria-pressed") == "true") {
          theButton.setAttribute("aria-pressed", "false");
          document.getElementById("lightCSS").href = "light.css";
          document.getElementById("darkCSS").href = "light.css";
          window.AppLogging.logInfo("Turned on light mode");
          localStorage.setItem("theme", "Light");
          let themePref = localStorage.getItem("theme");
          window.AppLogging.logInfo("Site theme preference to ", themePref);
          document.getElementById("lightDark").innerHTML =
            "Light theme enabled, the button is now";
          let toggleButton = document.getElementById("modeToggle");
          toggleButton.removeAttribute("aria-pressed");
          toggleButton.setAttribute("aria-pressed", "false");

          window.AppLogging.logDebug(
            "[Theme Toggle Debug] Switched to Light mode, updating Mermaid diagrams"
          );
          // Update Mermaid diagrams for theme change
          if (
            window.MermaidThemes &&
            typeof window.MermaidThemes.updateDiagramsForThemeChange ===
              "function"
          ) {
            window.AppLogging.logDebug(
              "[Theme Toggle Debug] Calling updateDiagramsForThemeChange"
            );
            window.MermaidThemes.updateDiagramsForThemeChange();
          } else {
            window.AppLogging.logError(
              "[Theme Toggle Debug] ERROR: MermaidThemes is not available or updateDiagramsForThemeChange is not a function"
            );
            if (window.MermaidThemes) {
              window.AppLogging.logDebug(
                "[Theme Toggle Debug] Available methods:",
                Object.keys(window.MermaidThemes)
              );
            }
          }
        } else {
          theButton.setAttribute("aria-pressed", "true");
          document.getElementById("lightCSS").href = "dark.css";
          document.getElementById("darkCSS").href = "dark.css";
          window.AppLogging.logInfo("Turned on dark mode");
          localStorage.setItem("theme", "Dark");
          let themePref = localStorage.getItem("theme");
          window.AppLogging.logInfo("Site theme preference set to ", themePref);
          document.getElementById("lightDark").innerHTML =
            "Dark theme enabled, the button is now";
          let toggleButton = document.getElementById("modeToggle");
          toggleButton.removeAttribute("aria-pressed");
          toggleButton.setAttribute("aria-pressed", "true");

          window.AppLogging.logDebug(
            "[Theme Toggle Debug] Switched to Dark mode, updating Mermaid diagrams"
          );
          // Update Mermaid diagrams for theme change
          if (
            window.MermaidThemes &&
            typeof window.MermaidThemes.updateDiagramsForThemeChange ===
              "function"
          ) {
            window.AppLogging.logDebug(
              "[Theme Toggle Debug] Calling updateDiagramsForThemeChange"
            );
            window.MermaidThemes.updateDiagramsForThemeChange();
          } else {
            window.AppLogging.logError(
              "[Theme Toggle Debug] ERROR: MermaidThemes is not available or updateDiagramsForThemeChange is not a function"
            );
            if (window.MermaidThemes) {
              window.AppLogging.logDebug(
                "[Theme Toggle Debug] Available methods:",
                Object.keys(window.MermaidThemes)
              );
            }
          }
        }
      }

      function applyThemePreference() {
        if (themePref == "Dark") {
          let theButton = document.getElementById("modeToggle");
          document.getElementById("lightCSS").href = "dark.css";
          document.getElementById("darkCSS").href = "dark.css";
          theButton.setAttribute("aria-pressed", "true");
          window.AppLogging.logInfo(
            "Applied",
            themePref,
            "theme because site theme preference is set to",
            themePref
          );
        } else if (themePref == "Light") {
          let theButton = document.getElementById("modeToggle");
          document.getElementById("lightCSS").href = "light.css";
          document.getElementById("darkCSS").href = "light.css";
          theButton.setAttribute("aria-pressed", "false");
          window.AppLogging.logInfo(
            "Applied",
            themePref,
            "theme because site theme preference is set to",
            themePref
          );
        }
      }
      applyThemePreference();

      // Console Fallback
      window.console ||
        (window.console = {
          log: alert,
        });

      // Print Handler
      window.matchMedia("print").addEventListener("change", (evt) => {
        if (evt.matches) {
          elms = document.body.querySelectorAll("details:not([open])");
          for (e of elms) {
            e.setAttribute("open", "");
            e.dataset.wasclosed = "";
          }
        } else {
          elms = document.body.querySelectorAll("details[data-wasclosed]");
          for (e of elms) {
            e.removeAttribute("open");
            delete e.dataset.wasclosed;
          }
        }
      });

      // Make functions available globally
      window.menuAction = menuAction;
      window.topFunction = topFunction;
      window.bottomFunction = bottomFunction;
      window.toggle = toggle;
    </script>
    <script>
      // Simplified, robust MathJax configuration with interactive features
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
          processEscapes: true,
          processEnvironments: true,
          // Minimal packages - removed ams to prevent version errors
          packages: { "[+]": ["base"] },
          tags: "none", // Simplified tagging
        },
        options: {
          skipHtmlTags: ["script", "noscript", "style", "textarea", "pre"],
          enableMenu: true,
          ignoreHtmlClass: "tex2jax_ignore|mathjax_ignore",
          processHtmlClass: "tex2jax_process|mathjax_process",
          menuOptions: {
            settings: {
              zoom: "Click",
              zscale: "200%",
              assistiveMml: false, // Disabled - causes DOM conflicts
              explorer: false, // Disabled - causes replaceChild errors
            },
          },
        },
        // Minimal loader - removed problematic extensions
        loader: {
          load: ["input/tex", "output/chtml"],
        },
        chtml: {
          scale: 1.1,
          displayAlign: "center",
        },
        startup: {
          pageReady() {
            console.log(
              "🔧 MathJax startup initiated (stability-focused configuration)..."
            );

            // Delay to ensure DOM is completely stable
            return new Promise((resolve) => {
              setTimeout(() => {
                MathJax.startup
                  .defaultPageReady()
                  .then(() => {
                    console.log(
                      "✅ MathJax loaded successfully (minimal configuration)"
                    );
                    console.log(
                      "📊 Features: Click-to-zoom, right-click menus"
                    );

                    // Wait additional time before allowing rendering
                    setTimeout(() => {
                      window.MathJaxEnhancementReady = true;
                      console.log("✅ MathJax ready for rendering operations");
                      resolve();
                    }, 500);
                  })
                  .catch((error) => {
                    console.error("❌ MathJax startup error:", error);

                    // CRITICAL FIX: Set ready flag even on error
                    // Otherwise system deadlocks waiting for flag that never gets set
                    setTimeout(() => {
                      window.MathJaxEnhancementReady = true;
                      console.warn(
                        "⚠️ MathJax ready flag set despite startup error (allowing degraded operation)"
                      );
                      resolve();
                    }, 1000); // Extra delay after error for stability
                  });
              }, 300); // Initial delay for DOM stability
            });
          },
        },
      };

      console.log("🔍 MathJax configuration applied (stability-focused)");
    </script>
    <script>
      // Safety net: Force MathJaxEnhancementReady after timeout
      setTimeout(() => {
        if (!window.MathJaxEnhancementReady) {
          console.warn(
            "⚠️ MathJaxEnhancementReady timeout - forcing flag for recovery"
          );
          window.MathJaxEnhancementReady = true;
        }
      }, 20000); // 20 second absolute maximum wait
    </script>
    <script>
      // Post-MathJax enhancement handler
      document.addEventListener("DOMContentLoaded", function () {
        console.log("🚀 DOM ready - setting up MathJax enhancement monitoring");

        // Wait for MathJax to be fully loaded before setting up overrides
        function setupMathJaxEnhancements() {
          if (
            window.MathJax &&
            window.MathJax.typesetPromise &&
            typeof window.MathJax.typesetPromise === "function"
          ) {
            console.log("✅ MathJax fully loaded - setting up enhancements");

            // Initialize MathJax Manager now that MathJax is ready
            if (window.mathJaxManager && !window.mathJaxManager.isHealthy) {
              console.log(
                "🔄 Triggering MathJax Manager initialization after MathJax load..."
              );
              window.mathJaxManager.initialize(true).then((success) => {
                if (success) {
                  console.log("✅ MathJax Manager initialized successfully");
                } else {
                  console.warn("⚠️ MathJax Manager initialization failed");
                }
              });
            }

            // Store reference globally BEFORE wrapping
            // This allows mathJaxManager queue to bypass wrapper and use unwrapped version
            // which properly registers menu event handlers (contextmenu, click, keydown)
            window.originalTypesetPromise = window.MathJax.typesetPromise;

            // Keep local reference for wrapper compatibility
            const originalTypesetPromise = window.originalTypesetPromise;

            console.log(
              "✅ Original typesetPromise stored globally for menu registration"
            );

            window.MathJax.typesetPromise = function (elements) {
              // Ensure we have a valid function to call
              if (typeof originalTypesetPromise !== "function") {
                console.error(
                  "❌ Original typesetPromise is not a function:",
                  typeof originalTypesetPromise
                );
                return Promise.resolve();
              }

              return originalTypesetPromise.call(this, elements).then(() => {
                // Auto-apply enhancements after any MathJax rendering
                if (typeof window.mathPixEnhanceMathJax === "function") {
                  // If elements specified, enhance only those containers
                  const containersToEnhance = elements || [document];

                  containersToEnhance.forEach((container) => {
                    const mathElements = container.querySelectorAll(
                      "mjx-container, .MathJax"
                    );
                    mathElements.forEach((mathEl, index) => {
                      if (!mathEl.getAttribute("data-mathpix-enhanced")) {
                        // Apply individual enhancements
                        mathEl.setAttribute("data-mathpix-enhanced", "true");
                        mathEl.setAttribute("data-math-index", index);
                        mathEl.setAttribute("tabindex", "0");
                        mathEl.style.cursor = "pointer";
                        mathEl.title =
                          "Click to zoom, right-click for menu options";

                        const mathContent =
                          mathEl.getAttribute("aria-label") ||
                          mathEl.textContent.trim() ||
                          `Mathematical expression ${index + 1}`;
                        mathEl.setAttribute(
                          "aria-label",
                          `${mathContent}. Click to zoom or right-click for options.`
                        );
                      }
                    });
                  });
                }
              });
            };
          } else {
            // MathJax not ready yet, wait for it
            console.log("⏳ MathJax not ready, waiting for initialization...");

            // Check periodically until MathJax is ready
            const checkMathJaxReady = () => {
              if (
                window.MathJax &&
                window.MathJax.typesetPromise &&
                typeof window.MathJax.typesetPromise === "function"
              ) {
                setupMathJaxEnhancements();
              } else {
                setTimeout(checkMathJaxReady, 100);
              }
            };

            // Start checking after a short delay to allow MathJax to load
            setTimeout(checkMathJaxReady, 500);
          }
        }

        // Initial attempt
        setupMathJaxEnhancements();
      });
    </script>
    <!-- MathJax Loading Timeout Detection -->
    <script>
      (function () {
        const MATHJAX_TIMEOUT = 20000; // 20 seconds

        setTimeout(() => {
          if (!window.MathJax?.typesetPromise) {
            console.error("⚠️ MathJax failed to load within timeout");
            const statusDiv = document.getElementById("mathjax-status");
            if (statusDiv) {
              statusDiv.style.display = "block";

              // Auto-hide after 10 seconds if MathJax loads
              const recheckInterval = setInterval(() => {
                if (window.MathJax?.typesetPromise) {
                  statusDiv.style.display = "none";
                  clearInterval(recheckInterval);
                  console.log("✅ MathJax loaded successfully after delay");
                }
              }, 1000);
            }
          }
        }, MATHJAX_TIMEOUT);
      })();
    </script>

    <script src="https://matthewdeeprose.github.io/prism/prism.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script src="md-scripts/markdown-utils/markdown-code-copy.js"></script>
    <script src="md-scripts/mermaid/mermaid-controls.js"></script>
    <script src="md-scripts/charts/chart-controls.js"></script>
    <script src="md-scripts/mermaid/mermaid-pan-zoom.js"></script>
    <script src="md-scripts/charts/chart-statistics.js"></script>
    <script src="md-scripts/charts/chart-trends.js"></script>
    <script src="md-scripts/charts/chart-performance.js"></script>
    <script src="md-scripts/charts/chart-accessibility.js"></script>
    <script src="md-scripts/charts/chart-accessibility-export-utils.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-utils.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-export-utils.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="md-scripts/mermaid/mermaid-diagram-detection.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-common.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-core.js"></script>
    <script src="md-scripts/mermaid/mermaid-export-utils.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-pie.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-flowchart.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-flowchart-complex.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-gantt.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-state.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-mindmap.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-timeline.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-user-journey.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-sequence.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-architecture.js"></script>
    <script src="md-scripts/mermaid/mermaid-accessibility-quadrant.js"></script>

    <script>
      // Ensure MermaidPanZoom is properly initialized and globally available
      document.addEventListener("DOMContentLoaded", function () {
        window.AppLogging.logDebug(
          "DOM loaded, checking MermaidPanZoom availability"
        );
        if (typeof window.MermaidPanZoom === "undefined") {
          window.AppLogging.logWarn(
            "MermaidPanZoom not found on window object after script load"
          );
        } else {
          window.AppLogging.logDebug(
            "MermaidPanZoom is available on window object after script load"
          );
        }
      });
    </script>
    <script>
      // Add sequence numbers to Mermaid diagrams
      document.addEventListener("DOMContentLoaded", function () {
        mermaid.initialize({ sequence: { showSequenceNumbers: true } });
        window.AppLogging.logInfo(
          "Mermaid initialised with sequence numbers enabled"
        );
      });
    </script>

    <script src="md-scripts/mermaid/mermaid-view-controls.js"></script>

    <script>
      let totalSize = 0;

      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          let keySize = new Blob([key]).size; // Size of the key
          let valueSize = new Blob([localStorage[key]]).size; // Size of the value
          totalSize += keySize + valueSize;
        }
      }

      window.AppLogging.logDebug(`Total localStorage size: ${totalSize} bytes`);
      window.AppLogging.logDebug(
        `Total size in KB: ${(totalSize / 1024).toFixed(2)} KB`
      );
      window.AppLogging.logDebug(
        `Total size in MB: ${(totalSize / (1024 * 1024)).toFixed(2)} MB`
      );
    </script>
    <script>
      // Enable debug mode
      if (window.ChartAccessibility && window.ChartAccessibility.config) {
        window.ChartAccessibility.config.debug = true;
        window.AppLogging.logInfo("Chart Accessibility debug mode enabled");

        // Show loaded modules confirmation
        window.AppLogging.logDebug("Modules loaded:", {
          Statistics: !!window.ChartStatistics,
          Trends: !!window.ChartTrends,
          Performance: !!window.ChartPerformance,
        });
      }
    </script>
    <script>
      function showOpenRouter(isUserInitiated = true) {
        const graphBuilder = document.getElementById("graph-builder");
        const markdownConverter = document.getElementById("markdown-converter");
        const openrouterApp = document.getElementById("openrouter-app");
        const mathPixApp = document.getElementById("mathpix-app");
        const announcer = document.getElementById("radioSRannounce");

        if (graphBuilder) graphBuilder.style.display = "none";
        if (markdownConverter) markdownConverter.style.display = "none";
        if (mathPixApp) mathPixApp.style.display = "none"; // Hide MathPix

        if (openrouterApp) openrouterApp.style.display = "block";

        if (isUserInitiated && announcer) {
          announcer.textContent = "Switched to OpenRouter AI tool";
          setTimeout(() => (announcer.textContent = ""), 1000);
        }
      }

      function showMkdEd(isUserInitiated = true) {
        const graphBuilder = document.getElementById("graph-builder");
        const markdownConverter = document.getElementById("markdown-converter");
        const openrouterApp = document.getElementById("openrouter-app");
        const mathPixApp = document.getElementById("mathpix-app");
        const announcer = document.getElementById("radioSRannounce");

        if (graphBuilder) graphBuilder.style.display = "none";
        if (openrouterApp) openrouterApp.style.display = "none";
        if (mathPixApp) mathPixApp.style.display = "none"; // Hide MathPix

        if (markdownConverter) markdownConverter.style.display = "block";

        if (
          window.MarkdownEditor &&
          typeof window.MarkdownEditor.init === "function"
        ) {
          setTimeout(() => {
            const success = window.MarkdownEditor.init();
            if (!success) {
              window.AppLogging.logError(
                "Markdown Editor initialisation failed"
              );
            }
          }, 200);
        }

        if (isUserInitiated && announcer) {
          announcer.textContent = "Switched to Markdown Editor tool";
          setTimeout(() => (announcer.textContent = ""), 1000);
        }
      }

      function showGrhBld(isUserInitiated = true) {
        const graphBuilder = document.getElementById("graph-builder");
        const openrouterApp = document.getElementById("openrouter-app");
        const markdownConverter = document.getElementById("markdown-converter");
        const mathPixApp = document.getElementById("mathpix-app");
        const announcer = document.getElementById("radioSRannounce");

        if (markdownConverter) markdownConverter.style.display = "none";
        if (openrouterApp) openrouterApp.style.display = "none";
        if (mathPixApp) mathPixApp.style.display = "none"; // Hide MathPix

        if (graphBuilder) graphBuilder.style.display = "block";

        if (
          window.GraphBuilder &&
          typeof window.GraphBuilder.init === "function"
        ) {
          setTimeout(() => {
            window.AppLogging.logDebug("[UI] Initialising Graph Builder...");
            const success = window.GraphBuilder.init();
            if (!success) {
              window.AppLogging.logError(
                "[UI] Graph Builder initialisation failed"
              );
              if (isUserInitiated && announcer) {
                announcer.textContent =
                  "Error: Graph Builder failed to initialise";
              }
            }
          }, 200);
        } else {
          window.AppLogging.logError("[UI] GraphBuilder not available");
          if (isUserInitiated && announcer) {
            announcer.textContent = "Error: Graph Builder not available";
          }
        }

        if (isUserInitiated && announcer) {
          announcer.textContent = "Switched to Graph Builder tool";
          setTimeout(() => (announcer.textContent = ""), 1000);
        }
      }

      async function showMathPix(isUserInitiated = true) {
        const graphBuilder = document.getElementById("graph-builder");
        const markdownConverter = document.getElementById("markdown-converter");
        const openrouterApp = document.getElementById("openrouter-app");
        const mathPixApp = document.getElementById("mathpix-app");
        const announcer = document.getElementById("radioSRannounce");

        if (graphBuilder) graphBuilder.style.display = "none";
        if (markdownConverter) markdownConverter.style.display = "none";
        if (openrouterApp) openrouterApp.style.display = "none";

        if (mathPixApp) mathPixApp.style.display = "block";

        setTimeout(async () => {
          try {
            // Load MathPix main controller
            const mathPixModule = await import(
              "./mathpix-scripts/ui/mathpix-main-controller.js"
            );
            const success = mathPixModule.initMathPix();

            if (!success) {
              console.error("MathPix initialisation failed");
              if (isUserInitiated && announcer) {
                announcer.textContent = "Error: MathPix failed to initialise";
                setTimeout(() => (announcer.textContent = ""), 3000);
              }
              return; // Exit early if main init failed
            }

            console.log("MathPix initialised successfully");
            window.getMathPixController = mathPixModule.getMathPixController;

            // Phase 3.4: Load PDF preview modules
            try {
              const [{ PDFUploadVerification }, { PDFPreviewAccessibility }] =
                await Promise.all([
                  import(
                    "./mathpix-scripts/pdf-preview/pdf-preview-upload-verification.js"
                  ),
                  import(
                    "./mathpix-scripts/pdf-preview/pdf-preview-accessibility.js"
                  ),
                ]);

              // Make modules globally available for testing
              window.PDFUploadVerification = PDFUploadVerification;
              window.PDFPreviewAccessibility = PDFPreviewAccessibility;

              // Initialize global accessibility system if not already present
              if (!window.mathpixAccessibility) {
                window.mathpixAccessibility = new PDFPreviewAccessibility();
                console.log(
                  "Phase 3.4: PDF preview accessibility system initialised"
                );
              }

              console.log("Phase 3.4: PDF preview modules loaded successfully");
            } catch (previewError) {
              console.warn(
                "Phase 3.4: Failed to load PDF preview modules (non-critical)",
                previewError
              );
              // Don't fail the entire MathPix system if preview modules fail to load
              // The system can still work without the preview feature
            }
          } catch (error) {
            console.error("MathPix initialisation error:", error);
            if (isUserInitiated && announcer) {
              announcer.textContent = "Error: MathPix module failed to load";
              setTimeout(() => (announcer.textContent = ""), 3000);
            }
          }
        }, 200);

        if (isUserInitiated && announcer) {
          announcer.textContent = "Switched to MathPix Mathematics OCR tool";
          setTimeout(() => (announcer.textContent = ""), 1000);
        }
      }

      window.showOpenRouter = showOpenRouter;
      window.showMkdEd = showMkdEd;
      window.showGrhBld = showGrhBld;
      window.showMathPix = showMathPix;

      function initializeToolVisibility() {
        const checkedRadio = document.querySelector(
          'input[name="presentation"]:checked'
        );
        if (!checkedRadio) {
          showOpenRouter();
          return;
        }
        switch (checkedRadio.value) {
          case "OpenRouter":
            showOpenRouter();
            break;
          case "Markdown Editor":
            showMkdEd();
            break;
          case "Graph Builder":
            showGrhBld();
            break;
          case "MathPix":
            showMathPix();
            break;
          default:
            showOpenRouter();
        }
      }

      document.addEventListener("DOMContentLoaded", initializeToolVisibility);
      if (document.readyState !== "loading") {
        initializeToolVisibility();
      }
    </script>

    <script src="js/browser-dependency-tracker.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          window.AppLogging.logInfo("Starting dependency analysis...");
          const tracker = new DependencyTracker();
          const report = await tracker.scanScripts();
          tracker.displayReport(report);
          window.AppLogging.logInfo("✓ Initial dependency analysis complete!");
        } catch (error) {
          window.AppLogging.logError("❌ Error in dependency analysis:", error);
          const reportDiv = document.getElementById(
            "dependency-report-container"
          );
          if (reportDiv) {
            reportDiv.innerHTML = `
              <div class="error-message" role="alert">
                <h3>Error Analyzing Dependencies</h3>
                <p>${error.message}</p>
                <details>
                  <summary>Technical Details</summary>
                  <pre>${error.stack}</pre>
                </details>
              </div>
            `;
          }
        }
      });
    </script>
    <script>
      /**
       * Bridge Initialisation Forcer
       * Add this script to ensure MarkdownEditor is available before the system initialises
       *
       * Add this to your boilerplate.html BEFORE the main.js import
       */

      // Force Bridge Availability Script

      // Bridge Initialisation Forcer
      (function () {
        window.AppLogging.logDebug(
          "🔍 [BRIDGE DEBUG] 🚀 ENHANCED BRIDGE FORCER: Starting comprehensive initialisation..."
        );

        // Set localStorage to force bridge mode
        localStorage.setItem("use-markdownit-bridge", "true");

        // Log environment status
        window.AppLogging.logDebug("🔍 [BRIDGE DEBUG] 📊 ENVIRONMENT CHECK:", {
          timestamp: new Date().toISOString(),
          documentReady: document.readyState,
          markdownItAvailable: typeof window.markdownit !== "undefined",
          markdownEditorExists: typeof window.MarkdownEditor !== "undefined",
          taskListsPluginExists:
            typeof window.markdownitTaskLists !== "undefined",
          sortableTablesExists:
            typeof window.sortableTablesEnhanced !== "undefined",
          localStorage: localStorage.getItem("use-markdownit-bridge"),
          urlParams: new URLSearchParams(window.location.search).has(
            "use-markdownit-bridge"
          ),
        });

        // Create enhanced MarkdownEditor object if needed
        if (typeof window.MarkdownEditor === "undefined") {
          window.AppLogging.logDebug(
            "🔍 [BRIDGE DEBUG] 🔧 CREATING MarkdownEditor object..."
          );

          window.MarkdownEditor = {
            init: function () {
              window.AppLogging.logDebug(
                "🔍 [BRIDGE DEBUG] 📝 MarkdownEditor.init() called via bridge forcer"
              );
              return true;
            },

            render: function (content) {
              window.AppLogging.logDebug(
                "🔍 [BRIDGE DEBUG] 📝 MarkdownEditor.render() called:",
                {
                  contentLength: content?.length || 0,
                  contentPreview: content?.substring(0, 100) + "...",
                  containsTable: content?.includes("|") || false,
                  containsTaskList: content?.includes("- [") || false,
                  markdownItReady: typeof window.markdownit !== "undefined",
                  callStack: new Error().stack
                    .split("\n")
                    .slice(1, 4)
                    .map((line) => line.trim()),
                }
              );

              if (typeof window.markdownit === "undefined") {
                window.AppLogging.logError(
                  "🔍 [BRIDGE DEBUG] ❌ markdown-it not available, using fallback"
                );
                return content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
              }

              try {
                // Create markdown-it instance with comprehensive configuration
                const md = window.markdownit({
                  html: true,
                  breaks: true,
                  linkify: true,
                  typographer: true,
                  highlight: function (str, lang) {
                    if (lang && window.Prism && window.Prism.languages[lang]) {
                      try {
                        return (
                          '<pre class="language-' +
                          lang +
                          '"><code>' +
                          window.Prism.highlight(
                            str,
                            window.Prism.languages[lang],
                            lang
                          ) +
                          "</code></pre>"
                        );
                      } catch (err) {
                        window.AppLogging.logWarn(
                          "🔍 [BRIDGE DEBUG] ⚠️ Syntax highlighting failed for",
                          lang
                        );
                      }
                    }
                    return (
                      '<pre class="language-none"><code>' +
                      md.utils.escapeHtml(str) +
                      "</code></pre>"
                    );
                  },
                });

                // Enable tables
                md.enable("table");
                window.AppLogging.logDebug(
                  "🔍 [BRIDGE DEBUG] ✅ Table feature enabled"
                );

                // Add task lists plugin if available
                if (window.markdownitTaskLists) {
                  md.use(window.markdownitTaskLists);
                  window.AppLogging.logDebug(
                    "🔍 [BRIDGE DEBUG] ✅ Task lists plugin added"
                  );
                } else {
                  window.AppLogging.logWarn(
                    "🔍 [BRIDGE DEBUG] ⚠️ Task lists plugin not available"
                  );
                }

                // Add sortable tables if available
                if (
                  window.sortableTablesEnhanced &&
                  window.sortableTablesEnhanced.markdownItPlugin
                ) {
                  md.use(window.sortableTablesEnhanced.markdownItPlugin);
                  window.AppLogging.logDebug(
                    "🔍 [BRIDGE DEBUG] ✅ Sortable tables plugin added"
                  );
                } else {
                  window.AppLogging.logWarn(
                    "🔍 [BRIDGE DEBUG] ⚠️ Sortable tables plugin not available"
                  );
                }

                // Process the content
                const result = md.render(content);

                window.AppLogging.logDebug(
                  "🔍 [BRIDGE DEBUG] ✅ MarkdownEditor.render() SUCCESS:",
                  {
                    inputLength: content.length,
                    outputLength: result.length,
                    processingResults: {
                      containsTableTags: result.includes("<table>"),
                      containsTaskListInputs: result.includes(
                        "task-list-item-checkbox"
                      ),
                      containsCodeBlocks: result.includes(
                        '<pre class="language-'
                      ),
                      containsParagraphs: result.includes("<p>"),
                    },
                    outputPreview: result.substring(0, 200) + "...",
                  }
                );

                return result;
              } catch (error) {
                window.AppLogging.logError(
                  "🔍 [BRIDGE DEBUG] ❌ MarkdownEditor.render() ERROR:",
                  {
                    error: error.message,
                    stack: error.stack,
                    contentLength: content?.length || 0,
                  }
                );
                return content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
              }
            },

            clear: function () {
              window.AppLogging.logDebug(
                "🔍 [BRIDGE DEBUG] 📝 MarkdownEditor.clear() called"
              );
            },
          };

          window.AppLogging.logDebug(
            "🔍 [BRIDGE DEBUG] ✅ MarkdownEditor object created successfully"
          );
        } else {
          window.AppLogging.logDebug(
            "🔍 [BRIDGE DEBUG] ✅ MarkdownEditor already exists, testing render function..."
          );

          // Test the existing MarkdownEditor
          if (typeof window.MarkdownEditor.render === "function") {
            try {
              const testResult = window.MarkdownEditor.render(
                "- [x] Test task\n\n| Col1 | Col2 |\n|------|------|\n| A | B |"
              );
              window.AppLogging.logDebug(
                "🔍 [BRIDGE DEBUG] ✅ Existing MarkdownEditor test successful:",
                {
                  resultLength: testResult.length,
                  containsTable: testResult.includes("<table>"),
                  containsTaskList: testResult.includes("checkbox"),
                }
              );
            } catch (error) {
              window.AppLogging.logError(
                "🔍 [BRIDGE DEBUG] ❌ Existing MarkdownEditor test failed:",
                error
              );
            }
          }
        }

        // Verify final bridge setup
        window.AppLogging.logDebug("🔍 [BRIDGE DEBUG] 🔍 FINAL VERIFICATION:", {
          markdownEditorReady: typeof window.MarkdownEditor !== "undefined",
          hasInit: typeof window.MarkdownEditor?.init === "function",
          hasRender: typeof window.MarkdownEditor?.render === "function",
          hasClear: typeof window.MarkdownEditor?.clear === "function",
          bridgeForced:
            localStorage.getItem("use-markdownit-bridge") === "true",
          readyToProcess:
            typeof window.MarkdownEditor?.render === "function" &&
            typeof window.markdownit !== "undefined",
        });

        // Set a global flag to indicate bridge forcer has run
        window.BRIDGE_FORCER_COMPLETE = true;
        window.AppLogging.logInfo(
          "🔍 [BRIDGE DEBUG] 🎯 BRIDGE FORCER COMPLETE - System ready for bridge processing"
        );
      })();
    </script>
    <script>
      // Debug toggle for markdown processing
      function toggleMarkdownProcessor() {
        const current =
          localStorage.getItem("use-markdownit-bridge") === "true";
        const newValue = !current;
        localStorage.setItem("use-markdownit-bridge", newValue);
        window.AppLogging.logInfo(
          `Markdown processor switched to: ${
            newValue ? "MarkdownIt Bridge" : "Legacy Processors"
          }`
        );

        // Show user feedback
        const message = `Using ${
          newValue ? "MarkdownIt Bridge" : "Legacy Processors"
        }. Refresh to see changes.`;
        alert(message);
      }

      // Add to window for easy access from console
      window.toggleMarkdownProcessor = toggleMarkdownProcessor;

      // Log current state
      window.AppLogging.logDebug("Markdown processor status:", {
        useMarkdownItBridge:
          localStorage.getItem("use-markdownit-bridge") === "true",
        markdownEditorAvailable: typeof window.MarkdownEditor !== "undefined",
      });
    </script>
    <script type="module" src="js/main.js" crossorigin="anonymous"></script>
    <script type="module" src="js/tests.js" crossorigin="anonymous"></script>
    <script>
      document
        .getElementById("temperature")
        .addEventListener("input", function (e) {
          document.getElementById("temp-output").textContent = e.target.value;
        });
    </script>
    <script src="js/enhanced-model-selection.js"></script>
    <script>
      // Enhanced Model Selection Initialization Script - Updated for Reliability System
      // Now uses the new initWithEnhancedReliability method from enhanced-model-selection.js

      document.addEventListener("DOMContentLoaded", function () {
        window.AppLogging.logInfo(
          "[EnhancedModelSelection] 🚀 DOM ready, starting enhanced initialisation process..."
        );

        // Check if Enhanced Model Selection is available
        if (typeof EnhancedModelSelection === "undefined") {
          window.AppLogging.logError(
            "[EnhancedModelSelection] ❌ EnhancedModelSelection not found - ensure enhanced-model-selection.js is loaded"
          );
          return;
        }

        // Use the new enhanced reliability system
        if (EnhancedModelSelection.initWithEnhancedReliability) {
          window.AppLogging.logInfo(
            "[EnhancedModelSelection] ✅ Using new enhanced reliability initialisation system"
          );

          try {
            const success =
              EnhancedModelSelection.initWithEnhancedReliability();
            if (success) {
              window.AppLogging.logInfo(
                "[EnhancedModelSelection] 🎉 Immediate initialisation successful via enhanced reliability system!"
              );
            } else {
              window.AppLogging.logInfo(
                "[EnhancedModelSelection] ⏳ Enhanced reliability system activated - will initialise when models are ready"
              );
            }
          } catch (error) {
            window.AppLogging.logError(
              "[EnhancedModelSelection] ❌ Error with enhanced reliability system:",
              error
            );

            // Fallback to basic initialization
            window.AppLogging.logInfo(
              "[EnhancedModelSelection] 🔄 Falling back to basic initialisation..."
            );
            setTimeout(() => {
              try {
                EnhancedModelSelection.init();
              } catch (fallbackError) {
                window.AppLogging.logError(
                  "[EnhancedModelSelection] ❌ Fallback initialisation also failed:",
                  fallbackError
                );
              }
            }, 2000);
          }
        } else {
          // Fallback for older versions without enhanced reliability
          window.AppLogging.logWarn(
            "[EnhancedModelSelection] ⚠️ Enhanced reliability method not available, using basic initialisation"
          );

          setTimeout(() => {
            try {
              const success = EnhancedModelSelection.init();
              if (success) {
                window.AppLogging.logInfo(
                  "[EnhancedModelSelection] ✅ Basic initialisation successful"
                );
              } else {
                window.AppLogging.logWarn(
                  "[EnhancedModelSelection] ❌ Basic initialisation failed"
                );
              }
            } catch (error) {
              window.AppLogging.logError(
                "[EnhancedModelSelection] ❌ Basic initialisation error:",
                error
              );
            }
          }, 3000);
        }

        window.AppLogging.logInfo(
          "[EnhancedModelSelection] 🎯 Enhanced initialisation system started"
        );
      });

      // ============================================================================
      // ENHANCED DEBUG AND MANUAL INITIALISATION FUNCTIONS
      // ============================================================================

      // Enhanced manual initialization for testing
      window.forceEnhancedModelSelectionInit = function () {
        window.AppLogging.logDebug(
          "[EnhancedModelSelection] 🔧 Manual enhanced initialisation..."
        );

        const modelSelect = document.getElementById("model-select");
        window.AppLogging.logDebug("Current select state:", {
          exists: !!modelSelect,
          optionCount: modelSelect ? modelSelect.options.length : 0,
          optgroupCount: modelSelect
            ? modelSelect.querySelectorAll("optgroup").length
            : 0,
          hasContent: modelSelect
            ? Array.from(modelSelect.options).some(
                (opt) => opt.value && opt.textContent.includes("(")
              )
            : false,
        });

        let result = false;

        // Try enhanced reliability first
        if (EnhancedModelSelection.initWithEnhancedReliability) {
          window.AppLogging.logDebug(
            "Trying enhanced reliability initialisation..."
          );
          result = EnhancedModelSelection.initWithEnhancedReliability();
        }

        // Fallback to basic init if enhanced not available or failed
        if (!result) {
          window.AppLogging.logDebug("Trying basic initialisation...");
          result = EnhancedModelSelection.init();
        }

        window.AppLogging.logDebug("Manual init result:", result);

        if (result) {
          window.AppLogging.logDebug("✅ Manual initialisation successful!");

          // Test the filtering immediately
          setTimeout(() => {
            window.AppLogging.logDebug(
              "🧪 Running post-initialisation tests..."
            );

            // Test free filter
            const freeCheckbox = document.getElementById("filter-free-only");
            if (freeCheckbox) {
              freeCheckbox.checked = true;
              freeCheckbox.dispatchEvent(new Event("change"));
              window.AppLogging.logDebug("✅ Free filter test triggered");
            }

            // Reset filter
            setTimeout(() => {
              if (freeCheckbox) {
                freeCheckbox.checked = false;
                freeCheckbox.dispatchEvent(new Event("change"));
                window.AppLogging.logDebug("✅ Filter reset");
              }
            }, 1000);
          }, 100);
        }

        return result;
      };

      // Enhanced status checker
      window.checkEnhancedModelSelectionStatus = function () {
        window.AppLogging.logDebug("=== Enhanced Model Selection Status ===");

        if (typeof EnhancedModelSelection === "undefined") {
          window.AppLogging.logDebug("❌ EnhancedModelSelection not available");
          return { available: false };
        }

        const debugInfo = EnhancedModelSelection.debugInfo();
        window.AppLogging.logDebug("Debug Info:", debugInfo);

        const modelSelect = document.getElementById("model-select");
        const detailedStatus = {
          available: true,
          enhancedReliabilityAvailable:
            typeof EnhancedModelSelection.initWithEnhancedReliability ===
            "function",
          initialisation: {
            isInitialised: EnhancedModelSelection.isInitialised(),
            canInitialise: !!modelSelect && modelSelect.options.length > 50,
          },
          domElements: {
            modelSelect: !!modelSelect,
            optionCount: modelSelect ? modelSelect.options.length : 0,
            optgroupCount: modelSelect
              ? modelSelect.querySelectorAll("optgroup").length
              : 0,
            filterElements: {
              searchInput: !!document.getElementById("model-search"),
              freeCheckbox: !!document.getElementById("filter-free-only"),
              providerSelect: !!document.getElementById("provider-select"),
              disclosure: !!document.getElementById("model-filters-disclosure"),
            },
          },
          functionality: {
            modelsLoaded: debugInfo.modelCount > 0,
            freeModelsDetected: debugInfo.freeModels > 0,
            registryAccess: debugInfo.hasModelRegistry,
          },
        };

        window.AppLogging.logDebug("Detailed Status:", detailedStatus);

        // Provide recommendations
        if (
          !detailedStatus.initialisation.isInitialised &&
          detailedStatus.initialisation.canInitialise
        ) {
          window.AppLogging.logDebug(
            "💡 Recommendation: Run forceEnhancedModelSelectionInit() to initialise manually"
          );
        } else if (detailedStatus.initialisation.isInitialised) {
          window.AppLogging.logDebug(
            "✅ System is fully initialised and ready!"
          );
        } else {
          window.AppLogging.logDebug(
            "⚠️ System not ready - ModelManager may still be populating models"
          );
        }

        return detailedStatus;
      };

      // Enhanced debugging function
      window.debugEnhancedModelSelection = function () {
        window.AppLogging.logDebug(
          "=== Enhanced Model Selection Debug Info ==="
        );

        if (typeof EnhancedModelSelection === "undefined") {
          window.AppLogging.logDebug("❌ EnhancedModelSelection not available");
          return { available: false };
        }

        const debugInfo = EnhancedModelSelection.debugInfo();
        window.AppLogging.logDebug("Debug Info:", debugInfo);

        // Additional debugging
        const modelSelect = document.getElementById("model-select");
        window.AppLogging.logDebug("Model Select Element:", {
          exists: !!modelSelect,
          optionCount: modelSelect ? modelSelect.options.length : 0,
          hasOptgroups: modelSelect
            ? modelSelect.querySelectorAll("optgroup").length
            : 0,
          value: modelSelect ? modelSelect.value : null,
          innerHTML: modelSelect
            ? modelSelect.innerHTML.substring(0, 200) + "..."
            : null,
        });

        // Check for global objects
        window.AppLogging.logDebug("Global Objects:", {
          modelRegistry: !!window.modelRegistry,
          uiController: !!window.uiController,
          modelManager: !!window.modelManager,
          uiControllerModelManager: !!(
            window.uiController && window.uiController.modelManager
          ),
        });

        // Test free model detection
        try {
          const allModels = EnhancedModelSelection.getAllModels();
          const freeModels = allModels.filter((m) => m.isFree);
          window.AppLogging.logDebug("Free Model Detection:", {
            totalModels: allModels.length,
            freeModels: freeModels.length,
            freeModelSamples: freeModels
              .slice(0, 5)
              .map((m) => `${m.name} (${m.provider})`),
          });
        } catch (error) {
          window.AppLogging.logDebug(
            "Cannot access model data - system may not be initialised:",
            error.message
          );
        }

        return debugInfo;
      };

      // Test functionality
      window.testEnhancedModelSelection = function () {
        window.AppLogging.logDebug(
          "[EnhancedModelSelection] 🧪 Running test..."
        );

        if (typeof EnhancedModelSelection === "undefined") {
          window.AppLogging.logDebug("❌ EnhancedModelSelection not available");
          return false;
        }

        if (!EnhancedModelSelection.isInitialised()) {
          window.AppLogging.logDebug("❌ Not initialised yet");
          return false;
        }

        try {
          const allModels = EnhancedModelSelection.getAllModels();
          const filteredModels = EnhancedModelSelection.getFilteredModels();
          const freeModels = allModels.filter((m) => m.isFree);

          window.AppLogging.logDebug("✅ Test Results:", {
            totalModels: allModels.length,
            filteredModels: filteredModels.length,
            freeModels: freeModels.length,
            sampleModels: allModels
              .slice(0, 3)
              .map((m) => `${m.name} (${m.provider})`),
            sampleFreeModels: freeModels
              .slice(0, 3)
              .map((m) => `${m.name} (${m.provider})`),
            isWorking: allModels.length > 0,
          });

          return allModels.length > 0;
        } catch (error) {
          window.AppLogging.logError("❌ Test failed:", error);
          return false;
        }
      };

      // Test free model filter
      window.testFreeModelFilter = function () {
        window.AppLogging.logDebug(
          "[EnhancedModelSelection] 🧪 Testing free model filter..."
        );

        if (!EnhancedModelSelection.isInitialised()) {
          window.AppLogging.logDebug("❌ System not initialised");
          return false;
        }

        try {
          const beforeFilters =
            EnhancedModelSelection.getFilteredModels().length;

          // Enable free only filter
          const freeCheckbox = document.getElementById("filter-free-only");
          if (freeCheckbox) {
            freeCheckbox.checked = true;
            freeCheckbox.dispatchEvent(new Event("change"));

            setTimeout(() => {
              const afterFilters =
                EnhancedModelSelection.getFilteredModels().length;
              const modelSelect = document.getElementById("model-select");

              window.AppLogging.logDebug("Free Filter Test Results:", {
                beforeFiltering: beforeFilters,
                afterFiltering: afterFilters,
                selectOptionCount: modelSelect ? modelSelect.options.length : 0,
                filterWorking: afterFilters < beforeFilters,
                selectUpdated: modelSelect
                  ? modelSelect.options.length <= afterFilters + 1
                  : false, // +1 for placeholder
              });
            }, 100);
          } else {
            window.AppLogging.logDebug("❌ Free model checkbox not found");
            return false;
          }
        } catch (error) {
          window.AppLogging.logError("❌ Free filter test failed:", error);
          return false;
        }

        return true;
      };

      // Test disabled model exclusion
      window.testDisabledModelsExclusion = function () {
        window.AppLogging.logDebug("🚫 Testing disabled model exclusion...");

        if (typeof EnhancedModelSelection === "undefined") {
          window.AppLogging.logDebug("❌ EnhancedModelSelection not available");
          return false;
        }

        if (!EnhancedModelSelection.isInitialised()) {
          window.AppLogging.logDebug(
            "❌ Enhanced Model Selection not initialised yet"
          );
          return false;
        }

        try {
          const results = EnhancedModelSelection.testDisabledModelsExclusion();

          window.AppLogging.logDebug(
            "📊 Disabled Model Exclusion Test Results:",
            {
              totalRegistryModels: results.totalRegistryModels,
              disabledInRegistry: results.disabledInRegistry,
              enhancedModelsShown: results.enhancedModelsShown,
              expectedShown: results.expectedShown,
              correctExclusion: results.correctExclusion
                ? "✅ Perfect"
                : "❌ Failed",
              exclusionStatus: results.status,
            }
          );

          if (results.disabledInRegistry > 0) {
            window.AppLogging.logDebug(
              `🚫 ${results.disabledInRegistry} disabled models correctly excluded from selection`
            );
          } else {
            window.AppLogging.logDebug(
              "ℹ️ No disabled models found in registry"
            );
          }

          return results.exclusionWorking;
        } catch (error) {
          window.AppLogging.logError(
            "❌ Disabled exclusion test failed:",
            error
          );
          return false;
        }
      };

      // Test enhanced reliability system
      window.testEnhancedReliabilitySystem = function () {
        window.AppLogging.logDebug("🔧 Testing Enhanced Reliability System...");

        if (typeof EnhancedModelSelection === "undefined") {
          window.AppLogging.logDebug("❌ EnhancedModelSelection not available");
          return false;
        }

        window.AppLogging.logDebug("System Capabilities:", {
          hasBasicInit: typeof EnhancedModelSelection.init === "function",
          hasEnhancedReliability:
            typeof EnhancedModelSelection.initWithEnhancedReliability ===
            "function",
          hasRetryInit:
            typeof EnhancedModelSelection.initWithRetry === "function",
          currentlyInitialised: EnhancedModelSelection.isInitialised(),
        });

        // Test the enhanced reliability system if available
        if (EnhancedModelSelection.initWithEnhancedReliability) {
          window.AppLogging.logDebug(
            "✅ Enhanced reliability system is available"
          );

          if (!EnhancedModelSelection.isInitialised()) {
            window.AppLogging.logDebug(
              "🔄 Testing enhanced reliability initialisation..."
            );
            const result = EnhancedModelSelection.initWithEnhancedReliability();
            window.AppLogging.logDebug("Enhanced reliability result:", result);
            return result;
          } else {
            window.AppLogging.logDebug(
              "✅ System already initialised via enhanced reliability"
            );
            return true;
          }
        } else {
          window.AppLogging.logWarn(
            "⚠️ Enhanced reliability system not available"
          );
          return false;
        }
      };
    </script>

    <script src="js/universal-modal.js"></script>

    <!-- OpenRouter API Configuration Management -->
    <script>
      (function initOpenRouterConfig() {
        // Wait for DOM to be ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initConfig);
        } else {
          initConfig();
        }

        function initConfig() {
          const keyInput = document.getElementById("openrouter-api-key");
          const saveBtn = document.getElementById("openrouter-save-config");
          const clearBtn = document.getElementById("openrouter-clear-config");
          const toggleBtn = document.getElementById(
            "openrouter-toggle-visibility"
          );
          const statusDiv = document.getElementById("openrouter-config-status");

          if (!keyInput || !saveBtn || !clearBtn || !toggleBtn || !statusDiv) {
            console.warn("[Config] OpenRouter config elements not found");
            return;
          }

          // Listen for InputHandler becoming ready (event-driven coordination)
          window.addEventListener("inputhandler-ready", function (event) {
            console.log(
              "[Config] InputHandler ready, synchronising button state"
            );
            checkApiKeyStatus();
          });

          // Load existing key on page load
          loadStoredKey();

          // Save configuration
          saveBtn.addEventListener("click", saveConfig);

          // Clear configuration
          clearBtn.addEventListener("click", clearConfig);

          // Toggle visibility
          toggleBtn.addEventListener("click", toggleVisibility);

          // Allow Enter key to save
          keyInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              saveConfig();
            }
          });

          function loadStoredKey() {
            const storedKey = localStorage.getItem("openrouter_api_key");
            if (storedKey) {
              keyInput.value = storedKey;
              showStatus("API key loaded from storage", "success");
            }
          }

          function saveConfig() {
            const apiKey = keyInput.value.trim();

            if (!apiKey) {
              showStatus("Please enter an API key", "error");
              keyInput.focus();
              return;
            }

            // Basic validation for OpenRouter key format
            if (!apiKey.startsWith("sk-or-v1-")) {
              showStatus(
                'Warning: API key should start with "sk-or-v1-"',
                "warning"
              );
            }

            try {
              localStorage.setItem("openrouter_api_key", apiKey);
              showStatus(
                "API key saved successfully! The application is now ready to use.",
                "success"
              );

              // Update button state immediately (no refresh needed)
              checkApiKeyStatus();

              // Announce to screen readers
              const announcer = document.getElementById("radioSRannounce");
              if (announcer) {
                announcer.textContent =
                  "API key saved successfully, application ready";
                setTimeout(() => (announcer.textContent = ""), 3000);
              }
            } catch (error) {
              showStatus("Failed to save API key: " + error.message, "error");
              console.error("[Config] Save error:", error);
            }
          }

          function clearConfig() {
            if (
              confirm(
                "Are you sure you want to clear the stored API key? You will need to configure a new key to use the application."
              )
            ) {
              try {
                localStorage.removeItem("openrouter_api_key");
                keyInput.value = "";
                showStatus(
                  "API key cleared. Please enter a new key to continue using the application.",
                  "success"
                );

                // Update button state immediately (no refresh needed)
                checkApiKeyStatus();

                // Announce to screen readers
                const announcer = document.getElementById("radioSRannounce");
                if (announcer) {
                  announcer.textContent =
                    "API key cleared, configuration required";
                  setTimeout(() => (announcer.textContent = ""), 3000);
                }
              } catch (error) {
                showStatus(
                  "Failed to clear API key: " + error.message,
                  "error"
                );
                console.error("[Config] Clear error:", error);
              }
            }
          }

          function toggleVisibility() {
            const isPassword = keyInput.type === "password";
            keyInput.type = isPassword ? "text" : "password";
            toggleBtn.setAttribute(
              "aria-label",
              isPassword ? "Hide API key" : "Show API key"
            );
            toggleBtn.title = isPassword ? "Hide API key" : "Show API key";
          }

          function showStatus(message, type = "info") {
            statusDiv.textContent = message;
            statusDiv.className = "config-status config-status-" + type;

            // Clear status after 5 seconds for non-error messages
            if (type !== "error") {
              setTimeout(() => {
                statusDiv.textContent = "";
                statusDiv.className = "config-status";
              }, 5000);
            }
          }

          /**
           * Check if API key is configured and update UI accordingly
           */
          function checkApiKeyStatus() {
            const notice = document.getElementById(
              "openrouter-api-required-notice"
            );
            const processBtn = document.getElementById("process-btn");
            const storedKey = localStorage.getItem("openrouter_api_key");
            const hasValidKey = storedKey && storedKey.trim();

            // Update notice visibility
            if (notice) {
              if (!hasValidKey) {
                notice.style.display = "block";
                // Auto-open the configuration section
                const configDetails = document.getElementById(
                  "openrouter-api-config"
                );
                if (configDetails) {
                  configDetails.open = true;
                }
              } else {
                notice.style.display = "none";
              }
            }

            // Update process button state and text
            if (processBtn) {
              updateProcessButtonState(processBtn, hasValidKey);
            }
          }

          /**
           * Update process button based on API key availability
           * @param {HTMLElement} button - The process button element
           * @param {boolean} hasKey - Whether a valid API key exists
           */
          function updateProcessButtonState(button, hasKey) {
            if (hasKey) {
              // API key is configured - restore normal button text
              button.textContent = "Process with AI";

              // Remove API key warning from aria-label
              // InputHandler will set appropriate aria-label based on text presence
              button.removeAttribute("aria-label");

              // Trigger InputHandler to evaluate current state if it exists
              if (window.inputHandler) {
                // InputHandler is ready - let it manage the button state
                const userInput = document.getElementById("user-input");
                if (userInput) {
                  window.inputHandler.updateButtonState(userInput.value.trim());
                }
              } else {
                // InputHandler not ready yet - ensure button starts disabled
                // InputHandler will take over when it initializes
                button.disabled = true;
              }
            } else {
              // No API key - take full control to prevent any submission
              button.textContent = "Enter your API key to use";
              button.disabled = true;
              button.setAttribute(
                "aria-label",
                "Button disabled: Please configure your OpenRouter API key above to process requests"
              );
            }
          }

          // Run status check on initial load
          checkApiKeyStatus();
        }
      })();
    </script>
  </body>
</html>
