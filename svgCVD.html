<!DOCTYPE html>
<html lang="en-GB">
   <head>
      <meta charset="utf-8" />
      <meta name="description" content="SVG Palette Adjuster for Colour Vision Deficiency">
      <meta name="keywords" content="accessibility, presentation, blog">
      <meta name="author" content="Matthew Deeprose">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>SVG Palette Adjuster for Colour Vision Deficiency</title>
      <link rel="stylesheet" id="lightCSS" href="light.css" media="(prefers-color-scheme: light)">
      <link rel="stylesheet" id="mainCSS" href="main.css" media="all">
      <link rel="stylesheet" id="darkCSS" href="dark.css" media="(prefers-color-scheme: dark)">
      <link rel="stylesheet" id="printCSS" href="print.css" media="print">
      <meta property="og:title" content="SVG Palette Adjuster for Colour Vision Deficiency - Matthew Deeprose">
      <meta property="og:description" content="">
      <meta property="og:image" content="https://matthewdeeprose.github.io/svgCVD-43.png">
	  <meta property="og:image:width" content="2500" />
	  <meta property="og:image:height" content="1306" />
      <meta property="og:image:alt" content="">
      <meta property="og:locale" content="en_GB">
      <meta property="og:type" content="website">
      <meta property="og:url" content="https://matthewdeeprose.github.io/svgCVD.html">
      <meta name="twitter:card" content="summary_large_image">
      <meta name="theme-color" content="#231F20" media="(prefers-color-scheme: dark)">
      <meta name="theme-color" content="#FFFFF4" media="(prefers-color-scheme: light)">
      <link rel="icon" href="favicon.ico">
      <link rel="alternate" type="application/rss+xml" title="RSS Feed for matthewdeeprose.github.io" href="https://matthewdeeprose.github.io/feed.rss">
      <link rel="icon" href="favicon.svg" type="image/svg+xml">
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:title" content="SVG Palette Adjuster for Colour Vision Deficiency - Matthew Deeprose" />
      <meta name="twitter:description" content=""/>
      <meta name="twitter:creator" content="@VLEguru"/>
      <meta name="twitter:site" content="@VLEguru"/>
      <meta name="twitter:image" content="https://matthewdeeprose.github.io/svgCVD-43.png"/>
      <meta name="twitter:image:alt" content=""/>
      <meta name="twitter:card" content="summary_large_image"/>
	  <style>
	  /* wider border just for this page */
@media (min-width: 60rem) {
  .page-wrap {
    margin: 0 5% 0 5%;
  }
} 
	           .page-wrap > * {
         grid-column: 1/-1 !important;
         grid-row: auto !important;
         }
		 aside {
		 display:none;
		 }
		 
		  button.SVGCVDButton {
		 font-size: 1rem !important;
		 }
	  
        .container {
            margin: 0 auto;
        }

        .svg-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .svg-wrapper {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .svg-wrapper h3 {
            margin-top: 0;
            text-align: center;
        }
        .svg-content-wrapper {
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
			color: white;
        }
        .svg-content {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            object-position: center;
        }
        #fileInput {
            display: none;
        }
		.svgCVDcontrols {
		margin-bottom: 10px;
		}
        #colorInfo, #paletteSelection, #colorSwapInterface {
            margin-top: 20px;
        }
        select {
            font-size: 16px;
            padding: 5px 10px;
			margin-left: 0.5rem;
        }
        #colorSwapInterface {
         /*   display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; */
        }
        .color-item {
            display: flex;
            align-items: center;
			margin-right: 20px;
            margin-bottom: 10px;
        }
		
		.color-list {
    display: flex;
    flex-wrap: wrap;
    list-style-type: none;
    padding: 0;
    margin: 0;
}

	.color-item span {font-family: monospace, monospace;}
	
        .color-swatch {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            border: 1px solid #000000;
			outline: 1px solid #FFFFFF;
        }
        #paletteMessage {
            margin-top: 10px;
            padding: 10px;

            border-radius: 5px;

        }
		
		/* Custom select CSS */
		.custom-select {
    position: relative;
    display: inline-block;
	    margin-left: 10px;	
} 
.select-button {
	display: flex;
    align-items: center;
    cursor: pointer;
	border-radius: 0px;
}  

	@media only screen and (min-width: 400px) {
		.select-button {
			min-width: 15rem;
		}
					.options {
		min-width: 240px;

	}
	}

	
		.selected-color {
		width: 15px;
		height: 15px;
		margin-left: 10px;
		border: 1px solid #fffff4 !important;
		outline: 1px solid #00131d !important;
	}
	
		.options {
		display: none;
		position: absolute;
		top: 100%;
		left: 0;
		z-index: 1;
		padding: 0;
		margin: 0;
		color: #00131d;
		background-color: #E1E8EC;
		border: 2px solid #fffff4;
		outline: 2px solid #00131d;
		max-height: 200px;
		
		overflow-y: auto;
	}

	.options::marker {
		font-size: 0;
	}
	.options li {
		padding: 5px 10px;
		cursor: pointer;
		display: flex;
		align-items: center;
				font-family: monospace, monospace;
	}

	.options li + li {
		text-transform: uppercase;

	}
	
	              .color-preview {
                             width: 30px;
                             height: 30px;
                             margin-right: 10px;
                             border: 1px solid #fffff4 !important;
                             outline: 1px solid #00131d !important;
              }
			  
			  	.svgToolH2 {
  font-size: 1.3rem;

	}
	
		                .options li:hover       {
                             background-color: #231F20;
				  			 color: #fffff4;
                             outline: 2px solid transparent;
              }

              .options li:focus {
                                                          background-color: #231F20;
				  			 color: #fffff4;
                            outline: 2px solid transparent; 
				  border: dashed 2px #fffff4;
              }

		
			  /* Filters */

.protanopia {
    -webkit-filter: url(#protanopia);
    -moz-filter: url(#protanopia);
    -ms-filter: url(#protanopia);
    -o-filter: url(#protanopia);
    filter: url(#protanopia);
}

.deuteranopia {
    -webkit-filter: url(#deuteranopia);
    -moz-filter: url(#deuteranopia);
    -ms-filter: url(#deuteranopia);
    -o-filter: url(#deuteranopia);
    filter: url(#deuteranopia);
}

.tritanopia {
    -webkit-filter: url(#tritanopia);
    -moz-filter: url(#tritanopia);
    -ms-filter: url(#tritanopia);
    -o-filter: url(#tritanopia);
    filter: url(#tritanopia);
}
		
</style>
   </head>
   <body>

      <div class="page-wrap" id="start">
         <a class="skip-link" id="skipToContent" href='#main'>Skip to content</a>
         <header class="page-header">
            <div id="banner">
               <div id="logo">
                  <button id="modeToggle" aria-label="Change between light and dark theme" aria-pressed="false" onclick="toggle(this.id);">
                     <svg id="logoSVG" height="45" viewBox="0 0 21 21" width="45" xmlns="http://www.w3.org/2000/svg" aria-labelledby="svgTitle svgDesc" role="img">
                        <title id="svgTitle">Change theme</title>
                        <desc id="svgDesc">Select to switch to light theme</desc>
                        <g fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" transform="translate(2 1)">
                           <path d="m6.5 17.5h4"/>
                           <path d="m8.5 4c2.4852814 0 4.5 2.01471863 4.5 4.5 0 1.7663751-1.017722 3.2950485-2.4987786 4.031633l-.0012214.968367c0 1.1045695-.8954305 2-2 2s-2-.8954305-2-2l-.00021218-.9678653c-1.48160351-.7363918-2.49978782-2.2653584-2.49978782-4.0321347 0-2.48528137 2.01471863-4.5 4.5-4.5z"/>
                           <path d="m8.5 1.5v-1"/>
                           <path d="m13.5 3.5 1-1"/>
                           <path d="m2.5 3.5 1-1" transform="matrix(-1 0 0 1 6 0)"/>
                           <path d="m13.5 13.5 1-1" transform="matrix(1 0 0 -1 0 26)"/>
                           <path d="m2.5 13.5 1-1" transform="matrix(-1 0 0 -1 6 26)"/>
                           <path d="m1.5 7.5h-1"/>
                           <path d="m16.5 7.5h-1"/>
                        </g>
                     </svg>
                     <svg id="logoSVG-Off" height="45" viewBox="0 0 21 21" width="45" xmlns="http://www.w3.org/2000/svg" aria-labelledby="svgTitleX svgDescX">
                        <title id="svgTitleX">Change theme</title>
                        <desc id="svgDescX">Select to switch to dark theme</desc>
                        <g fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" transform="translate(6 5)">
                           <path d="m2.5 13.5h4"/>
                           <path d="m4.5 0c2.48528137 0 4.5 2.01471863 4.5 4.5 0 1.76637512-1.01772197 3.29504854-2.49877863 4.03163297l-.00122137.96836703c0 1.1045695-.8954305 2-2 2s-2-.8954305-2-2l-.00021218-.96786527c-1.48160351-.73639182-2.49978782-2.26535843-2.49978782-4.03213473 0-2.48528137 2.01471863-4.5 4.5-4.5z"/>
                        </g>
                     </svg>
                  </button>
               </div>
               <span role="alert" class="hidden" aria-live="polite" id="lightDark"></span>
               <div id="titleLink">Matthew Deeprose</div>
            </div>
         </header>
         <div id="main-navigation" class="page-nav">
            <nav aria-label="Main menu" class="topnav" id="myTopnav">
               <button id="menu" aria-controls="myTopnav" aria-labelledby="myTopnav" aria-expanded="false" class="icon"  aria-haspopup="menu" onclick="menuAction()">
                  <span id="hamburger">
                     <svg id="hamSVG" viewBox="0 0 100 80" width="20" height="20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" role="img">
                        <title id="hamSVGTitle">Menu</title>
                        <desc id="hamSVGDesc">Select to expand or collapse the menu</desc>
                        <rect width="100" height="20"></rect>
                        <rect y="30" width="100" height="20"></rect>
                        <rect y="60" width="100" height="20"></rect>
                     </svg>
                  </span>
                  <span id="arrow">
                     <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true" focusable="false">
                        <title id="arrowSVGTitle">Menu</title>
                        <desc id="arrowSVGDesc">Select to expand or collapse the menu</desc>
                        <g stroke-width="4"  stroke-linejoin="round" stroke-linecap="round" stroke="currentColor" fill-rule="evenodd" fill="none">
                           <path  d="m7.499,6.497l-3.999,4.002l4,4.001"/>
                           <path  d="m16.5,10.5l-13,0"/>
                        </g>
                     </svg>
                  </span>
               </button>
               <a id="homeMenu" href="index.html">Home</a>
               <a href="presentations.html" >Presentations</a>
               <a href="posts.html">Blog Posts</a>
               <a href="projects.html" aria-current="page" class="active">Projects</a>
               <a href="about.html">About</a>
            </nav>
         </div>
         <main class="page-main" id="main">
            <article class="standard">
               <h1 id="top">SVG Palette Adjuster for Colour Vision Deficiency</h1>
			       <div class="container">
		<div class="svgCVDcontrols">
        <input type="file" id="fileInput" accept=".svg" aria-label="Upload SVG file">
        <button id="uploadBtn" class="SVGCVDButton">Upload SVG</button>
        <button id="resetBtn" class="SVGCVDButton" disabled>Reset Colors</button>
        <button id="saveBtn" class="SVGCVDButton" disabled>Save SVG</button>
		</div>

        <div class="svg-container">
            <div class="svg-wrapper">
                <h2 class="CVDTool">Original (Trichromacy)</h2>
                <div id="container1" class="trichromacy svg-content-wrapper"></div>
            </div>
            <div class="svg-wrapper">
                <h2 class="CVDTool">Protanopia</h2>
                <div id="container2" class="protanopia svg-content-wrapper"></div>
            </div>
            <div class="svg-wrapper">
                <h2 class="CVDTool">Deuteranopia</h2>
                <div id="container3" class="deuteranopia svg-content-wrapper"></div>
            </div>
            <div class="svg-wrapper">
                <h2 class="CVDTool">Tritanopia</h2>
                <div id="container4" class="tritanopia svg-content-wrapper"></div>
            </div>
        </div>
		
		
		<div id="workingContainer">
		
        <div id="colorInfo"></div>
        <div id="paletteSelection">
            <label for="paletteSelect">Select a color blind friendly palette:</label>
            <select id="paletteSelect"></select>
            <div id="paletteMessage" aria-live="polite"></div>
        </div>
        <div id="colorSwapInterface"></div>
		</div>
    </div>
            </article>
			      <div id="panel">
         <button class="panelButton" onclick="topFunction()" id="myBtn">
            <svg id="svgUP" height="50" viewBox="0 0 21 21" width="50" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="svgTitle2 svgDesc2">
               <title id="svgTitle2">Top.</title>
               <desc id="svgDesc2">Move to the top of the page.</desc>
               <g fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" transform="translate(2 2)">
                  <circle cx="8.5" cy="8.5" r="8"/>
                  <path d="m11.5 7.5-3-3-3 3"/>
                  <path d="m8.5 4.5v8"/>
               </g>
            </svg>
            <br />
            <span id="myBtnTop" class="panelLabel">Top</span>
         </button>
         <button class="panelButton" onclick="bottomFunction()" id="myBtn2">
            <svg id="svgDOWN" height="50" viewBox="0 0 21 21" width="50" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="svgTitle3 svgDesc3">
               <title id="svgTitle3">Bottom.</title>
               <desc id="svgDesc3">Move to the bottom of the page.</desc>
               <g fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" transform="translate(3 2)">
                  <circle cx="8.5" cy="8.5" r="8"/>
                  <path d="m5.5 9.5 3 3 3-3"/>
                  <path d="m8.5 12.5v-8"/>
               </g>
            </svg>
            <br />
            <span id="myBtnBottom" class="panelLabel">Bottom</span>
         </button>
      </div>
         </main>
         <footer class="page-footer">
            <div id="RSS"><a id="rssA" href="feed.rss">RSS</a></div>
            <div id="SiteMap"><a href="siteMap.html">Site Map</a></div>
            <div id="AccessibilityFoot">
               <a href="Accessibility_Statement.html">Accessibility Statement</a>
            </div>
            <div id="twitterFoot">
               <a href="https://twitter.com/vleguru?ref_src=twsrc%5Etfw">Follow on Twitter</a>
            </div>
            <div id="YouTubeChannelFoot">
               <a href="https://www.youtube.com/channel/UCKypjo59GE79UEjoLtzKEtQ">YouTube Channel</a>
            </div>
            <div id="aboutCodePen"><a href="https://codepen.io/matthewdeeprose/">CodePen</a></div><p><div id="aboutFoot">
               <a href="https://www.linkedin.com/in/mattdeeprose/">&#169;  Matthew Deeprose</a>
            </div>
         </p></footer>
      </div>
	     <!-------------------------------------------------------------------
    DaltonLens SVG filters to simulate color vision deficiencies 
    
    https://daltonlens.org/opensource-cvd-simulation/ for a
    discussion of the various methods.     

    The various matrices were generated from DaltonLens-Python.

    It is very important for these filters to get applied in     
    linearRGB, which is supposed to be the default, but never
    hurts to specify it explicitly.
-------------------------------------------------------------------->
<svg style='height: 0; width: 0; padding: 0; margin: 0; line-height: 0;'>
    <!-- Single matrix approximation of Viénot, Brettel & Mollon 1999 -->
    <filter id="protanopia" color-interpolation-filters="linearRGB">
        <feColorMatrix type="matrix" in="SourceGraphic" values="
            0.10889,0.89111,-0.00000,0,0
            0.10889,0.89111,0.00000,0,0
            0.00447,-0.00447,1.00000,0,0
            0,0,0,1,0"
        />
    </filter>

    <!-- Single matrix approximation of Viénot, Brettel & Mollon 1999 -->
    <filter id="deuteranopia" color-interpolation-filters="linearRGB">
        <feColorMatrix type="matrix" in="SourceGraphic" values="
            0.29031,0.70969,-0.00000,0,0
            0.29031,0.70969,-0.00000,0,0
            -0.02197,0.02197,1.00000,0,0
            0,0,0,1,0"
        />
    </filter>

    <!-- 
        Brettel, Viénot & Mollon 1997 algorithms with two projection planes.

        This is the only approach I know that is supposed to be reasonably
        accurate for tritanopia, the single matrix approaches are NOT accurate.
    -->
    <filter id="tritanopia" color-interpolation-filters="linearRGB">
        <!-- 
            Projection 1, with a special alpha that encodes the separation plane.
            If dot(rgb, n) > 0, then use projection 1, otherwise use projection 2.
            This is encoded in alpha by:
                - Applying a 1.0 factor on the source alpha so that 0 input alpha remains 0
                - Subtracting 0.2 so that negative values become < 0.8 and position values >= 0.8
                - It is important to normalize the factors to keep a good numerical accuracy
                  and to keep a large alpha threshold since the RGB values are then stored
                  premultiplied by alpha.
                - This assumes that negative values get clipped to 0, and positive
                  values clipped to 1, without overflowing, etc. Which seems to be the case
                  on all browsers.
          -->
        <feColorMatrix type="matrix" in="SourceGraphic" result="ProjectionOnPlane1" values="
            1.01354, 0.14268, -0.15622, 0, 0
            -0.01181, 0.87561, 0.13619, 0, 0
            0.07707, 0.81208, 0.11085, 0, 0
            7.92482, -5.66475, -2.26007, 1, -0.2"
        />
        <!-- 
            Binarize alpha. 5 values means the last chunk will start at 0.8.
            All the values below 0.8 will become 0 (correspond to the dot
            product with the separation plane being negative) and above will become 1
        -->        
        <feComponentTransfer in="ProjectionOnPlane1" result="ProjectionOnPlane1">
            <feFuncA type="discrete" tableValues="0 0 0 0 1"/>
        </feComponentTransfer>

        <feColorMatrix type="matrix" in="SourceGraphic" result="ProjectionOnPlane2" values="
            0.93337, 0.19999, -0.13336, 0, 0
            0.05809, 0.82565, 0.11626, 0, 0
            -0.37923, 1.13825, 0.24098, 0, 0
            0,0,0,1,0"
        />

        <!-- Uncomment the debug black matrix to see which pixels go to which plane -->
        <!-- <feColorMatrix type="matrix" in="SourceGraphic" result="ProjectionOnPlane2" values="0,0,0,0,0 0,0,0,0,0 0,0,0,0,0 0,0,0,1,0"/> -->

        <!-- Blend the two projections, picking one or the other depending on alpha. -->
        <feBlend in="ProjectionOnPlane1" in2="ProjectionOnPlane2" mode="normal"/>
    </filter>
</svg>
<!------------------------------------------------------------------>
	  <script src="scripts/svg.min.js"></script>
	      <script>
// Global variables
let originalSvg;
let svgColors = [];
let selectedPalette = [];
let currentColorSwaps = {};

// DOM Elements
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const resetBtn = document.getElementById('resetBtn');
const saveBtn = document.getElementById('saveBtn');
const colorInfo = document.getElementById('colorInfo');
const paletteSelect = document.getElementById('paletteSelect');
const colorSwapInterface = document.getElementById('colorSwapInterface');

// Event Listeners
uploadBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFileUpload);
resetBtn.addEventListener('click', resetColors);
saveBtn.addEventListener('click', saveSvg);
paletteSelect.addEventListener('change', handlePaletteSelection);

// File upload handler
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file && file.type === 'image/svg+xml') {
        const reader = new FileReader();
        reader.onload = (e) => {
            originalSvg = e.target.result;
            displaySvg(originalSvg);
            identifyColors();
            loadPalettes();
            resetBtn.disabled = false;
            saveBtn.disabled = false;
        };
        reader.readAsText(file);
    } else {
        alert('Please upload a valid SVG file.');
    }
}

// Display SVG in all containers
function displaySvg(svgContent) {
    const containers = ['container1', 'container2', 'container3', 'container4'];
    containers.forEach(id => {
        const container = document.getElementById(id);
        container.innerHTML = svgContent;
        const svg = container.querySelector('svg');
        
        if (svg) {
            // Remove any existing width and height attributes
            svg.removeAttribute('width');
            svg.removeAttribute('height');

            // Add class for styling
            svg.classList.add('svg-content');

            // Ensure viewBox is set
            if (!svg.getAttribute('viewBox')) {
                const bbox = svg.getBBox();
                svg.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
            }

            // Set preserveAspectRatio to see the whole SVG
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
        } 
    });
}

// Identify unique colors in the SVG
function identifyColors() {
    const parser = new DOMParser();
    const svgDoc = parser.parseFromString(originalSvg, 'image/svg+xml');
    const elements = svgDoc.querySelectorAll('*');
    const uniqueColors = new Set();

    elements.forEach(el => {
        const fill = el.getAttribute('fill');
        const stroke = el.getAttribute('stroke');
        if (fill && fill !== 'none') uniqueColors.add(fill);
        if (stroke && stroke !== 'none') uniqueColors.add(stroke);
    });

    svgColors = Array.from(uniqueColors);
    displayColorInfo();
}

// Display color information
function displayColorInfo() {
    const colorCount = svgColors.length;
    colorInfo.innerHTML = `
        <p>Number of colours: ${colorCount}</p>
    `;
    const ul = document.createElement('ul');
    ul.className = 'color-list';
    
    svgColors.forEach(color => {
        const li = document.createElement('li');
        li.className = 'color-item';
        li.innerHTML = `
            <div class="color-swatch" style="background-color: ${color};"></div>
            <span>${color}</span>
        `;
        ul.appendChild(li);
    });
    
    colorInfo.appendChild(ul);
}

// Load color palettes from https://matthewdeeprose.github.io/cvdp.json
function loadPalettes() {
    fetch('https://matthewdeeprose.github.io/cvdp.json')
        .then(response => response.json())
        .then(data => {
            const palettes = data.palettes;
            paletteSelect.innerHTML = '<option value="">Select a palette</option>';
            
            let largestPalette = null;
            let largestPaletteSize = 0;

            for (const [name, colors] of Object.entries(palettes)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${colors.length} colors)`;
                paletteSelect.appendChild(option);

                if (colors.length > largestPaletteSize) {
                    largestPalette = name;
                    largestPaletteSize = colors.length;
                }
            }

            if (svgColors.length > largestPaletteSize) {
                paletteSelect.value = largestPalette;
                displayPaletteMessage(svgColors.length, largestPaletteSize);
            }

            // Trigger palette selection to update the interface
            handlePaletteSelection();
        })
        .catch(error => console.error('Error loading palettes:', error));
}

function displayPaletteMessage(svgColorCount, paletteColorCount) {
    const messageDiv = document.getElementById('paletteMessage');
    messageDiv.textContent = `Your SVG contains ${svgColorCount} colours, which exceeds the ${paletteColorCount} colours available in the largest palette. Some colours may not be replaced.`;
}

// Handle palette selection
function handlePaletteSelection() {
    const selectedPaletteName = paletteSelect.value;
    if (selectedPaletteName) {
        fetch('https://matthewdeeprose.github.io/cvdp.json')
            .then(response => response.json())
            .then(data => {
                selectedPalette = data.palettes[selectedPaletteName];
                displayColorSwapInterface();
                
                // Clear the message if a palette is manually selected
                if (svgColors.length <= selectedPalette.length) {
                    document.getElementById('paletteMessage').textContent = '';
                }
            })
            .catch(error => console.error('Error loading selected palette:', error));
    } else {
        colorSwapInterface.innerHTML = '';
        document.getElementById('paletteMessage').textContent = '';
    }
}

// Define closeAllDropdowns outside of displayColorSwapInterface
let closeAllDropdowns;

function displayColorSwapInterface() {
$('.color-list').hide();
    colorSwapInterface.innerHTML = '<h2 class="svgToolH2">Swap Colors:</h3>';
    const customSelects = [];

    // Define closeAllDropdowns here so it has access to customSelects
    closeAllDropdowns = function() {
        customSelects.forEach(select => {
            select.querySelector('.options').style.display = 'none';
            select.querySelector('.select-button').setAttribute('aria-expanded', 'false');
        });
    };

    svgColors.forEach((originalColor, index) => {
        const swapDiv = document.createElement('div');
        swapDiv.className = 'color-item';
        swapDiv.innerHTML = `
            <div class="color-swatch" style="background-color: ${originalColor};"></div>
            <span class="color-item-span">${originalColor}</span>
            <div class="custom-select">
                <button class="select-button" aria-haspopup="listbox" aria-labelledby="color-label-${index}">
                    <span id="color-label-${index}" >Select new colour</span>
                    <span class="selected-color"></span>
                </button>
                <ul class="options" role="listbox" tabindex="-1">
                    <li role="option" tabindex="0" data-value="">
                        <span class="color-preview" style="background-color: ${originalColor};"></span>
                        Keep original
                    </li>
                    ${selectedPalette.map(newColor => `
                        <li role="option" tabindex="0" data-value="${newColor}">
                            <span class="color-preview" style="background-color: ${newColor};"></span>
                            ${newColor}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;

        const customSelect = swapDiv.querySelector('.custom-select');
        const selectButton = customSelect.querySelector('.select-button');
        const options = customSelect.querySelector('.options');
        const selectedColorSpan = selectButton.querySelector('.selected-color');

        // Set initial selected value
        const initialValue = currentColorSwaps[originalColor] || '';
        if (initialValue) {
            selectButton.querySelector('#color-label-' + index).textContent = initialValue;
            selectedColorSpan.style.backgroundColor = initialValue;
        }

        // Toggle options visibility
        selectButton.addEventListener('click', (event) => {
            event.stopPropagation();
            closeAllDropdowns();
            options.style.display = options.style.display === 'none' ? 'block' : 'none';
            selectButton.setAttribute('aria-expanded', options.style.display === 'block');
            if (options.style.display === 'block') {
                options.querySelector('li').focus();
            }
        });

        // Handle option selection
        options.addEventListener('click', (event) => {
            const selectedOption = event.target.closest('li');
            if (selectedOption) {
                selectOption(selectedOption);
            }
        });

        function selectOption(selectedOption) {
            const selectedValue = selectedOption.dataset.value;
            selectButton.querySelector('#color-label-' + index).textContent = selectedValue || 'Keep original';
            selectedColorSpan.style.backgroundColor = selectedValue;
            options.style.display = 'none';
            selectButton.setAttribute('aria-expanded', 'false');
            updateSvgColors(originalColor, selectedValue);
            selectButton.focus();
        }

        // Keyboard navigation
        customSelect.addEventListener('keydown', (event) => {
            const focusedOption = options.querySelector('li:focus');
            switch (event.key) {
                case 'ArrowUp':
                case 'ArrowDown':
                    event.preventDefault();
                    if (options.style.display === 'none') {
                        options.style.display = 'block';
                        selectButton.setAttribute('aria-expanded', 'true');
                        options.querySelector('li').focus();
                    } else {
                        const nextOption = event.key === 'ArrowDown' ? 
                            (focusedOption.nextElementSibling || options.firstElementChild) :
                            (focusedOption.previousElementSibling || options.lastElementChild);
                        nextOption.focus();
                    }
                    break;
                case 'Enter':
                case ' ':
                    event.preventDefault();
                    if (focusedOption) {
                        selectOption(focusedOption);
                    } else {
                        selectButton.click();
                    }
                    break;
                case 'Escape':
                    closeAllDropdowns();
                    selectButton.focus();
                    break;
            }
        });

        colorSwapInterface.appendChild(swapDiv);
        customSelects.push(customSelect);
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', closeAllDropdowns);
}

// Update SVG colors
function updateSvgColors(originalColor, newColor) {
    if (newColor) {
        currentColorSwaps[originalColor] = newColor;
    } else {
        delete currentColorSwaps[originalColor];
    }
    
    const parser = new DOMParser();
    const svgDoc = parser.parseFromString(originalSvg, 'image/svg+xml');
    const elements = svgDoc.querySelectorAll('*');
    
    elements.forEach(el => {
        const fillColor = el.getAttribute('fill');
        const strokeColor = el.getAttribute('stroke');
        
        if (fillColor && currentColorSwaps[fillColor]) {
            el.setAttribute('fill', currentColorSwaps[fillColor]);
        }
        if (strokeColor && currentColorSwaps[strokeColor]) {
            el.setAttribute('stroke', currentColorSwaps[strokeColor]);
        }
    });
    
    const serializer = new XMLSerializer();
    const updatedSvg = serializer.serializeToString(svgDoc);
    displaySvg(updatedSvg);
}

// Reset colors to original
function resetColors() {
    displaySvg(originalSvg);
    paletteSelect.value = '';
    colorSwapInterface.innerHTML = '';
    document.getElementById('paletteMessage').textContent = '';
    
    // Clear the currentColorSwaps object
    currentColorSwaps = {};
    
    // Reset the color swap interface
    if (selectedPalette.length > 0) {
        displayColorSwapInterface();
    }
}

// Save updated SVG
function saveSvg() {
    const svgContent = document.getElementById('container1').innerHTML;
    const blob = new Blob([svgContent], {type: 'image/svg+xml'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'updated_svg.svg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
    </script>

      <script>
         function menuAction() {
             let menuSwitch = document.getElementById("myTopnav");
             if (menuSwitch.className === "topnav") {
                 menuSwitch.className += " responsive";
                 
             } else {
                 menuSwitch.className = "topnav";
             }
             let menuAriaAttrib = document.getElementById("menu").getAttribute("aria-expanded");
             if (menuAriaAttrib === "true") {
                 menuAriaAttrib = "false"
             } else {
                 menuAriaAttrib = "true"
             }
             document.getElementById("menu").setAttribute("aria-expanded", menuAriaAttrib);
         }

















      </script>
      <script>
         let mybutton = document.getElementById("myBtn");
         let mybutton2 = document.getElementById("myBtn2");
         
         
         window.onscroll = function() {
             scrollFunction()
         };
         
         function scrollFunction() {
             if (document.body.scrollTop > 660 || document.documentElement.scrollTop > 660) {
                 mybutton.style.display = "block";
         		mybutton2.style.display = "block";
             } else {
                 mybutton.style.display = "none";
         		mybutton2.style.display = "none";
             }
         }
         
         
         
         function topFunction() {
             document.body.scrollTop = 0;
             document.documentElement.scrollTop = 0; 
         document.getElementById('skipToContent').focus();
         }
         
         function bottomFunction() {
         window.scrollTo(0,document.body.scrollHeight);
         document.getElementById('rssA').focus();
         }
      </script>
      <script>
         let themePref = localStorage.getItem("theme");
         console.log("Has a theme preference been saved?", themePref);        
         
         
         function setLight() {
             let buttonStatus = document.getElementById("lightDark");
             let theButton = document.getElementById("modeToggle");
             const d = matchMedia('(prefers-color-scheme: dark)');
             let dt;
             if (d.matches) {
                 dt = 'dark';
                 console.log("Prefers dark theme in OS");
             } else {
                 dt = 'light'
                 console.log("Prefers light theme in OS");
             }
             if (dt == 'dark' && themePref == 'Dark') {
                 theButton.setAttribute("aria-pressed", "true");
             } else if (dt == 'light' && themePref == 'Dark') {
                 theButton.setAttribute("aria-pressed", "true");
             } else if (dt == 'dark' && !themePref) {
                 theButton.setAttribute("aria-pressed", "true");
             } else {
                 theButton.setAttribute("aria-pressed", "false");
             }
         }
         setLight();
         
         function toggle(btnID) {
             let buttonStatus = document.getElementById("lightDark");
             let theButton = document.getElementById(btnID);
             if (theButton.getAttribute("aria-pressed") == "true") {
                 theButton.setAttribute("aria-pressed", "false");
                 document.getElementById('lightCSS').href = 'light.css';
                 document.getElementById('darkCSS').href = 'light.css';
                 console.log("Turned on light mode");
                 localStorage.setItem("theme", "Light");
                 let themePref = localStorage.getItem("theme");
                 console.log("Site theme preference to ", themePref);
                 document.getElementById('lightDark').innerHTML = 'Light theme enabled, the button is now';
                 let toggleButton = document.getElementById('modeToggle');
                 toggleButton.removeAttribute("aria-pressed");
                 toggleButton.setAttribute("aria-pressed", "false");
             } else {
                 theButton.setAttribute("aria-pressed", "true");
                 document.getElementById('lightCSS').href = 'dark.css';
                 document.getElementById('darkCSS').href = 'dark.css';
                 console.log("Turned on dark mode");
                 localStorage.setItem("theme", "Dark");
                 let themePref = localStorage.getItem("theme");
                 console.log("Site theme preference set to ", themePref);
                 document.getElementById('lightDark').innerHTML = 'Dark theme enabled, the button is now';
                 let toggleButton = document.getElementById('modeToggle');
                 toggleButton.removeAttribute("aria-pressed");
                 toggleButton.setAttribute("aria-pressed", "true");
             }
         }
         
         function applyThemePreference() {
             if (themePref == 'Dark') {
                 let theButton = document.getElementById('modeToggle');
                 document.getElementById('lightCSS').href = 'dark.css';
                 document.getElementById('darkCSS').href = 'dark.css';
                 theButton.setAttribute("aria-pressed", "true");
                 console.log("Applied dark theme because site theme preference is set to", themePref);
             } else if (themePref == 'Light') {
                 let theButton = document.getElementById('modeToggle');
                 document.getElementById('lightCSS').href = 'light.css';
                 document.getElementById('darkCSS').href = 'light.css';
                 theButton.setAttribute("aria-pressed", "false");
                 console.log("Applied dark theme because site theme preference is set to", themePref);
             }
         }
         applyThemePreference();                
      </script>
	    <script src="scripts/jquery-3.7.1.min.js"></script>
    <script src="scripts/details.js"></script>
    <script>
      window.console || (window.console = {
        'log': alert
      });
      $(function() {
        $('html').addClass($.fn.details.support ? 'details' : 'no-details');
        $('details').details();
        $('details').on({
          'open.details': function() {
            console.log('opened')
          },
          'close.details': function() {
            console.log('closed')
          }
        })
      });
    </script>
	    <script>
      // Expand details / summary when printing
      // From https://stackoverflow.com/questions/19646684/force-open-the-details-summary-tag-for-print-in-chrome
      window.matchMedia("print").addEventListener("change", evt => {
        if (evt.matches) {
          elms = document.body.querySelectorAll("details:not([open])");
          for (e of elms) {
            e.setAttribute("open", "");
            e.dataset.wasclosed = "";
          }
        } else {
          elms = document.body.querySelectorAll("details[data-wasclosed]");
          for (e of elms) {
            e.removeAttribute("open");
            delete e.dataset.wasclosed;
          }
        }
      })
    </script>
   </body>
</html>
