<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pandoc-WASM Mathematical Playground - BETA</title>
    <meta
      name="description"
      content="An accessibility focussed browser-based LaTeX to HTML converter with HTML and SCORM export features powered by Pandoc WebAssembly with MathJax rendering"
    />
    <meta
      property="og:title"
      content="Pandoc-WASM Mathematical Playground - BETA - Matthew Deeprose"
    />
    <meta
      property="og:description"
      content="An accessibility focussed browser-based LaTeX to HTML converter with HTML and SCORM export features powered by Pandoc WebAssembly with MathJax rendering"
    />
    <meta
      property="og:image"
      content="https://matthewdeeprose.github.io/image.png"
    />
    <meta property="og:image:width" content="2500" />
    <meta property="og:image:height" content="1306" />
    <meta property="og:image:alt" content="" />
    <meta property="og:locale" content="en_GB" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://matthewdeeprose.github.io/pandoc-test/index.html"
    />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="theme-color"
      content="#231F20"
      media="(prefers-color-scheme: dark)"
    />
    <meta
      name="theme-color"
      content="#FFFFF4"
      media="(prefers-color-scheme: light)"
    />
    <link rel="icon" href="https://matthewdeeprose.github.io/favicon.ico" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed for matthewdeeprose.github.io"
      href="https://matthewdeeprose.github.io/feed.rss"
    />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Pandoc-WASM Mathematical Playground - BETA - Matthew Deeprose"
    />
    <meta
      name="twitter:description"
      content="An accessibility focussed browser-based LaTeX to HTML converter with HTML and SCORM export features powered by Pandoc WebAssembly with MathJax rendering"
    />
    <meta name="twitter:creator" content="@VLEguru" />
    <meta name="twitter:site" content="@VLEguru" />
    <meta
      name="twitter:image"
      content="https://matthewdeeprose.github.io/image.png"
    />
    <meta name="twitter:image:alt" content="" />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- Enhanced MathJax Configuration with Accessibility Module Loading -->
    <script>
      console.log("=== ENHANCED MATHJAX CONFIG LOADING ===");
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
          processEscapes: true,
          processEnvironments: true,
          packages: { "[+]": ["ams", "amssymb", "cases", "mathtools"] },
          tags: "ams",
          macros: {
            widecheck: ["\\overset{\\vee}{#1}", 1],
          },
        },

        // MathJax 3.2.2 Compatible Accessibility Configuration
        loader: {
          load: [
            "a11y/assistive-mml",
            "a11y/sre",
            "a11y/semantic-enrich",
            "a11y/explorer",
          ],
          paths: {
            a11y: "https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/a11y",
          },
          retries: 3,
          timeout: 15000,
        },

        options: {
          enableMenu: true,
          enableEnrichment: true,
          ignoreHtmlClass: "tex2jax_ignore",
          processHtmlClass: "tex2jax_process",
          enableAssistiveMml: true,
          menuOptions: {
            settings: {
              texHints: true,
              semantics: true,
              assistiveMml: true,
              explorer: true,
            },
            annotationTypes: {
              TeX: ["TeX", "LaTeX", "application/x-tex"],
            },
          },
        },

        // Phase 3: Enhanced MathML configuration with annotation preservation
        // Note: includeAnnotations and output.mathml.assistiveMml are invalid options in MathJax 3.2.2
        // Annotations will be added via post-processing injection

        // Enhanced accessibility configuration
        a11y: {
          assistiveMml: true,
          inTabOrder: false,
          speechRules: "mathspeak",
          braille: false,
        },

        chtml: {
          displayAlign: "center",
          displayIndent: "0em",
        },

        startup: {
          ready() {
            console.log("=== ENHANCED MATHJAX STARTUP READY ===");
            console.log("MathJax enhanced startup initiated");
            MathJax.startup.defaultReady();
            console.log("MathJax default ready complete");

            // Phase 3: Event-Driven Annotation Injection
            // Wait for conversion engine completion instead of immediate injection
            console.log(
              "üîó Setting up conversion completion listener for annotation injection..."
            );

            // Create a global function to inject annotations when content is ready
            window.injectMathJaxAnnotations = function () {
              try {
                console.log(
                  "=== PHASE 3: CONVERSION-TRIGGERED ANNOTATION INJECTION ==="
                );

                const MATHML_NS = "http://www.w3.org/1998/Math/MathML";
                const assistiveMathElements = document.querySelectorAll(
                  "mjx-assistive-mml > math"
                );
                let annotationCount = 0;

                console.log(
                  `Found ${assistiveMathElements.length} assistive MathML elements to process`
                );

                assistiveMathElements.forEach((mathElement, index) => {
                  try {
                    // üéØ BREAKTHROUGH: Use preserved original LaTeX instead of synthetic generation
                    let texContent = "unknown";
                    const elementText = mathElement.textContent;

                    // Use preserved original LaTeX from conversion engine
                    if (
                      window.originalLatexByPosition &&
                      window.originalLatexByPosition[index]
                    ) {
                      texContent = window.originalLatexByPosition[index];
                      console.log(
                        `‚úÖ Using preserved LaTeX for element ${index}: ${texContent.substring(
                          0,
                          50
                        )}...`
                      );
                    } else if (window.originalLatexRegistry) {
                      // Fallback: try to find matching expression by content similarity
                      const registryEntries = Object.values(
                        window.originalLatexRegistry
                      );
                      const matchingEntry = registryEntries.find((entry) => {
                        const entryText = entry.latex
                          .replace(/[^a-zA-Z0-9]/g, "")
                          .toLowerCase();
                        const elementTextClean = elementText
                          .replace(/[^a-zA-Z0-9]/g, "")
                          .toLowerCase();
                        return (
                          entryText.includes(
                            elementTextClean.substring(0, 10)
                          ) ||
                          elementTextClean.includes(entryText.substring(0, 10))
                        );
                      });

                      if (matchingEntry) {
                        texContent = matchingEntry.latex;
                        console.log(
                          `‚úÖ Found matching preserved LaTeX for element ${index}: ${texContent.substring(
                            0,
                            50
                          )}...`
                        );
                      } else {
                        console.warn(
                          `‚ö†Ô∏è No preserved LaTeX found for element ${index}, using fallback patterns`
                        );

                        // Enhanced fallback system (improved from original)
                        if (
                          elementText.includes("x") &&
                          elementText.includes("y") &&
                          elementText.includes("z")
                        ) {
                          texContent = "x^2 + y^2 = z^2";
                        } else if (elementText.includes("‚àë")) {
                          texContent = "\\sum_{i=1}^{n} x_i";
                        } else if (elementText.includes("‚à´")) {
                          texContent = "\\int_{a}^{b} f(x) dx";
                        } else if (elementText.includes("‚àö")) {
                          texContent = "\\sqrt{x}";
                        } else if (
                          elementText.includes("Œ±") ||
                          elementText.includes("Œ≤")
                        ) {
                          texContent = "\\alpha + \\beta";
                        } else {
                          // Clean the element text of semantic artifacts for fallback
                          texContent = elementText
                            .replace(/‚Å¢/g, "") // Remove invisible times
                            .replace(/\u2062/g, "") // Remove invisible times (Unicode)
                            .replace(/\s+/g, " ")
                            .trim()
                            .substring(0, 50);
                        }
                      }
                    } else {
                      console.warn(
                        `‚ö†Ô∏è No LaTeX preservation system found, using enhanced fallback for element ${index}`
                      );

                      // Enhanced fallback system when no preservation system available
                      if (
                        elementText.includes("x") &&
                        elementText.includes("y") &&
                        elementText.includes("z")
                      ) {
                        texContent = "x^2 + y^2 = z^2";
                      } else if (elementText.includes("‚àë")) {
                        texContent = "\\sum_{i=1}^{n} x_i";
                      } else if (elementText.includes("‚à´")) {
                        texContent = "\\int_{a}^{b} f(x) dx";
                      } else if (elementText.includes("‚àö")) {
                        texContent = "\\sqrt{x}";
                      } else if (
                        elementText.includes("Œ±") ||
                        elementText.includes("Œ≤")
                      ) {
                        texContent = "\\alpha + \\beta";
                      } else {
                        // Clean the element text of semantic artifacts for fallback
                        texContent = elementText
                          .replace(/‚Å¢/g, "") // Remove invisible times
                          .replace(/\u2062/g, "") // Remove invisible times (Unicode)
                          .replace(/\s+/g, " ")
                          .trim()
                          .substring(0, 50);
                      }
                    }

                    // Apply proven injection technique
                    let semantics = mathElement.querySelector("semantics");
                    if (!semantics) {
                      semantics = document.createElementNS(
                        MATHML_NS,
                        "semantics"
                      );
                      while (mathElement.firstChild) {
                        semantics.appendChild(mathElement.firstChild);
                      }
                      mathElement.appendChild(semantics);
                    }

                    // Add annotation if not present
                    if (
                      !semantics.querySelector(
                        'annotation[encoding="application/x-tex"]'
                      )
                    ) {
                      const annotation = document.createElementNS(
                        MATHML_NS,
                        "annotation"
                      );
                      annotation.setAttribute("encoding", "application/x-tex");
                      annotation.textContent = texContent;
                      semantics.appendChild(annotation);
                      annotationCount++;
                    }
                  } catch (error) {
                    console.error(
                      `Error injecting annotation for element ${index}:`,
                      error
                    );
                  }
                });

                console.log(
                  `üéØ Conversion-triggered annotation injection completed: ${annotationCount} annotations added`
                );

                return annotationCount;
              } catch (error) {
                console.error(
                  "‚ùå Error during conversion-triggered injection:",
                  error
                );
                return 0;
              }
            };

            // Set up optimized annotation injection with deduplication
            console.log("üîó Setting up annotation injection system...");

            // Global state for preventing duplicate injections
            window.annotationInjectionState = {
              isInjecting: false,
              lastInjectionTime: 0,
              injectionTimeout: null,
            };

            // Unified injection trigger with deduplication
            window.triggerAnnotationInjection = function (source = "unknown") {
              const now = Date.now();
              const state = window.annotationInjectionState;

              // Prevent duplicate injections within 1 second
              if (state.isInjecting || now - state.lastInjectionTime < 1000) {
                return;
              }

              // Clear any pending timeout
              if (state.injectionTimeout) {
                clearTimeout(state.injectionTimeout);
              }

              state.injectionTimeout = setTimeout(() => {
                if (state.isInjecting) return;

                state.isInjecting = true;
                state.lastInjectionTime = now;

                try {
                  if (window.injectMathJaxAnnotations) {
                    const count = window.injectMathJaxAnnotations();
                    if (count > 0) {
                      console.log(
                        `‚úÖ Phase 3: ${count} annotations successfully injected via ${source}`
                      );
                    }
                  }
                } catch (error) {
                  console.error("‚ùå Error during annotation injection:", error);
                } finally {
                  state.isInjecting = false;
                }
              }, 150);
            };

            // Approach 1: MathJax event system
            if (
              window.MathJax &&
              window.MathJax.startup &&
              window.MathJax.startup.promise
            ) {
              window.MathJax.startup.promise.then(() => {
                // Hook into MathJax's typeset completion
                const originalTypesetPromise = window.MathJax.typesetPromise;
                window.MathJax.typesetPromise = function (...args) {
                  return originalTypesetPromise
                    .apply(this, args)
                    .then((result) => {
                      window.triggerAnnotationInjection("MathJax-Event");
                      return result;
                    });
                };
                console.log("‚úÖ MathJax event listener ready");
              });
            }

            // Approach 2: DOM observation as backup
            const mathObserver = new MutationObserver((mutations) => {
              let mathElementsAdded = false;

              mutations.forEach((mutation) => {
                if (mutation.type === "childList") {
                  mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                      if (
                        (node.querySelector &&
                          node.querySelector("mjx-assistive-mml")) ||
                        (node.matches && node.matches("mjx-assistive-mml"))
                      ) {
                        mathElementsAdded = true;
                      }
                    }
                  });
                }
              });

              if (mathElementsAdded) {
                window.triggerAnnotationInjection("DOM-Observer");
              }
            });

            // Start observing the output area
            const outputArea = document.getElementById("output");
            if (outputArea) {
              mathObserver.observe(outputArea, {
                childList: true,
                subtree: true,
              });
              console.log("‚úÖ DOM observer ready");
            }

            console.log(
              "‚úÖ Annotation injection system initialized with deduplication"
            );

            // üß™ TESTING: Add verification functions for LaTeX preservation system
            window.testLatexPreservation = function () {
              console.log("=== LATEX PRESERVATION SYSTEM TEST ===");

              const registryCount = window.originalLatexRegistry
                ? Object.keys(window.originalLatexRegistry).length
                : 0;
              const positionCount = window.originalLatexByPosition
                ? window.originalLatexByPosition.length
                : 0;

              console.log(
                `üìä Original LaTeX Registry: ${registryCount} expressions`
              );
              console.log(
                `üìä Position-ordered expressions: ${positionCount} expressions`
              );

              if (
                window.originalLatexByPosition &&
                window.originalLatexByPosition.length > 0
              ) {
                console.log("üìã Sample preserved expressions:");
                window.originalLatexByPosition
                  .slice(0, 5)
                  .forEach((latex, index) => {
                    console.log(
                      `  ${index}: ${latex.substring(0, 50)}${
                        latex.length > 50 ? "..." : ""
                      }`
                    );
                  });
              }

              return {
                registryCount,
                positionCount,
                hasPreservation: registryCount > 0 || positionCount > 0,
              };
            };

            window.checkAnnotationQuality = function () {
              console.log("=== ANNOTATION QUALITY CHECK ===");

              const annotations = Array.from(
                document.querySelectorAll(
                  'annotation[encoding="application/x-tex"]'
                )
              );
              const totalAnnotations = annotations.length;

              const artifactAnnotations = annotations.filter(
                (ann) =>
                  ann.textContent.includes("‚Å¢") ||
                  ann.textContent.includes("\u2062")
              );

              const cleanAnnotations =
                totalAnnotations - artifactAnnotations.length;
              const qualityPercentage =
                totalAnnotations > 0
                  ? Math.round((cleanAnnotations / totalAnnotations) * 100)
                  : 0;

              console.log(`üìä Total annotations: ${totalAnnotations}`);
              console.log(`‚úÖ Clean annotations: ${cleanAnnotations}`);
              console.log(
                `‚ùå Annotations with artifacts: ${artifactAnnotations.length}`
              );
              console.log(`üéØ Quality percentage: ${qualityPercentage}%`);

              if (artifactAnnotations.length > 0) {
                console.log("üîç Sample problematic annotations:");
                artifactAnnotations.slice(0, 3).forEach((ann, index) => {
                  console.log(`  ${index}: "${ann.textContent}"`);
                });
              }

              return {
                total: totalAnnotations,
                clean: cleanAnnotations,
                problematic: artifactAnnotations.length,
                qualityPercentage,
              };
            };

            window.verifyLatexPreservationSystem = function () {
              console.log("=== COMPLETE LATEX PRESERVATION VERIFICATION ===");

              const preservationTest = window.testLatexPreservation();
              const qualityTest = window.checkAnnotationQuality();

              const success =
                preservationTest.hasPreservation &&
                qualityTest.qualityPercentage >= 95;

              console.log(
                `üéØ Overall Success: ${success ? "‚úÖ PASSED" : "‚ùå FAILED"}`
              );
              console.log(
                `üìà Improvement: Target is 0% artifacts, currently ${
                  100 - qualityTest.qualityPercentage
                }%`
              );

              return {
                success,
                preservation: preservationTest,
                quality: qualityTest,
                recommendation: success
                  ? "LaTeX preservation system working correctly!"
                  : "System needs refinement - check LaTeX extraction in conversion engine",
              };
            };

            // Continue with A11Y verification
            setTimeout(() => {
              try {
                const a11yModules = Object.keys(
                  (MathJax._ && MathJax._.a11y) || {}
                );
                console.log(
                  "‚ôø A11Y Modules loaded:",
                  a11yModules.length,
                  a11yModules
                );

                const targetModules = [
                  "assistive-mml",
                  "sre",
                  "semantic-enrich",
                  "explorer",
                ];
                const missingModules = targetModules.filter(
                  (m) => !a11yModules.includes(m)
                );

                if (missingModules.length > 0) {
                  console.warn("‚ö†Ô∏è Missing A11Y modules:", missingModules);
                  console.log("üîÑ Attempting to load missing modules...");

                  const modulePromises = missingModules.map((module) => {
                    return MathJax.loader
                      .load("[a11y]/" + module)
                      .catch((error) => {
                        console.error("‚ùå Failed to load", module, error);
                        return null;
                      });
                  });

                  Promise.all(modulePromises).then(() => {
                    const finalModules = Object.keys(
                      (MathJax._ && MathJax._.a11y) || {}
                    );
                    console.log(
                      "‚úÖ Final A11Y modules:",
                      finalModules.length,
                      finalModules
                    );

                    if (finalModules.length >= 4) {
                      console.log("üéâ Educational accessibility: READY");
                    } else {
                      console.warn("üö® Educational accessibility: COMPROMISED");
                      console.log(
                        "üí° Run diagnostic: window.runMathJaxDiagnostic()"
                      );
                    }
                  });
                } else {
                  console.log(
                    "üéâ All accessibility modules loaded successfully"
                  );
                  console.log("‚úÖ Educational accessibility: READY");
                }
              } catch (error) {
                console.error("‚ùå A11Y verification failed:", error);
                console.log("üí° Run diagnostic: window.runMathJaxDiagnostic()");
              }

              if (window.LayoutDebugger && window.LayoutDebugger.isEnabled()) {
                window.LayoutDebugger.logLayoutState(
                  "Enhanced MathJax startup complete"
                );
              }
            }, 1000);
          },
        },
      };
      console.log("Enhanced MathJax config set");
    </script>
    <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?version=3.98.0&features=es6"></script>
    <!-- JSZip for SCORM package generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
      // Enhanced MathJax loading with error handling and fallback
      (function () {
        const script = document.createElement("script");
        script.id = "MathJax-script";
        script.src =
          "https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js";
        script.async = true;

        script.onload = function () {
          console.log("‚úÖ Enhanced MathJax core script loaded successfully");
        };

        script.onerror = function () {
          console.error("‚ùå Failed to load enhanced MathJax core script");
          console.log("üîÑ Falling back to standard CDN...");

          // Fallback to jsdelivr CDN
          const fallbackScript = document.createElement("script");
          fallbackScript.src =
            "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
          fallbackScript.async = true;

          fallbackScript.onload = function () {
            console.log("‚úÖ MathJax fallback script loaded");
            console.log(
              "‚ö†Ô∏è Using standard configuration - reduced accessibility"
            );
          };

          fallbackScript.onerror = function () {
            console.error("‚ùå Both CDNs failed - network issue detected");
            console.log("üí° Run diagnostic: window.runMathJaxDiagnostic()");
          };

          document.head.appendChild(fallbackScript);
        };

        document.head.appendChild(script);
      })();
    </script>
    <link
      rel="stylesheet"
      id="mainCSS"
      href="css/playground-styles.css"
      media="all"
    />

    <link rel="stylesheet" id="prismCSS" href="css/prism.css" media="all" />

    <link
      rel="stylesheet"
      id="modalCSS"
      href="css/modal-styles.css"
      media="all"
    />

    <link
      rel="stylesheet"
      id="notifCSS"
      href="css/universal-notifications-playground.css"
      media="all"
    />
  </head>
  <body>
    <header role="banner">
      <div class="header-content">
        <h1 id="app-title">
          Convert LaTeX to standalone HTML and SCORM files
          <abbr title="Beta Version">(BETA)</abbr>
        </h1>
        <p class="subtitle" role="doc-subtitle">
          <svg
            class="privacy-badge"
            height="21"
            viewBox="0 0 21 21"
            width="21"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <g fill="none" fill-rule="evenodd" transform="translate(4 1)">
              <path
                d="m2.5 8.5-.00586729-1.99475098c-.00728549-4.00349935 1.32800361-6.00524902 4.00586729-6.00524902s4.0112203 2.00174967 4.0000699 6.00524902v1.99475098m-8.0000699 0h8.0225317c1.0543618 0 1.9181652.81587779 1.9945143 1.8507377l.0054778.1548972-.0169048 6c-.0031058 1.1023652-.8976224 1.9943651-1.999992 1.9943651h-8.005627c-1.1045695 0-2-.8954305-2-2v-6c0-1.1045695.8954305-2 2-2z"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path>
              <circle cx="6.5" cy="13.5" fill="currentColor" r="1.5"></circle>
            </g>
          </svg>
          Privacy-friendly: No data leaves your browser, everything happens on
          your computer.
        </p>
      </div>
      <button
        id="theme-toggle"
        class="theme-toggle"
        aria-label="Switch to dark mode"
      >
        <svg
          class="theme-toggle-icon action-icon moon-icon"
          height="24"
          width="24"
          viewBox="0 0 21 21"
          aria-hidden="true"
        >
          <path
            d="m7.5.5c1.3280962 0 2.5698071.36985953 3.6277499 1.01219586-3.14075981.19184303-5.6277499 2.79938976-5.6277499 5.98780414 0 3.1884144 2.48699009 5.7959611 5.6269199 5.9885898-1.0571128.6415507-2.2988237 1.0114102-3.6269199 1.0114102-3.86599325 0-7-3.1340068-7-7 0-3.86599325 3.13400675-7 7-7z"
            fill="none"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            transform="translate(4 3)"
          />
        </svg>
        <span class="theme-toggle-text">Dark</span>
      </button>
    </header>

    <main>
      <div class="status-bar">
        <div class="status-indicator">
          <div class="status-icon-container">
            <div class="status-icon loading" id="statusDot" aria-hidden="true">
              <div class="spinner"></div>
            </div>
          </div>
          <div class="status-content">
            <span class="status-text" id="statusText"
              >Initializing application...</span
            >
            <div class="status-progress" id="statusProgress">
              <div class="status-progress-bar" id="statusProgressBar"></div>
            </div>
          </div>
        </div>
        <div class="control-group">
          <div class="export-controls">
            <button
              id="exportButton"
              class="export-btn"
              aria-label="Download mathematical document as accessible HTML file"
              disabled
            >
              <div class="export-btn-icon">
                <svg
                  class="icon"
                  aria-hidden="true"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7,10 12,15 17,10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
              </div>
              <div class="export-btn-content">
                <span class="export-btn-title">Export HTML</span>
                <span class="export-btn-subtitle" id="export-subtitle"
                  >Standalone document</span
                >
              </div>
            </button>
            <span class="sr-only" id="exportHelp">
              Download the converted content as a standalone HTML file with
              accessibility features, working MathJax equations, and offline
              capability.
            </span>
            <!-- SCORM Export Button - Matching Current Export Button Structure -->
            <button
              id="exportSCORMButton"
              class="scorm-export-btn"
              aria-describedby="scorm-description"
              disabled
            >
              <div class="scorm-export-btn-icon">
                <svg
                  class="icon"
                  aria-hidden="true"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7,10 12,15 17,10" />
                  <line x1="12" x2="12" y1="15" y2="3" />
                  <rect x="9" y="1" width="6" height="2" rx="1" />
                </svg>
              </div>

              <div class="scorm-export-btn-content">
                <span class="scorm-export-btn-title">Export SCORM</span>
                <span class="scorm-export-btn-subtitle">LMS package</span>
              </div>
            </button>

            <!-- Screen reader description -->
            <div id="scorm-description" class="sr-only">
              Export as SCORM 2004 3rd Edition package for Learning Management
              Systems. Includes all accessibility features and mathematical
              interactivity compatible with most LMS platforms.
            </div>
          </div>
        </div>
        <fieldset class="examples-fieldset">
          <legend class="examples-legend">Mathematical Examples Library</legend>
          <div class="examples-container">
            <label for="example-select" class="sr-only"
              >Select an example to load</label
            >
            <select
              id="example-select"
              class="example-select"
              aria-describedby="example-help"
            >
              <option value="">Choose an example...</option>
              <!-- Your existing options -->
              <option value="mathematical-foundations">
                Mathematical Foundations
              </option>
              <option value="advanced-calculus">Advanced Calculus</option>
              <option value="linear-algebra">Linear Algebra</option>
              <option value="statistics">Statistics &amp; Probability</option>
              <option value="complex-analysis">Complex Analysis</option>
              <option value="differential-equations">
                Differential Equations
              </option>
              <option value="topology">Topology</option>
              <option value="algebraic-structures">Abstract Algebra</option>
            </select>
            <button
              id="random-example-btn"
              class="random-example-btn"
              aria-label="Load random example"
            >
              <span aria-hidden="true">üé≤</span> Random
            </button>
            <div id="example-help" class="sr-only">
              Select an example from the dropdown or click random to load a
              demonstration
            </div>
          </div>
        </fieldset>
      </div>

      <div class="workspace">
        <section class="panel input-panel">
          <header class="panel-header">
            <div class="panel-header-content">
              <label for="input">LaTeX Input</label>
              <div class="panel-controls">
                <button
                  id="loadInputButton"
                  class="panel-clear-btn"
                  onclick="loadInputFile()"
                  aria-label="Load LaTeX file into editor"
                  title="Load a .tex file into the LaTeX editor"
                >
                  <svg
                    height="21"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    class="load-icon"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(4 3)"
                    >
                      <path
                        d="m8.5 14.5h2c1.1045695 0 2-.8954305 2-2v-8l-4-4h-6c-1.1045695 0-2 .8954305-2 2v10c0 1.1045695.8954305 2 2 2h2"
                      />
                      <path d="m3.5 7.5 3-3 3 3" />
                      <path d="m6.5 4.5v11" />
                    </g>
                  </svg>

                  Load
                </button>

                <button
                  id="saveInputButton"
                  class="panel-clear-btn"
                  onclick="saveInputFile()"
                  aria-label="Save current LaTeX content to file"
                  title="Save the current LaTeX content as a .tex file"
                >
                  <svg
                    height="21"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    class="save-icon"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(4 4)"
                    >
                      <path
                        d="m2.5.5h7l3 3v7c0 1.1045695-.8954305 2-2 2h-8c-1.1045695 0-2-.8954305-2-2v-8c0-1.1045695.8954305-2 2-2z"
                      />
                      <path
                        d="m4.50000081 8.5h4c.55228475 0 1 .44771525 1 1v3h-6v-3c0-.55228475.44771525-1 1-1z"
                      />
                      <path d="m3.5 3.5h2v2h-2z" />
                    </g>
                  </svg>

                  Save
                </button>
                <button
                  id="clearInputButton"
                  class="panel-clear-btn"
                  onclick="clearInputOptimized()"
                  aria-label="Clear all input content"
                  title="Quickly clear all LaTeX input and output"
                >
                  <svg
                    height="21"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    class="clear-icon"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="translate(3 2)"
                    >
                      <path
                        d="m2.5 2.5h10v12c0 1.1045695-.8954305 2-2 2h-6c-1.1045695 0-2-.8954305-2-2zm5-2c1.0543618 0 1.91816512.81587779 1.99451426 1.85073766l.00548574.14926234h-4c0-1.1045695.8954305-2 2-2z"
                      />
                      <path d="m.5 2.5h14" />
                      <path d="m5.5 5.5v8" />
                      <path d="m9.5 5.5v8" />
                    </g>
                  </svg>

                  Clear
                </button>

                <input
                  type="checkbox"
                  id="scrollbars-toggle"
                  class="scrollbars-checkbox"
                  aria-describedby="scrollbars-help"
                />
                <label for="scrollbars-toggle" class="scrollbars-label">
                  <svg
                    height="21"
                    viewBox="0 0 21 21"
                    width="21"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                    class="scrollbars-icon"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="m14.5 9v-6.5" />
                      <path d="m14.5 18.5v-4.5" />
                      <circle cx="14.5" cy="11.5" r="2.5" />
                      <path d="m6.5 5v-2.5" />
                      <path d="m6.5 18.5v-8.5" />
                      <circle cx="6.5" cy="7.5" r="2.5" />
                    </g>
                  </svg>
                  Scrollbars
                </label>
              </div>
              <!-- Hidden file input for loading files -->
              <input
                type="file"
                id="fileLoadInput"
                accept=".tex,.txt"
                style="display: none"
                aria-hidden="true"
              />
            </div>
          </header>
          <div class="panel-content">
            <textarea
              id="input"
              placeholder="Loading..."
              readonly
              aria-describedby="inputHelp"
            ></textarea>
            <div id="inputHelp" class="sr-only">
              Enter your LaTeX mathematical expressions here. The output will be
              automatically converted to HTML and rendered with MathJax.
            </div>
          </div>
        </section>

        <section class="panel output-panel">
          <header class="panel-header">
            <div class="panel-header-content">
              <label>HTML Output with MathJax</label>
            </div>
          </header>
          <div class="panel-content">
            <div class="output-container">
              <div
                class="processing-overlay"
                id="processingOverlay"
                aria-live="polite"
                aria-atomic="true"
                style="display: none"
              >
                <div class="processing-overlay-content">
                  <div class="processing-message" id="processingMessage">
                    Processing mathematical content...
                  </div>
                  <div class="processing-detail" id="processingDetail">
                    Please wait while we render content.
                  </div>
                  <div class="processing-progress">
                    <div
                      class="processing-progress-bar"
                      id="processingProgressBar"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
              <div
                id="output"
                class="output-content tex2jax_process"
                aria-live="polite"
                role="region"
                aria-label="Converted HTML output"
              >
                <p>Output will appear here once the module loads...</p>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="controls">
        <div class="control-group">
          <label for="arguments">Pandoc Arguments:</label>
          <input
            type="text"
            id="arguments"
            value="-s --from latex --to html5 --mathjax --number-sections --wrap=preserve --id-prefix=content-"
            aria-describedby="argsHelp"
          />
          <div id="argsHelp" class="sr-only">
            Command line arguments passed to Pandoc. Default converts from LaTeX
            to HTML with MathJax support.
          </div>
        </div>

        <!-- üß™ PANDOC ENHANCEMENT INVESTIGATION CONTROLS -->
        <details
          class="control-group investigation-controls-details"
          id="investigation-details"
          style="
            margin-top: 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            overflow: hidden;
          "
        >
          <summary
            class="investigation-summary"
            aria-expanded="false"
            aria-controls="investigation-content"
            style="
              font-weight: 600;
              color: var(--heading-color);
              padding: 1rem;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              background: var(--surface-color);
              border: none;
              outline: none;
              transition: all 0.3s ease;
              position: relative;
              user-select: none;
              width: 100%;
              box-sizing: border-box;
              margin: 0;
            "
          >
            <svg
              class="action-icon coffee-icon"
              height="24"
              width="24"
              viewBox="0 0 21 21"
              aria-hidden="true"
            >
              <g
                fill="none"
                fill-rule="evenodd"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                transform="translate(4 2)"
              >
                <path
                  d="m2.5 6.5h6c1.1045695 0 2 .8954305 2 2v2.5c0 2.4852814-2.01471863 4.5-4.5 4.5h-1c-2.48528137 0-4.5-2.0147186-4.5-4.5v-2.5c0-1.1045695.8954305-2 2-2zm8 2h1c1.1045695 0 2 .8954305 2 2s-.8954305 2-2 2h-1"
                />
                <path d="m4.5 4.5v-4" />
                <path d="m6.5 4.5v-2" />
              </g>
            </svg>
            Pandoc Enhancement Investigation
            <svg
              class="investigation-chevron"
              height="20"
              width="20"
              viewBox="0 0 24 24"
              aria-hidden="true"
              style="
                margin-left: auto;
                transition: transform 0.3s ease;
                transform: rotate(0deg);
              "
            >
              <path
                d="M6 9l6 6 6-6"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </summary>
          <div
            id="investigation-content"
            class="investigation-content"
            style="padding: 0 1rem 1rem 1rem; margin-left: 0.5rem"
          >
            <!-- Checkbox removed - preset dropdown now serves as the single control -->
            <div class="form-group" style="margin-bottom: 0.5rem">
              <label
                for="pandoc-enhancement-preset"
                style="
                  display: block;
                  margin-bottom: 0.25rem;
                  font-size: 0.9rem;
                "
                >Enhancement Preset:</label
              >
              <select
                id="pandoc-enhancement-preset"
                aria-describedby="preset-help"
              >
                <option value="">None (Standard Arguments)</option>
                <option value="semantic">Semantic HTML Focus</option>
                <option value="accessibility">Accessibility Enhanced</option>
                <option value="structure">Document Structure</option>
                <option value="theorem">Theorem Environment Focus</option>
                <option value="custom">Custom Arguments</option>
              </select>
              <div id="preset-help" class="sr-only">
                Choose enhancement level for Pandoc argument processing. Select
                'None' to use standard arguments only.
              </div>
            </div>

            <!-- Custom Arguments Input (initially hidden) -->
            <div
              class="form-group"
              id="custom-args-container"
              style="margin-bottom: 0.75rem; display: none"
            >
              <label
                for="custom-pandoc-args"
                style="
                  display: block;
                  margin-bottom: 0.25rem;
                  font-size: 0.9rem;
                  font-weight: 500;
                "
                >Custom Pandoc Arguments:</label
              >
              <textarea
                id="custom-pandoc-args"
                style="
                  width: 100%;
                  padding: 0.4rem;
                  border: 1px solid var(--sidebar-border);
                  border-radius: 4px;
                  background: var(--body-bg);
                  font-family: monospace;
                  font-size: 0.85rem;
                  min-height: 60px;
                  resize: vertical;
                "
                placeholder="Enter custom Pandoc arguments, e.g:&#10;--section-divs --wrap=preserve&#10;--html-q-tags"
                aria-describedby="custom-args-help"
              ></textarea>
              <div
                id="custom-args-help"
                style="
                  font-size: 0.8rem;
                  color: var(--text-secondary);
                  margin-top: 0.25rem;
                "
              >
                Enter additional Pandoc arguments separated by spaces. These
                will be added to the base arguments.
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 0.75rem">
              <input
                type="checkbox"
                id="pandoc-comparison-mode"
                aria-describedby="comparison-help"
              />
              <label for="pandoc-comparison-mode" style="font-weight: 500"
                >Show Comparison View</label
              >
              <div id="comparison-help" class="sr-only">
                Display side-by-side comparison of standard versus enhanced
                conversion output
              </div>
            </div>

            <div class="form-group" style="margin-bottom: 0.75rem">
              <input
                type="checkbox"
                id="hide-latex-input"
                aria-describedby="hide-input-help"
              />
              <label for="hide-latex-input" style="font-weight: 500"
                >Hide LaTeX Input Panel</label
              >
              <div id="hide-input-help" class="sr-only">
                Hide the LaTeX input panel to provide more space for comparison
                view
              </div>
            </div>
            <div
              class="form-group"
              style="margin: 0; display: flex; align-items: center; gap: 0.5rem"
            >
              <input
                type="checkbox"
                id="export-enhanced-pandoc"
                aria-describedby="export-enhanced-help"
                style="margin: 0"
              />
              <label
                for="export-enhanced-pandoc"
                style="display: flex; align-items: center; gap: 0.5rem"
              >
                <svg
                  class="action-icon coffee-icon"
                  height="24"
                  width="24"
                  viewBox="0 0 21 21"
                  aria-hidden="true"
                >
                  <g
                    fill="none"
                    fill-rule="evenodd"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    transform="translate(4 2)"
                  >
                    <path
                      d="m2.5 6.5h6c1.1045695 0 2 .8954305 2 2v2.5c0 2.4852814-2.01471863 4.5-4.5 4.5h-1c-2.48528137 0-4.5-2.0147186-4.5-4.5v-2.5c0-1.1045695.8954305-2 2-2zm8 2h1c1.1045695 0 2 .8954305 2 2s-.8954305 2-2 2h-1"
                    />
                    <path d="m4.5 4.5v-4" />
                    <path d="m6.5 4.5v-2" />
                  </g>
                </svg>
                Use Enhanced Pandoc for Export
              </label>
            </div>
            <div
              id="export-enhanced-help"
              style="
                font-size: 0.8rem;
                color: var(--text-secondary);
                margin-top: 0.5rem;
                margin-left: 1.5rem;
              "
            >
              Apply investigation findings to export: Use enhanced Pandoc
              arguments to potentially eliminate post-processing and generate
              better semantic HTML natively.
            </div>
            <div
              id="export-enhanced-status"
              style="
                font-size: 0.8rem;
                margin-top: 0.5rem;
                margin-left: 1.5rem;
                font-style: italic;
                color: var(--text-secondary);
              "
            >
              <span id="export-method-indicator"
                >Standard export method will be used.</span
              >
            </div>

            <div id="investigation-info" aria-live="polite">
              <strong>Investigation Goal:</strong> Test different Pandoc
              argument combinations to improve HTML output quality and semantic
              structure. Select a preset above to enable enhanced processing.
              <div
                id="preset-explanation"
                style="
                  margin-top: 0.5rem;
                  padding-top: 0.5rem;
                  border-top: 1px solid var(--border-color);
                "
              >
                <em
                  >Select an enhancement preset above to see technical details
                  about the Pandoc arguments and their expected HTML output
                  improvements.</em
                >
              </div>
              <div style="margin-top: 0.75rem">
                <button
                  id="refresh-output-button"
                  type="button"
                  aria-describedby="refresh-help"
                >
                  <svg
                    class="heading-icon reset-heading-icon"
                    height="20"
                    width="20"
                    viewBox="0 0 21 21"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="matrix(0 1 1 0 2.5 2.5)"
                    >
                      <path
                        d="m3.98652376 1.07807068c-2.38377179 1.38514556-3.98652376 3.96636605-3.98652376 6.92192932 0 4.418278 3.581722 8 8 8s8-3.581722 8-8-3.581722-8-8-8"
                      ></path>
                      <path
                        d="m4 1v4h-4"
                        transform="matrix(1 0 0 -1 0 6)"
                      ></path>
                    </g>
                  </svg>
                  Refresh Output to Use These Enhancement Settings
                </button>
                <div
                  id="refresh-help"
                  style="
                    font-size: 0.8rem;
                    color: var(--text-secondary);
                    margin-top: 0.25rem;
                    text-align: center;
                  "
                >
                  Re-processes the current input content with the investigation
                  settings above
                </div>
              </div>
            </div>
          </div>
        </details>
      </footer>
    </main>
    <script>
      /**
       * Enhanced Investigation Details/Summary Accessibility Manager
       * Provides proper ARIA attributes and screen reader support
       */
      (function () {
        "use strict";

        /**
         * Initialize investigation details accessibility
         */
        function initializeInvestigationDetails() {
          const details = document.getElementById("investigation-details");
          const summary = details?.querySelector(".investigation-summary");
          const content = document.getElementById("investigation-content");

          if (!details || !summary || !content) {
            console.warn("Investigation details elements not found");
            return;
          }

          // Set initial ARIA states
          updateAriaStates();

          // Listen for toggle events
          details.addEventListener("toggle", handleToggle);

          // Enhanced keyboard support
          summary.addEventListener("keydown", handleKeydown);

          // Mouse interaction
          summary.addEventListener("click", handleClick);

          console.log("‚úÖ Investigation details accessibility initialized");

          /**
           * Update ARIA attributes based on current state
           */
          function updateAriaStates() {
            const isOpen = details.hasAttribute("open");

            // Update aria-expanded on summary
            summary.setAttribute("aria-expanded", isOpen.toString());

            // Update content visibility for screen readers
            if (isOpen) {
              content.removeAttribute("aria-hidden");
              content.setAttribute("aria-live", "polite");
            } else {
              content.setAttribute("aria-hidden", "true");
              content.removeAttribute("aria-live");
            }
          }

          /**
           * Handle details toggle event
           */
          function handleToggle() {
            updateAriaStates();
            announceStateChange();

            // Optional: Save state to localStorage for persistence
            try {
              localStorage.setItem(
                "investigation-details-open",
                details.hasAttribute("open")
              );
            } catch (e) {
              // Silently fail if localStorage is not available
            }
          }

          /**
           * Handle keyboard interaction
           */
          function handleKeydown(event) {
            // Only handle Enter and Space - let details handle the rest
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();

              // Toggle the details
              if (details.hasAttribute("open")) {
                details.removeAttribute("open");
              } else {
                details.setAttribute("open", "");
              }

              // Manually trigger toggle event for our handler
              details.dispatchEvent(new Event("toggle"));
            }
          }

          /**
           * Handle mouse click
           */
          function handleClick() {
            // Let the browser handle the toggle, our toggle event will fire
            // This ensures consistent behavior between mouse and keyboard
          }

          /**
           * Announce state change to screen readers
           */
          function announceStateChange() {
            const isOpen = details.hasAttribute("open");
            const message = isOpen
              ? "Investigation controls expanded. Form controls are now available."
              : "Investigation controls collapsed.";

            announceToScreenReader(message);
          }

          /**
           * Announce message to screen readers
           */
          function announceToScreenReader(message) {
            const announcement = document.createElement("div");
            announcement.setAttribute("aria-live", "polite");
            announcement.setAttribute("aria-atomic", "true");
            announcement.setAttribute("role", "status");
            announcement.textContent = message;

            // Screen reader only styles
            announcement.style.cssText = `
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      `;

            document.body.appendChild(announcement);

            // Remove after screen readers have processed it
            setTimeout(() => {
              if (document.body.contains(announcement)) {
                document.body.removeChild(announcement);
              }
            }, 1000);
          }

          /**
           * Restore saved state on page load
           */
          function restoreSavedState() {
            try {
              const savedState = localStorage.getItem(
                "investigation-details-open"
              );
              if (savedState === "true") {
                details.setAttribute("open", "");
                updateAriaStates();
              }
            } catch (e) {
              // Silently fail if localStorage is not available
            }
          }

          // Restore state after a short delay to ensure DOM is ready
          setTimeout(restoreSavedState, 100);
        }

        /**
         * Initialize when DOM is ready
         */
        if (document.readyState === "loading") {
          document.addEventListener(
            "DOMContentLoaded",
            initializeInvestigationDetails
          );
        } else {
          initializeInvestigationDetails();
        }

        // Export for external access if needed
        window.InvestigationDetailsManager = {
          initialize: initializeInvestigationDetails,
        };
      })();
    </script>
    <!-- Enhanced Theme Toggle Script with System Preference Detection -->
    <script>
      // Enhanced Theme Management with System Preference Support
      (function () {
        "use strict";

        // Logging configuration
        const LOG_LEVELS = {
          ERROR: 0,
          WARN: 1,
          INFO: 2,
          DEBUG: 3,
        };

        const DEFAULT_LOG_LEVEL = LOG_LEVELS.WARN;
        const ENABLE_ALL_LOGGING = false;
        const DISABLE_ALL_LOGGING = false;

        function shouldLog(level) {
          if (DISABLE_ALL_LOGGING) return false;
          if (ENABLE_ALL_LOGGING) return true;
          return level <= DEFAULT_LOG_LEVEL;
        }

        function logError(message, ...args) {
          if (shouldLog(LOG_LEVELS.ERROR)) console.error(message, ...args);
        }

        function logWarn(message, ...args) {
          if (shouldLog(LOG_LEVELS.WARN)) console.warn(message, ...args);
        }

        function logInfo(message, ...args) {
          if (shouldLog(LOG_LEVELS.INFO)) console.log(message, ...args);
        }

        function logDebug(message, ...args) {
          if (shouldLog(LOG_LEVELS.DEBUG)) console.log(message, ...args);
        }

        // Theme configuration
        const THEME_CONFIG = {
          defaultTheme: "light",
          storageKey: "pandoc-playground-theme",
          enableTransitions: true,
          respectSystemPreference: true,
        };

        // Get DOM elements
        const themeToggle = document.getElementById("theme-toggle");
        const themeIcon = themeToggle?.querySelector(".theme-toggle-icon");
        const themeText = themeToggle?.querySelector(".theme-toggle-text");

        /**
         * Get user's preferred theme based on storage and system preferences
         * @returns {string} 'light' or 'dark'
         */
        function getPreferredTheme() {
          // Check stored preference first
          const stored = localStorage.getItem(THEME_CONFIG.storageKey);
          if (stored) {
            logDebug("Using stored theme preference:", stored);
            return stored;
          }

          // Check system preference if enabled
          if (THEME_CONFIG.respectSystemPreference) {
            if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
              logInfo("Using system preference: dark");
              return "dark";
            }
            if (window.matchMedia("(prefers-color-scheme: light)").matches) {
              logInfo("Using system preference: light");
              return "light";
            }
          }

          // Default fallback
          logDebug("Using default theme:", THEME_CONFIG.defaultTheme);
          return THEME_CONFIG.defaultTheme;
        }

        /**
         * Set theme and update UI elements
         * @param {string} theme - 'light' or 'dark'
         */
        function setTheme(theme) {
          if (theme !== "light" && theme !== "dark") {
            logWarn("Invalid theme:", theme, "defaulting to light");
            theme = "light";
          }

          // Apply theme to document
          document.documentElement.setAttribute("data-theme", theme);

          // Store preference
          localStorage.setItem(THEME_CONFIG.storageKey, theme);

          // SVG icon definitions
          const lightModeIcon = `<svg height="24" width="24" viewBox="210 0 21 21" class="action-icon theme-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="m220.5 2.5v2"/><path d="m227 5-1.5 1.5"/><circle cx="220.5" cy="11.5" r="4"/><path d="m214 5 1.5 1.5"/><path d="m220.5 20.5v-2"/><path d="m227 18-1.5-1.5"/><path d="m214 18 1.5-1.5"/><path d="m211.5 11.5h2"/><path d="m227.5 11.5h2"/></g></svg>`;

          const darkModeIcon = `<svg height="24" width="24" viewBox="0 0 21 21" class="action-icon theme-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="m7.5.5c1.3280962 0 2.5698071.36985953 3.6277499 1.01219586-3.14075981.19184303-5.6277499 2.79938976-5.6277499 5.98780414 0 3.1884144 2.48699009 5.7959611 5.6269199 5.9885898-1.0571128.6415507-2.2988237 1.0114102-3.6269199 1.0114102-3.86599325 0-7-3.1340068-7-7 0-3.86599325 3.13400675-7 7-7z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" transform="translate(4 3)"/></svg>`;

          // Update theme toggle UI
          if (theme === "dark") {
            if (themeIcon) themeIcon.innerHTML = lightModeIcon;
            if (themeText) themeText.textContent = "Light";
            if (themeToggle)
              themeToggle.setAttribute("aria-label", "Switch to light mode");
          } else {
            if (themeIcon) themeIcon.innerHTML = darkModeIcon;
            if (themeText) themeText.textContent = "Dark";
            if (themeToggle)
              themeToggle.setAttribute("aria-label", "Switch to dark mode");
          }

          // Update aria-pressed state for better accessibility
          if (themeToggle) {
            themeToggle.setAttribute("aria-pressed", theme === "dark");
          }

          // Announce theme change to screen readers
          announceThemeChange(theme);

          logInfo("‚úÖ Theme set to:", theme);
        }

        /**
         * Toggle between light and dark themes
         * @returns {string} The new theme that was set
         */
        function toggleTheme() {
          const current =
            document.documentElement.getAttribute("data-theme") || "light";
          const newTheme = current === "light" ? "dark" : "light";
          setTheme(newTheme);
          return newTheme;
        }

        /**
         * Announce theme change to screen readers
         * @param {string} theme - The new theme
         */
        function announceThemeChange(theme) {
          const announcement = document.createElement("div");
          announcement.setAttribute("aria-live", "polite");
          announcement.setAttribute("role", "status");
          announcement.textContent = `Theme changed to ${theme} mode`;

          // Screen reader only styles
          announcement.style.cssText = `
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      `;

          document.body.appendChild(announcement);
          setTimeout(() => {
            if (document.body.contains(announcement)) {
              document.body.removeChild(announcement);
            }
          }, 1000);
        }

        /**
         * Setup smooth transitions for theme changes
         */
        function setupThemeTransitions() {
          // Check for reduced motion preference
          if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            logInfo(
              "‚ö†Ô∏è Respecting reduced motion preference - transitions disabled"
            );
            return;
          }

          const style = document.createElement("style");
          style.id = "theme-transitions";
          style.textContent = `
        :root {
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        body {
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        .theme-toggle {
          transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
      `;
          document.head.appendChild(style);
          logDebug("‚úÖ Theme transitions enabled");
        }

        /**
         * Initialise theme management system
         */
        function initialiseThemeSystem() {
          logInfo("üé® Initialising theme management system...");

          if (THEME_CONFIG.enableTransitions) {
            setupThemeTransitions();
          }

          // Set initial theme
          const initialTheme = getPreferredTheme();
          setTheme(initialTheme);

          // Setup theme toggle button
          if (themeToggle) {
            // Click handler
            themeToggle.addEventListener("click", function (event) {
              event.preventDefault();
              toggleTheme();
            });

            // Keyboard support (Enter and Space)
            themeToggle.addEventListener("keydown", function (event) {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                toggleTheme();
              }
            });

            logDebug(
              "‚úÖ Theme toggle button initialised with full keyboard support"
            );
          }

          // Listen for system theme changes
          if (THEME_CONFIG.respectSystemPreference && window.matchMedia) {
            const mediaQuery = window.matchMedia(
              "(prefers-color-scheme: dark)"
            );

            // Use modern addEventListener or fallback to addListener
            const addListener =
              mediaQuery.addEventListener || mediaQuery.addListener;
            if (addListener) {
              const handler = function (e) {
                // Only auto-switch if user hasn't manually set a preference
                if (!localStorage.getItem(THEME_CONFIG.storageKey)) {
                  setTheme(e.matches ? "dark" : "light");
                  logInfo(
                    "üîÑ Auto-switched theme based on system preference:",
                    e.matches ? "dark" : "light"
                  );
                }
              };

              if (mediaQuery.addEventListener) {
                mediaQuery.addEventListener("change", handler);
              } else {
                mediaQuery.addListener(handler);
              }

              logInfo("‚úÖ System theme preference monitoring enabled");
            }
          }

          logInfo("‚úÖ Theme management system fully initialised");

          // Log current configuration for debugging
          logDebug("üé® Theme Configuration:", {
            defaultTheme: THEME_CONFIG.defaultTheme,
            enableTransitions: THEME_CONFIG.enableTransitions,
            respectSystemPreference: THEME_CONFIG.respectSystemPreference,
            currentTheme: document.documentElement.getAttribute("data-theme"),
            systemPrefersDark: window.matchMedia("(prefers-color-scheme: dark)")
              .matches,
          });
        }

        // Export functions for global access
        window.setTheme = setTheme;
        window.getPreferredTheme = getPreferredTheme;
        window.toggleTheme = toggleTheme;

        // Initialise when DOM is ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initialiseThemeSystem);
        } else {
          initialiseThemeSystem();
        }

        logInfo("‚úÖ Enhanced theme management module loaded");
      })();
    </script>
    <script>
      // Quick annotation debugging commands
      window.annotationDebug = {
        check: () => {
          const math = document.querySelectorAll("mjx-container").length;
          const annotations = document.querySelectorAll(
            'annotation[encoding="application/x-tex"]'
          ).length;
          const quality = window.checkAnnotationQuality
            ? window.checkAnnotationQuality()
            : { total: 0, percentage: 0 };

          console.log("üîç Annotation Debug:", {
            mathElements: math,
            annotations: annotations,
            qualityTotal: quality.total || 0,
            qualityPercentage: quality.percentage || 0,
            ratio:
              math > 0 ? ((annotations / math) * 100).toFixed(1) + "%" : "0%",
          });

          return { math, annotations, quality };
        },

        waitForAnnotations: async (maxWaitMs = 5000) => {
          const startTime = Date.now();
          let annotations = 0;

          while (annotations === 0 && Date.now() - startTime < maxWaitMs) {
            annotations = document.querySelectorAll(
              'annotation[encoding="application/x-tex"]'
            ).length;
            if (annotations === 0) {
              await new Promise((resolve) => setTimeout(resolve, 200));
            }
          }

          console.log(
            `‚è±Ô∏è Annotation wait completed: ${annotations} found in ${
              Date.now() - startTime
            }ms`
          );
          return annotations;
        },
      };

      // Enhanced example loading testing
      window.exampleDebug = {
        // Test current example loading
        testCurrent: async () => {
          console.log("üß™ Testing current example loading process...");
          const timeline =
            await TestExampleAnnotationTiming.monitorExampleLoadingProcess(
              "statistics"
            );
          console.log("üìä Timeline:", timeline);
          return timeline;
        },

        // Test specific example
        testExample: async (key = "basic-math") => {
          console.log(`üß™ Testing example: ${key}`);

          // Clear first
          const input = document.getElementById("input");
          if (input) input.value = "";

          await new Promise((resolve) => setTimeout(resolve, 500));

          // Load and monitor
          const startTime = Date.now();
          window.ExampleSystem.loadExample(key);

          // Wait and check
          await new Promise((resolve) => setTimeout(resolve, 3000));

          const result = {
            loadTime: Date.now() - startTime,
            mathElements: document.querySelectorAll("mjx-container").length,
            annotations: document.querySelectorAll(
              'annotation[encoding="application/x-tex"]'
            ).length,
            quality: window.checkAnnotationQuality
              ? window.checkAnnotationQuality()
              : null,
          };

          console.log("üìä Result:", result);
          return result;
        },

        // Compare methods
        compareMethods: () =>
          TestExampleAnnotationTiming.testExampleLoadingMethods(),
      };
    </script>

    <!-- Application State Setup -->
    <script>
      // Setup global app elements for module access
      document.addEventListener("DOMContentLoaded", function () {
        // Make key elements globally available for modules
        window.appElements = {
          inputTextarea: document.getElementById("input"),
          outputDiv: document.getElementById("output"),
          argumentsInput: document.getElementById("arguments"),
          exportButton: document.getElementById("exportButton"),
          statusDot: document.getElementById("statusDot"),
          statusText: document.getElementById("statusText"),
          statusProgress: document.getElementById("statusProgress"),
          statusProgressBar: document.getElementById("statusProgressBar"),
          exampleSelect: document.getElementById("example-select"),
          randomExampleBtn: document.getElementById("random-example-btn"),
        };

        console.log("‚úÖ Global app elements setup complete");
      });

      /**
       * üöÄ OPTIMIZED: Fast input clearing with confirmation modal
       * Properly integrates with Live LaTeX Editor system and UniversalModal
       */
      async function clearInputOptimized() {
        console.log(
          "üöÄ Starting optimized input clearing with confirmation..."
        );

        try {
          const clearButton = document.getElementById("clearInputButton");
          if (!clearButton) {
            console.warn("‚ö†Ô∏è Clear button not found");
            return;
          }

          // Check if there's content to clear
          const currentContent = getCurrentInputContent
            ? getCurrentInputContent()
            : "";
          const hasContent = currentContent && currentContent.trim().length > 0;

          if (!hasContent) {
            console.log("‚ÑπÔ∏è No content to clear - skipping confirmation");

            // Still provide user feedback
            if (window.AppConfig?.announceToScreenReader) {
              window.AppConfig.announceToScreenReader("No content to clear");
            }

            if (window.StatusManager) {
              window.StatusManager.setReady("No content to clear");
            }
            return;
          }

          // Show confirmation modal
          let confirmed = false;

          if (
            window.UniversalModal &&
            typeof window.UniversalModal.confirm === "function"
          ) {
            const contentLength = currentContent.length;
            const contentPreview =
              contentLength > 50
                ? currentContent.substring(0, 47) + "..."
                : currentContent;

            confirmed = await window.UniversalModal.confirm(
              `Clear all LaTeX content?`,
              {
                message: `This will permanently remove ${contentLength} characters of content:\n\n"${contentPreview}"`,
                confirmText: "Clear Content",
                cancelText: "Keep Content",
                type: "warning",
              }
            );
          } else {
            // Fallback to native confirm if UniversalModal not available
            console.warn(
              "‚ö†Ô∏è UniversalModal not available - using native confirmation"
            );
            confirmed = confirm(
              `Clear all LaTeX content?\n\nThis will permanently remove ${currentContent.length} characters of content.`
            );
          }

          if (!confirmed) {
            console.log("‚ÑπÔ∏è User cancelled content clearing");

            if (window.AppConfig?.announceToScreenReader) {
              window.AppConfig.announceToScreenReader(
                "Content clearing cancelled"
              );
            }

            return;
          }

          // User confirmed - proceed with clearing
          console.log("‚úÖ User confirmed clearing - proceeding...");
          const startTime = performance.now();

          // Show immediate feedback
          const originalText = clearButton.innerHTML;
          clearButton.classList.add("clearing");
          clearButton.innerHTML =
            '<svg height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" class="clear-icon"><circle cx="12" cy="12" r="10"/><path d="m9,9l6,6"/><path d="m9,15l6,-6"/></svg>Clearing...';
          clearButton.disabled = true;

          // 1. FAST: Clear all input elements (Live LaTeX Editor system)

          // Find the original textarea (hidden by Live LaTeX Editor)
          const textarea = document.getElementById("input");
          // Find the contenteditable div (what user sees)
          const contentEditable = document.getElementById(
            "input-contenteditable"
          );
          // Find the hidden input (form submission)
          const hiddenInput = document.getElementById("input-hidden");

          if (textarea) {
            textarea.value = "";
            console.log("‚úÖ Original textarea cleared");
          }

          if (contentEditable) {
            contentEditable.textContent = "";
            console.log("‚úÖ ContentEditable div cleared");
          }

          if (hiddenInput) {
            hiddenInput.value = "";
            console.log("‚úÖ Hidden input cleared");
          }

          // 2. Sync with Live LaTeX Editor if available
          if (window.LiveLatexEditor && window.LiveLatexEditor.isInitialised) {
            try {
              // Use Live LaTeX Editor's setContent method for proper sync
              if (window.LiveLatexEditor.setContent) {
                window.LiveLatexEditor.setContent("");
                console.log(
                  "‚úÖ Live LaTeX Editor content cleared via setContent"
                );
              } else if (window.LiveLatexEditor.syncHiddenInput) {
                window.LiveLatexEditor.syncHiddenInput();
                console.log("‚úÖ Live LaTeX Editor synced via syncHiddenInput");
              }
            } catch (editorError) {
              console.warn("‚ö†Ô∏è Live LaTeX Editor sync failed:", editorError);
            }
          }

          // 3. Clear output immediately
          const outputDiv = document.getElementById("output");
          if (outputDiv) {
            outputDiv.innerHTML =
              '<p class="placeholder-text">Content cleared. Enter LaTeX above to see the rendered output.</p>';
            console.log("‚úÖ Output div cleared");
          }

          // 4. Trigger optimized memory cleanup
          if (window.ConversionEngine?.manager?.performDOMCleanup) {
            window.ConversionEngine.manager.performDOMCleanup();
            console.log("‚úÖ Memory cleanup performed");
          }

          // 5. Update status
          if (window.StatusManager) {
            window.StatusManager.setReady(
              "Input cleared - ready for new content"
            );
          }

          // 6. Announce to screen readers
          if (window.AppConfig?.announceToScreenReader) {
            window.AppConfig.announceToScreenReader(
              "Input and output cleared successfully"
            );
          }

          // 7. Show success notification
          if (
            window.UniversalNotifications &&
            typeof window.UniversalNotifications.success === "function"
          ) {
            window.UniversalNotifications.success(
              "Content cleared successfully"
            );
          }

          // 8. Reset export button state
          const exportButton = document.getElementById("exportButton");
          if (exportButton) {
            exportButton.disabled = false;
          }

          const endTime = performance.now();
          const clearTime = endTime - startTime;

          console.log(
            `‚úÖ Complete input clearing finished in ${clearTime.toFixed(1)}ms`
          );

          // Reset button after showing success briefly
          setTimeout(() => {
            clearButton.classList.remove("clearing");
            clearButton.innerHTML = originalText;
            clearButton.disabled = false;
          }, 500);

          // Optional: Trigger memory diagnostics
          if (window.memoryCommands) {
            setTimeout(() => {
              const metrics = window.memoryCommands.check();
              console.log("üìä Post-clear memory:", metrics);
            }, 100);
          }
        } catch (error) {
          console.error("‚ùå Error during optimized clear:", error);

          // Reset button on error
          const clearButton = document.getElementById("clearInputButton");
          if (clearButton) {
            const originalText = clearButton.innerHTML;
            clearButton.classList.remove("clearing");
            clearButton.innerHTML =
              originalText ||
              `<svg height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" class="clear-icon">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                  Clear`;
            clearButton.disabled = false;
          }

          // Show error notification
          if (
            window.UniversalNotifications &&
            typeof window.UniversalNotifications.error === "function"
          ) {
            window.UniversalNotifications.error(
              "Failed to clear content - please try again"
            );
          }
        }
      }
      // Logging configuration for file operations
      const LOG_LEVELS = {
        ERROR: 0,
        WARN: 1,
        INFO: 2,
        DEBUG: 3,
      };

      const DEFAULT_LOG_LEVEL = LOG_LEVELS.WARN;
      const ENABLE_ALL_LOGGING = false;
      const DISABLE_ALL_LOGGING = false;

      function shouldLog(level) {
        if (DISABLE_ALL_LOGGING) return false;
        if (ENABLE_ALL_LOGGING) return true;
        return level <= DEFAULT_LOG_LEVEL;
      }

      function logError(message, ...args) {
        if (shouldLog(LOG_LEVELS.ERROR)) console.error(message, ...args);
      }

      function logWarn(message, ...args) {
        if (shouldLog(LOG_LEVELS.WARN)) console.warn(message, ...args);
      }

      function logInfo(message, ...args) {
        if (shouldLog(LOG_LEVELS.INFO)) console.log(message, ...args);
      }

      function logDebug(message, ...args) {
        if (shouldLog(LOG_LEVELS.DEBUG)) console.log(message, ...args);
      }

      /**
       * üìÅ Load LaTeX file into editor with full Live LaTeX Editor integration
       * Properly synchronises with all input systems and triggers conversion
       */
      async function loadInputFile() {
        logInfo("üöÄ Starting file load operation...");
        const startTime = performance.now();

        try {
          const loadButton = document.getElementById("loadInputButton");
          const fileInput = document.getElementById("fileLoadInput");

          if (!loadButton || !fileInput) {
            logError("‚ùå Required elements not found");
            return;
          }

          // Show immediate feedback
          const originalText = loadButton.innerHTML;
          loadButton.classList.add("loading");
          loadButton.innerHTML =
            '<svg height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" class="load-icon"><circle cx="12" cy="12" r="10"/><path d="m9,9l6,6"/><path d="m9,15l6,-6"/></svg>Loading...';
          loadButton.disabled = true;

          // Trigger file selection
          fileInput.onchange = async function (event) {
            const file = event.target.files[0];

            if (!file) {
              logWarn("‚ö†Ô∏è No file selected");
              resetLoadButton();
              return;
            }

            logInfo(`üìÑ Loading file: ${file.name} (${file.size} bytes)`);

            try {
              // Read file content
              const content = await readFileContent(file);
              logDebug(`üìù File content length: ${content.length} characters`);

              // Clear existing content first
              await clearInputOptimized();

              // Small delay to ensure clearing is complete
              await new Promise((resolve) => setTimeout(resolve, 100));

              // Set content using all available methods for maximum compatibility
              await setInputContent(content);

              // Announce success
              if (window.AppConfig?.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  `File ${file.name} loaded successfully with ${content.length} characters`
                );
              }

              // Update status
              if (window.StatusManager) {
                window.StatusManager.setReady(
                  `File ${file.name} loaded successfully`
                );
              }

              const endTime = performance.now();
              const loadTime = endTime - startTime;
              logInfo(`‚úÖ File load completed in ${loadTime.toFixed(1)}ms`);

              // Reset file input for future use
              fileInput.value = "";
            } catch (fileError) {
              logError("‚ùå Error reading file:", fileError);

              // Show user-friendly error
              if (window.AppConfig?.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Error loading file. Please ensure it's a valid text file."
                );
              }

              if (window.StatusManager) {
                window.StatusManager.setError("Failed to load file");
              }
            }

            resetLoadButton();
          };

          // Trigger file picker
          fileInput.click();

          function resetLoadButton() {
            setTimeout(() => {
              loadButton.classList.remove("loading");
              loadButton.innerHTML = originalText;
              loadButton.disabled = false;
            }, 500);
          }
        } catch (error) {
          logError("‚ùå Error during file load setup:", error);

          const loadButton = document.getElementById("loadInputButton");
          if (loadButton) {
            loadButton.innerHTML = originalText || loadButton.innerHTML;
            loadButton.disabled = false;
          }
        }
      }

      /**
       * üìñ Read file content as text
       */
      function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = function (event) {
            resolve(event.target.result);
          };

          reader.onerror = function (event) {
            reject(new Error(`File reading failed: ${event.target.error}`));
          };

          // Read as text with UTF-8 encoding
          reader.readAsText(file, "UTF-8");
        });
      }

      /**
       * ‚úçÔ∏è Set content in all input systems with proper synchronisation
       */
      async function setInputContent(content) {
        logInfo("üîÑ Setting input content with full synchronisation...");

        // Find all input elements
        const textarea = document.getElementById("input");
        const contentEditable = document.getElementById(
          "input-contenteditable"
        );
        const hiddenInput = document.getElementById("input-hidden");

        // Set content in all elements
        if (textarea) {
          textarea.value = content;
          logDebug("‚úÖ Original textarea content set");
        }

        if (contentEditable) {
          contentEditable.textContent = content;
          logDebug("‚úÖ ContentEditable div content set");
        }

        if (hiddenInput) {
          hiddenInput.value = content;
          logDebug("‚úÖ Hidden input content set");
        }

        // Sync with Live LaTeX Editor if available
        if (window.LiveLatexEditor && window.LiveLatexEditor.isInitialised) {
          try {
            if (window.LiveLatexEditor.setContent) {
              window.LiveLatexEditor.setContent(content);
              logInfo("‚úÖ Live LaTeX Editor content set via setContent method");
            } else {
              // Force update the contenteditable and sync
              if (contentEditable) {
                contentEditable.textContent = content;
                if (window.LiveLatexEditor.updateHighlighting) {
                  window.LiveLatexEditor.updateHighlighting();
                }
                if (window.LiveLatexEditor.syncHiddenInput) {
                  window.LiveLatexEditor.syncHiddenInput("load");
                }
              }
              logInfo("‚úÖ Live LaTeX Editor synced via manual update");
            }
          } catch (editorError) {
            logWarn(
              "‚ö†Ô∏è Live LaTeX Editor sync failed, using fallback:",
              editorError
            );
          }
        }

        // Trigger input event to start conversion process
        if (textarea) {
          const inputEvent = new Event("input", {
            bubbles: true,
            cancelable: true,
          });
          textarea.dispatchEvent(inputEvent);
          logDebug("‚úÖ Input event dispatched to trigger conversion");
        }

        // Ensure automatic conversions are enabled
        if (window.ConversionEngine) {
          window.ConversionEngine.automaticConversionsDisabled = false;
          if (window.ConversionEngine.invalidateAutomaticConversionsCache) {
            window.ConversionEngine.invalidateAutomaticConversionsCache();
          }
          logDebug("‚úÖ Automatic conversions ensured enabled");
        }
      }
      /**
       * üíæ Save current LaTeX content to file
       * Retrieves content from Live LaTeX Editor system and saves as .tex file
       */
      async function saveInputFile() {
        logInfo("üöÄ Starting file save operation...");
        const startTime = performance.now();

        try {
          const saveButton = document.getElementById("saveInputButton");

          if (!saveButton) {
            logError("‚ùå Save button not found");
            return;
          }

          // Show immediate feedback
          const originalText = saveButton.innerHTML;
          saveButton.classList.add("saving");
          saveButton.innerHTML =
            '<svg height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" class="save-icon"><circle cx="12" cy="12" r="10"/><path d="m9,9l6,6"/><path d="m9,15l6,-6"/></svg>Saving...';
          saveButton.disabled = true;

          // Get current content from the most reliable source
          const content = getCurrentInputContent();

          if (!content || content.trim() === "") {
            logWarn("‚ö†Ô∏è No content to save");

            if (window.AppConfig?.announceToScreenReader) {
              window.AppConfig.announceToScreenReader(
                "No content available to save"
              );
            }

            resetSaveButton();
            return;
          }

          // Generate filename with timestamp
          const now = new Date();
          const timestamp = now
            .toISOString()
            .slice(0, 19)
            .replace(/[:.]/g, "-");
          const filename = `latex-document-${timestamp}.tex`;

          // Create and download file
          await downloadTextFile(content, filename);

          // Announce success
          if (window.AppConfig?.announceToScreenReader) {
            window.AppConfig.announceToScreenReader(
              `LaTeX content saved as ${filename} with ${content.length} characters`
            );
          }

          // Update status
          if (window.StatusManager) {
            window.StatusManager.setReady(`File saved as ${filename}`);
          }

          const endTime = performance.now();
          const saveTime = endTime - startTime;
          logInfo(`‚úÖ File save completed in ${saveTime.toFixed(1)}ms`);

          function resetSaveButton() {
            setTimeout(() => {
              saveButton.classList.remove("saving");
              saveButton.innerHTML = originalText;
              saveButton.disabled = false;
            }, 500);
          }

          resetSaveButton();
        } catch (error) {
          logError("‚ùå Error during file save:", error);

          const saveButton = document.getElementById("saveInputButton");
          if (saveButton) {
            saveButton.innerHTML = originalText || saveButton.innerHTML;
            saveButton.disabled = false;
          }
        }
      }

      /**
       * üìÑ Get current input content from the most reliable source
       */
      function getCurrentInputContent() {
        // Priority order: Live LaTeX Editor -> ContentEditable -> Textarea -> Hidden Input

        // Try Live LaTeX Editor first (most reliable)
        if (window.LiveLatexEditor && window.LiveLatexEditor.isInitialised) {
          try {
            if (window.LiveLatexEditor.getContent) {
              const content = window.LiveLatexEditor.getContent();
              if (content && content.trim()) {
                logDebug(
                  "‚úÖ Content retrieved from Live LaTeX Editor getContent method"
                );
                return content;
              }
            }

            if (window.LiveLatexEditor.getPlainTextContent) {
              const content = window.LiveLatexEditor.getPlainTextContent();
              if (content && content.trim()) {
                logDebug(
                  "‚úÖ Content retrieved from Live LaTeX Editor getPlainTextContent method"
                );
                return content;
              }
            }
          } catch (editorError) {
            logWarn(
              "‚ö†Ô∏è Live LaTeX Editor content retrieval failed:",
              editorError
            );
          }
        }

        // Try contenteditable div
        const contentEditable = document.getElementById(
          "input-contenteditable"
        );
        if (contentEditable && contentEditable.textContent.trim()) {
          logDebug("‚úÖ Content retrieved from contenteditable div");
          return contentEditable.textContent;
        }

        // Try original textarea
        const textarea = document.getElementById("input");
        if (textarea && textarea.value.trim()) {
          logDebug("‚úÖ Content retrieved from original textarea");
          return textarea.value;
        }

        // Try hidden input as last resort
        const hiddenInput = document.getElementById("input-hidden");
        if (hiddenInput && hiddenInput.value.trim()) {
          logDebug("‚úÖ Content retrieved from hidden input");
          return hiddenInput.value;
        }

        logWarn("‚ö†Ô∏è No content found in any input source");
        return "";
      }

      /**
       * ‚¨áÔ∏è Download text content as file
       */
      async function downloadTextFile(content, filename) {
        try {
          // Create blob with UTF-8 encoding
          const blob = new Blob([content], {
            type: "text/plain;charset=utf-8",
          });

          // Create download link
          const downloadLink = document.createElement("a");
          downloadLink.href = URL.createObjectURL(blob);
          downloadLink.download = filename;

          // Add to DOM temporarily for accessibility
          downloadLink.style.display = "none";
          downloadLink.setAttribute("aria-hidden", "true");
          document.body.appendChild(downloadLink);

          // Trigger download
          downloadLink.click();

          // Clean up
          setTimeout(() => {
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(downloadLink.href);
          }, 100);

          logInfo(
            `üìÅ File download initiated: ${filename} (${content.length} characters)`
          );
        } catch (error) {
          logError("‚ùå Error creating download:", error);
          throw new Error(`Download failed: ${error.message}`);
        }
      }

      // Make function globally available
      window.clearInputOptimized = clearInputOptimized;
    </script>

    <!-- Modular JavaScript Architecture -->
    <script src="js/plugins/prism.js"></script>
    <!-- Logging System (Foundation) -->
    <script src="./js/pandoc/conversion/logging-system.js"></script>
    <!-- Core Application Modules (Load Order is Critical) -->
    <script src="js/export/app-config.js"></script>
    <!-- UI Systems (Load Early) -->
    <script src="./js/ui/universal-modal.js"></script>
    <script src="./js/ui/universal-notifications.js"></script>
    <!-- Foundation utilities -->
    <script src="js/export/mathjax-manager.js"></script>
    <!-- MathJax controls -->
    <script src="js/export/latex-processor.js"></script>
    <!-- LaTeX processing -->
    <script src="js/export/content-generator.js"></script>
    <!-- CSS & structure -->
    <script src="js/export/template-system.js"></script>
    <!-- HTML generation -->
    <script src="js/export/download-monitor.js"></script>
    <script src="js/export/export-manager.js"></script>
    <script src="./js/export/scorm-export-manager.js"></script>
    <script src="js/export/source-viewer.js"></script>
    <!-- Export orchestration -->

    <!-- Application Feature Modules -->
    <script src="js/pandoc/example-system.js"></script>
    <!-- Example management -->
    <script src="js/pandoc/status-manager.js"></script>
    <!-- Status indicators -->
    <!-- NEW: Utility Functions (Phase 2) -->
    <script src="./js/pandoc/conversion/utils/output-cleaner.js"></script>
    <script src="./js/pandoc/conversion/utils/validation-utilities.js"></script>
    <script src="./js/pandoc/conversion/utils/performance-monitor.js"></script>
    <script src="./js/pandoc/conversion/memory/memory-watchdog.js"></script>
    <script src="./js/pandoc/conversion/memory/cleanup-coordinator.js"></script>
    <script src="./js/pandoc/conversion/memory/dom-cleanup-utilities.js"></script>
    <script src="./js/pandoc/conversion/latex/latex-preservation-engine.js"></script>
    <script src="./js/pandoc/conversion/latex/latex-expression-mapper.js"></script>
    <script src="./js/pandoc/conversion/latex/latex-registry-manager.js"></script>
    <script src="./js/pandoc/conversion/processing/processing-strategy-manager.js"></script>
    <script src="./js/pandoc/conversion/processing/chunked-processing-engine.js"></script>
    <script src="./js/pandoc/conversion/processing/pandoc-argument-enhancer.js"></script>
    <script src="./js/pandoc/conversion/error/error-handler.js"></script>
    <script src="./js/pandoc/conversion/error/error-message-generator.js"></script>
    <script src="./js/pandoc/conversion/error/fallback-coordinator.js"></script>
    <script src="./js/pandoc/conversion/error/accessibility-announcer.js"></script>
    <script src="./js/pandoc/conversion/orchestration/conversion-orchestrator.js"></script>
    <script src="./js/pandoc/conversion/orchestration/event-coordinator.js"></script>
    <script src="./js/pandoc/conversion/orchestration/state-manager.js"></script>
    <script src="./js/pandoc/conversion/orchestration/integration-manager.js"></script>
    <script src="./js/pandoc/conversion/orchestration/final-coordination-manager.js"></script>

    <script src="./js/pandoc/conversion/orchestration/event-dom-manager.js"></script>
    <script src="./js/pandoc/conversion/orchestration/fallback-workflow-manager.js"></script>
    <script src="./js/pandoc/conversion/orchestration/testing-api-manager.js"></script>
    <script src="./js/pandoc/conversion/orchestration/conversion-api-manager.js"></script>
    <script src="./js/pandoc/conversion/utils/cross-reference-fixer.js"></script>

    <!-- Main Conversion Engine -->
    <script src="js/pandoc/conversion-engine.js"></script>

    <!-- LaTeX conversion -->
    <script src="js/pandoc/event-manager.js"></script>
    <!-- Event handling -->

    <!-- Main Application Coordinator -->
    <script src="js/pandoc/app-state-manager.js"></script>
    <!-- Application lifecycle -->
    <!-- Live LaTeX Editor -->
    <script src="js/pandoc/live-latex-editor.js"></script>
    <!-- Live syntax highlighting -->
    <!-- Development Tools (Optional) -->
    <script src="js/pandoc/layout-debugger.js"></script>
    <!-- Layout debugging -->

    <!-- Testing Framework -->
    <!-- <script src="js/export/test-commands.js"></script> -->

    <script src="js/testing/test-utilities.js"></script>
    <script src="./js/testing/individual/test-app-config.js"></script>
    <script src="./js/testing/individual/test-mathjax-manager.js"></script>
    <script src="./js/testing/individual/test-latex-processor.js"></script>
    <script src="./js/testing/individual/test-content-generator.js"></script>
    <script src="./js/testing/individual/test-template-system.js"></script>
    <script src="./js/testing/integration/test-export-pipeline.js"></script>
    <script src="./js/testing/integration/test-modular-integration.js"></script>
    <script src="./js/testing/integration/test-accessibility-integration.js"></script>
    <script src="./js/testing/integration/test-performance.js"></script>
    <script src="./js/testing/individual/test-export-manager.js"></script>
    <script src="./js/testing/individual/test-example-system.js"></script>
    <script src="./js/testing/individual/test-status-manager.js"></script>
    <script src="./js/testing/individual/test-conversion-engine.js"></script>
    <script src="./js/testing/individual/test-event-manager.js"></script>
    <script src="./js/testing/individual/test-app-state-manager.js"></script>
    <script src="./js/testing/individual/test-layout-debugger.js"></script>
    <script src="./js/testing/individual/test-table-enhancements.js"></script>
    <script src="./js/testing/individual/test-scorm-export-manager.js"></script>
    <script src="./js/testing/individual/test-download-monitor.js"></script>
    <script src="./js/testing/individual/test-memory-management.js"></script>
    <script src="./js/testing/individual/test-adaptive-background.js"></script>
    <script src="./js/testing/individual/test-mathjax-accessibility-diagnostics.js"></script>
    <script src="./js/testing/individual/test-annotation-timing.js"></script>
    <script src="js/testing/individual/test-source-viewer.js"></script>
    <script src="js/testing/individual/test-latex-consistency.js"></script>
    <script src="js/testing/individual/test-mathjax-promise-utility.js"></script>
    <script src="js/testing/individual/test-comprehensive-latex-syntax.js"></script>
    <script src="js/testing/individual/test-example-annotation-timing.js"></script>
    <script src="js/testing/individual/test-comprehensive-annotation-diagnostics.js"></script>
    <script src="./js/testing/individual/test-annotation-removal-detective.js"></script>
    <script src="./js/testing/individual/test-conversion-flow-tracing.js"></script>
    <script src="./js/testing/individual/test-cross-reference-fixer.js"></script>

    <script src="js/testing/enhanced/test-mathematical-consistency.js"></script>
    <script src="js/testing/enhanced/test-accessibility-restoration.js"></script>
    <script src="js/testing/enhanced/test-comprehensive-integration.js"></script>
    <script src="js/testing/enhanced/test-enhanced-commands.js"></script>
    <script src="./js/testing/test-framework.js"></script>
    <script src="./js/testing/test-registry.js"></script>
    <script src="./js/testing/comprehensive/test-runner.js"></script>
    <!-- JS Migration testing -->
    <script src="./js/testing/migration/test-initialization-js-migration.js"></script>
    <script src="./js/testing/migration/test-mathjax-controls-js-migration.js"></script>
    <script src="./js/testing/migration/test-reading-tools-setup-js-migration.js"></script>
    <script src="./js/testing/migration/test-theme-management-js-migration.js"></script>
    <script src="./js/testing/migration/test-form-initialization-js-migration.js"></script>
    <script src="./js/testing/migration/test-focus-tracking-js-migration.js"></script>
    <script src="./js/testing/migration/test-reading-accessibility-manager-class-js-migration.js"></script>
    <script src="./js/testing/migration/test-enhanced-javascript-orchestrator-optimization.js"></script>
    <script src="./js/testing/migration/test-accessibility-configuration.js"></script>

    <!-- JS Migration testing ends -->

    <!-- Temporary Foundation Test -->
    <script>
      // Quick validation that TestUtilities is working
      if (typeof TestUtilities !== "undefined") {
        console.log("‚úÖ TestUtilities loaded successfully");

        // Test the core runTestSuite function
        const sampleTests = {
          basicTest: () => true,
          mathTest: () => 2 + 2 === 4,
          stringTest: () => "hello".toUpperCase() === "HELLO",
        };

        const result = TestUtilities.runTestSuite(
          "Foundation Test",
          sampleTests
        );
        console.log("Foundation test result:", result);

        // Test performance measurement
        const perfResult = TestUtilities.measurePerformance(() => {
          Math.sqrt(Math.random() * 1000);
        }, 100);
        console.log("Performance test result:", perfResult);

        // Make foundation test available globally for console testing
        window.testFoundation = () =>
          TestUtilities.runTestSuite("Foundation Test", sampleTests);
      } else {
        console.error("‚ùå TestUtilities failed to load");
      }
    </script>

    <!-- Testing framework -->

    <!-- Investigation Controls Event Handlers -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Handle preset selection to show/hide custom arguments and update explanations
        const presetSelect = document.getElementById(
          "pandoc-enhancement-preset"
        );
        const customArgsContainer = document.getElementById(
          "custom-args-container"
        );
        const presetExplanation = document.getElementById("preset-explanation");

        if (presetSelect && customArgsContainer && presetExplanation) {
          // Define preset explanations with technical precision
          const presetExplanations = {
            "": {
              title: "Standard Arguments Only",
              description:
                "Using base Pandoc arguments: <code>--from latex --to html5 --mathjax</code>. No additional enhancements will be applied. This is the default, stable conversion mode.",
            },
            semantic: {
              title: "Semantic HTML Focus",
              args: "--section-divs --html-q-tags --wrap=preserve",
              description:
                "Produces semantic HTML5 structure: <code>--section-divs</code> wraps sections in &lt;section&gt; elements instead of &lt;div&gt;, <code>--html-q-tags</code> generates proper &lt;q&gt; elements for quotes, <code>--wrap=preserve</code> maintains source line breaks for better readability.",
            },
            accessibility: {
              title: "Accessibility Enhanced",
              args: "--section-divs --id-prefix=content- --html-q-tags --number-sections",
              description:
                "Enhances screen reader navigation: <code>--section-divs</code> creates semantic sections, <code>--id-prefix=content-</code> adds consistent ID prefixes for better landmarks, <code>--html-q-tags</code> uses semantic quote elements, <code>--number-sections</code> automatically numbers headings for structured navigation.",
            },
            structure: {
              title: "Document Structure",
              args: "--section-divs --wrap=preserve --standalone --toc",
              description:
                "Creates comprehensive document structure: <code>--section-divs</code> for semantic sections, <code>--wrap=preserve</code> maintains formatting, <code>--standalone</code> generates complete HTML document with head/body, <code>--toc</code> automatically generates table of contents navigation.",
            },
            theorem: {
              title: "Theorem Environment Focus",
              args: "--section-divs --wrap=preserve --html-q-tags --from=latex+fancy_lists",
              description:
                "Optimises mathematical content processing: <code>--section-divs</code> for semantic structure, <code>--wrap=preserve</code> maintains LaTeX formatting, <code>--html-q-tags</code> for proper quotes, <code>--from=latex+fancy_lists</code> enables enhanced LaTeX list processing for theorem environments.",
            },
            custom: {
              title: "Custom Arguments",
              description:
                "Define your own Pandoc arguments in the text area below. Arguments will be validated and applied during conversion. Use this for testing specific Pandoc features or combining multiple enhancement strategies.",
            },
          };

          presetSelect.addEventListener("change", function () {
            const selectedPreset = this.value;

            // Show/hide custom arguments container
            if (selectedPreset === "custom") {
              customArgsContainer.style.display = "block";
            } else {
              customArgsContainer.style.display = "none";
            }

            // Update preset explanation
            const explanation =
              presetExplanations[selectedPreset] || presetExplanations[""];
            let explanationHTML = `<strong style="color: var(--heading-color);">${explanation.title}</strong>`;

            if (explanation.args) {
              explanationHTML += `<br><code style="background: var(--body-bg); padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8rem;">${explanation.args}</code>`;
            }

            explanationHTML += `<br><span style="margin-top: 0.25rem; display: inline-block;">${explanation.description}</span>`;

            presetExplanation.innerHTML = explanationHTML;

            // Announce change to screen readers
            if (selectedPreset && selectedPreset !== "") {
              const announcement = `Preset changed to ${
                explanation.title
              }. ${explanation.description.replace(/<[^>]*>/g, "")}`;
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(announcement);
              }
            }
          });
        }

        // Handle hide/show LaTeX input panel
        const hideInputCheckbox = document.getElementById("hide-latex-input");
        const inputPanel = document.querySelector(".input-panel");
        const workspace = document.querySelector(".workspace");

        if (hideInputCheckbox && inputPanel && workspace) {
          hideInputCheckbox.addEventListener("change", function () {
            if (this.checked) {
              inputPanel.style.display = "none";
              // Adjust workspace layout to single column
              workspace.style.display = "block";
              const outputPanel = document.querySelector(".output-panel");
              if (outputPanel) {
                outputPanel.style.borderLeft = "none";
                outputPanel.style.width = "100%";
              }
            } else {
              inputPanel.style.display = "flex";
              // Restore workspace layout
              workspace.style.display = "flex";
              const outputPanel = document.querySelector(".output-panel");
              if (outputPanel) {
                outputPanel.style.borderLeft = "";
                outputPanel.style.width = "";
              }
            }
          });
        }

        // Handle export enhancement checkbox
        const exportEnhancedCheckbox = document.getElementById(
          "export-enhanced-pandoc"
        );
        const exportSubtitle = document.getElementById("export-subtitle");
        const exportMethodIndicator = document.getElementById(
          "export-method-indicator"
        );

        if (exportEnhancedCheckbox && exportSubtitle && exportMethodIndicator) {
          exportEnhancedCheckbox.addEventListener("change", function () {
            if (this.checked) {
              exportSubtitle.textContent = "Enhanced Semantic HTML";
              exportMethodIndicator.textContent =
                "Enhanced Pandoc export method will be used (investigation mode).";
              exportMethodIndicator.style.color = "var(--link-color)";
              exportMethodIndicator.style.fontWeight = "500";

              // Announce change to screen readers
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Enhanced Pandoc export enabled. Export will use investigation settings for better semantic HTML."
                );
              }
            } else {
              exportSubtitle.textContent = "Accessible HTML with MathJax";
              exportMethodIndicator.textContent =
                "Standard export method will be used.";
              exportMethodIndicator.style.color = "var(--text-secondary)";
              exportMethodIndicator.style.fontWeight = "normal";

              // Announce change to screen readers
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Enhanced Pandoc export disabled. Standard export method will be used."
                );
              }
            }
          });
        }

        // Handle refresh output button
        const refreshButton = document.getElementById("refresh-output-button");
        if (refreshButton) {
          refreshButton.addEventListener("click", function () {
            // Check if conversion engine is available and ready
            if (
              window.ConversionEngine &&
              window.ConversionEngine.isEngineReady()
            ) {
              // Provide user feedback
              const originalText = this.textContent;
              this.textContent = "üîÑ Refreshing...";
              this.disabled = true;

              // Announce to screen readers
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Refreshing output with current investigation settings"
                );
              }

              // Trigger conversion with current settings
              try {
                window.ConversionEngine.convertInput();

                // Reset button after a short delay
                setTimeout(() => {
                  this.textContent = originalText;
                  this.disabled = false;
                }, 1000);
              } catch (error) {
                console.error("Error refreshing output:", error);
                this.textContent = "‚ùå Refresh Failed";
                setTimeout(() => {
                  this.textContent = originalText;
                  this.disabled = false;
                }, 2000);
              }
            } else {
              // Conversion engine not ready
              console.warn("Conversion engine not ready for refresh");
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Cannot refresh: conversion engine not ready"
                );
              }
            }
          });
        }

        console.log("‚úÖ Investigation controls event handlers setup complete");
      });
    </script>
    <!-- Application Initialization Message -->
    <script>
      console.log("=== ENHANCED PANDOC-WASM MATHEMATICAL PLAYGROUND ===");
      console.log("- LayoutDebugger.enable() - Enable layout debugging");
      console.log(
        "- window.AppStateManager.getApplicationStatus() - Check app status"
      );
      console.log("");
      console.log("====================================================");
    </script>
    <!-- Scrollbars Toggle Functionality -->
    <script>
      (function () {
        "use strict";

        // ===========================================================================================
        // LOGGING CONFIGURATION (IIFE SCOPE)
        // ===========================================================================================

        const LOG_LEVELS = {
          ERROR: 0,
          WARN: 1,
          INFO: 2,
          DEBUG: 3,
        };

        const DEFAULT_LOG_LEVEL = LOG_LEVELS.DEBUG;
        const ENABLE_ALL_LOGGING = false;
        const DISABLE_ALL_LOGGING = false;

        function shouldLog(level) {
          if (DISABLE_ALL_LOGGING) return false;
          if (ENABLE_ALL_LOGGING) return true;
          return level <= DEFAULT_LOG_LEVEL;
        }

        function logError(message, ...args) {
          if (shouldLog(LOG_LEVELS.ERROR))
            console.error("[SCROLLBARS]", message, ...args);
        }

        function logWarn(message, ...args) {
          if (shouldLog(LOG_LEVELS.WARN))
            console.warn("[SCROLLBARS]", message, ...args);
        }

        function logInfo(message, ...args) {
          if (shouldLog(LOG_LEVELS.INFO))
            console.log("[SCROLLBARS]", message, ...args);
        }

        function logDebug(message, ...args) {
          if (shouldLog(LOG_LEVELS.DEBUG))
            console.log("[SCROLLBARS]", message, ...args);
        }

        // ===========================================================================================
        // SCROLLBARS TOGGLE IMPLEMENTATION
        // ===========================================================================================

        /**
         * Scrollbars Toggle Manager
         * Handles enabling/disabling panel scrollbars with accessibility support
         */
        class ScrollbarsToggleManager {
          constructor() {
            this.checkbox = null;
            this.workspace = null;
            this.isInitialised = false;
            this.storageKey = "pandoc-playground-scrollbars-enabled";
          }

          /**
           * Initialise the scrollbars toggle system
           */
          initialise() {
            logInfo("Initialising scrollbars toggle system...");

            try {
              // Get DOM elements
              this.checkbox = document.getElementById("scrollbars-toggle");
              this.workspace = document.querySelector(".workspace");

              if (!this.checkbox || !this.workspace) {
                throw new Error(
                  "Required scrollbars toggle DOM elements not found"
                );
              }

              // Add screen reader help text
              this.addAccessibilitySupport();

              // Setup event listeners
              this.setupEventListeners();

              // Restore saved state
              this.restoreSavedState();

              this.isInitialised = true;
              logInfo("‚úÖ Scrollbars toggle system initialised successfully");

              return true;
            } catch (error) {
              logError("Failed to initialise scrollbars toggle system:", error);
              return false;
            }
          }

          /**
           * Add accessibility support elements
           */
          addAccessibilitySupport() {
            // Add help text for screen readers
            const helpId = "scrollbars-help";
            if (!document.getElementById(helpId)) {
              const helpText = document.createElement("div");
              helpText.id = helpId;
              helpText.className = "sr-only";
              helpText.textContent =
                "Toggle scrollbars for LaTeX input and HTML output panels. When enabled, panels scroll independently.";
              document.body.appendChild(helpText);
            }

            logDebug("Accessibility support added for scrollbars toggle");
          }

          /**
           * Setup event listeners
           */
          setupEventListeners() {
            if (!this.checkbox) return;

            this.checkbox.addEventListener("change", (event) => {
              const isEnabled = event.target.checked;
              this.toggleScrollbars(isEnabled);
              this.saveState(isEnabled);
              this.announceStateChange(isEnabled);
            });

            logDebug("Event listeners setup for scrollbars toggle");
          }

          /**
           * Toggle scrollbars on/off
           */
          toggleScrollbars(enabled) {
            if (!this.workspace) return;

            if (enabled) {
              this.workspace.classList.remove("scrollbars-disabled");
              // Restore constrained viewport scrolling
              document.body.style.overflow = "";
              logInfo(
                "Panel scrollbars enabled - individual panel scrolling active"
              );
            } else {
              this.workspace.classList.add("scrollbars-disabled");
              // Enable full document scrolling
              document.body.style.overflow = "auto";
              logInfo(
                "Panel scrollbars disabled - full document scrolling active"
              );
            }

            // Update checkbox state if called programmatically
            if (this.checkbox && this.checkbox.checked !== enabled) {
              this.checkbox.checked = enabled;
            }
          }

          /**
           * Save scrollbars state to localStorage
           */
          saveState(enabled) {
            try {
              localStorage.setItem(this.storageKey, enabled.toString());
              logDebug("Scrollbars state saved:", enabled);
            } catch (error) {
              logWarn("Could not save scrollbars state:", error);
            }
          }

          /**
           * Restore saved scrollbars state
           */
          restoreSavedState() {
            try {
              const savedState = localStorage.getItem(this.storageKey);

              if (savedState !== null) {
                const isEnabled = savedState === "true";
                this.checkbox.checked = isEnabled;
                this.toggleScrollbars(isEnabled);
                logInfo("Restored scrollbars state:", isEnabled);
              } else {
                // Default to enabled (checkbox starts checked)
                this.toggleScrollbars(true);
                logInfo("Using default scrollbars state: enabled");
              }
            } catch (error) {
              logWarn("Could not restore scrollbars state:", error);
              // Fallback to enabled state
              this.toggleScrollbars(true);
            }
          }

          /**
           * Announce state change to screen readers
           */
          announceStateChange(enabled) {
            try {
              const message = enabled
                ? "Panel scrollbars enabled. LaTeX input and HTML output panels will scroll independently when content overflows."
                : "Panel scrollbars disabled. Panels will not show scrollbars when content overflows.";

              const announcement = document.createElement("div");
              announcement.setAttribute("aria-live", "polite");
              announcement.setAttribute("aria-atomic", "true");
              announcement.setAttribute("role", "status");
              announcement.className = "sr-only";
              announcement.textContent = message;

              document.body.appendChild(announcement);

              // Remove after announcement
              setTimeout(() => {
                if (document.body.contains(announcement)) {
                  document.body.removeChild(announcement);
                }
              }, 2000);

              logDebug("Screen reader announcement made:", message);
            } catch (error) {
              logError("Error announcing scrollbars state change:", error);
            }
          }

          /**
           * Get current scrollbars state
           */
          isScrollbarsEnabled() {
            return this.checkbox ? this.checkbox.checked : true;
          }

          /**
           * Public API to enable/disable scrollbars
           */
          enable() {
            if (this.checkbox) {
              this.checkbox.checked = true;
              this.toggleScrollbars(true);
              this.saveState(true);
              this.announceStateChange(true);
            }
          }

          disable() {
            if (this.checkbox) {
              this.checkbox.checked = false;
              this.toggleScrollbars(false);
              this.saveState(false);
              this.announceStateChange(false);
            }
          }
        }

        // ===========================================================================================
        // INITIALISATION AND GLOBAL ACCESS
        // ===========================================================================================

        // Create global instance
        const scrollbarsToggle = new ScrollbarsToggleManager();

        // Make available globally for console testing
        window.ScrollbarsToggle = {
          enable: () => scrollbarsToggle.enable(),
          disable: () => scrollbarsToggle.disable(),
          toggle: () => {
            if (scrollbarsToggle.isScrollbarsEnabled()) {
              scrollbarsToggle.disable();
            } else {
              scrollbarsToggle.enable();
            }
          },
          isEnabled: () => scrollbarsToggle.isScrollbarsEnabled(),
          getInstance: () => scrollbarsToggle,
        };

        // Initialise when DOM is ready
        function initScrollbarsToggle() {
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
              setTimeout(() => scrollbarsToggle.initialise(), 100);
            });
          } else {
            setTimeout(() => scrollbarsToggle.initialise(), 100);
          }
        }

        // Auto-initialise
        initScrollbarsToggle();

        logInfo("Scrollbars toggle system loaded");
      })();
    </script>
  </body>
</html>
