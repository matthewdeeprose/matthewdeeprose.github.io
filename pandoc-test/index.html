<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pandoc-WASM Mathematical Playground - BETA</title>
    <meta
      name="description"
      content="An accessibility focussed browser-based LaTeX to HTML converter with HTML and SCORM export features powered by Pandoc WebAssembly with MathJax rendering"
    />
	    <meta property="og:title" content="Pandoc-WASM Mathematical Playground - BETA - Matthew Deeprose" />
    <meta property="og:description" content="An accessibility focussed browser-based LaTeX to HTML converter with HTML and SCORM export features powered by Pandoc WebAssembly with MathJax rendering" />
    <meta
      property="og:image"
      content="https://matthewdeeprose.github.io/image.png"
    />
    <meta property="og:image:width" content="2500" />
    <meta property="og:image:height" content="1306" />
    <meta property="og:image:alt" content="" />
    <meta property="og:locale" content="en_GB" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://matthewdeeprose.github.io/pandoc-test/index.html"
    />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="theme-color"
      content="#231F20"
      media="(prefers-color-scheme: dark)"
    />
    <meta
      name="theme-color"
      content="#FFFFF4"
      media="(prefers-color-scheme: light)"
    />
    <link rel="icon" href="https://matthewdeeprose.github.io/favicon.ico" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed for matthewdeeprose.github.io"
      href="https://matthewdeeprose.github.io/feed.rss"
    />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Pandoc-WASM Mathematical Playground - BETA - Matthew Deeprose" />
    <meta name="twitter:description" content="An accessibility focussed browser-based LaTeX to HTML converter with HTML and SCORM export features powered by Pandoc WebAssembly with MathJax rendering" />
    <meta name="twitter:creator" content="@VLEguru" />
    <meta name="twitter:site" content="@VLEguru" />
    <meta
      name="twitter:image"
      content="https://matthewdeeprose.github.io/image.png"
    />
    <meta name="twitter:image:alt" content="" />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- MathJax Configuration -->
    <script>
      console.log("=== MATHJAX CONFIG LOADING ===");
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
          processEscapes: true,
          processEnvironments: true,
        },
        options: {
          ignoreHtmlClass: "tex2jax_ignore",
          processHtmlClass: "tex2jax_process",
        },
        startup: {
          ready() {
            console.log("=== MATHJAX STARTUP READY ===");
            console.log("MathJax startup ready called");
            MathJax.startup.defaultReady();
            console.log("MathJax default ready complete");
            setTimeout(() => {
              if (window.LayoutDebugger && window.LayoutDebugger.isEnabled()) {
                window.LayoutDebugger.logLayoutState(
                  "MathJax startup complete"
                );
              }
            }, 10);
          },
        },
      };
      console.log("MathJax config set");
    </script>
    <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?version=3.98.0&features=es6"></script>
    <!-- JSZip for SCORM package generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
      onload="console.log('=== MATHJAX SCRIPT LOADED ===')"
    ></script>

    <link
      rel="stylesheet"
      id="mainCSS"
      href="css/playground-styles.css"
      media="all"
    />

    <link rel="stylesheet" id="prismCSS" href="css/prism.css" media="all" />

    <link
      rel="stylesheet"
      id="modalCSS"
      href="css/modal-styles.css"
      media="all"
    />

    <link
      rel="stylesheet"
      id="notifCSS"
      href="css/universal-notifications-playground.css"
      media="all"
    />
  </head>
  <body>
    <header role="banner">
      <div class="header-content">
        <h1 id="app-title">
          Convert LaTeX to standalone HTML and SCORM files
          <abbr title="Beta Version">(BETA)</abbr>
        </h1>
        <p class="subtitle" role="doc-subtitle">
          <svg
            class="privacy-badge"
            height="21"
            viewBox="0 0 21 21"
            width="21"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <g fill="none" fill-rule="evenodd" transform="translate(4 1)">
              <path
                d="m2.5 8.5-.00586729-1.99475098c-.00728549-4.00349935 1.32800361-6.00524902 4.00586729-6.00524902s4.0112203 2.00174967 4.0000699 6.00524902v1.99475098m-8.0000699 0h8.0225317c1.0543618 0 1.9181652.81587779 1.9945143 1.8507377l.0054778.1548972-.0169048 6c-.0031058 1.1023652-.8976224 1.9943651-1.999992 1.9943651h-8.005627c-1.1045695 0-2-.8954305-2-2v-6c0-1.1045695.8954305-2 2-2z"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path>
              <circle cx="6.5" cy="13.5" fill="currentColor" r="1.5"></circle>
            </g>
          </svg>
          Privacy-friendly: No data leaves your browser, everything happens on
          your computer.
        </p>
      </div>
      <button
        id="theme-toggle"
        class="theme-toggle"
        aria-label="Switch to dark mode"
      >
        <svg
          class="theme-toggle-icon action-icon moon-icon"
          height="24"
          width="24"
          viewBox="0 0 21 21"
          aria-hidden="true"
        >
          <path
            d="m7.5.5c1.3280962 0 2.5698071.36985953 3.6277499 1.01219586-3.14075981.19184303-5.6277499 2.79938976-5.6277499 5.98780414 0 3.1884144 2.48699009 5.7959611 5.6269199 5.9885898-1.0571128.6415507-2.2988237 1.0114102-3.6269199 1.0114102-3.86599325 0-7-3.1340068-7-7 0-3.86599325 3.13400675-7 7-7z"
            fill="none"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            transform="translate(4 3)"
          />
        </svg>
        <span class="theme-toggle-text">Dark</span>
      </button>
    </header>

    <main>
      <div class="status-bar">
        <div class="status-indicator">
          <div class="status-icon-container">
            <div class="status-icon loading" id="statusDot" aria-hidden="true">
              <div class="spinner"></div>
            </div>
          </div>
          <div class="status-content">
            <span class="status-text" id="statusText"
              >Initializing application...</span
            >
            <div class="status-progress" id="statusProgress">
              <div class="status-progress-bar" id="statusProgressBar"></div>
            </div>
          </div>
        </div>
        <div class="control-group">
          <div class="export-controls">
            <button
              id="exportButton"
              class="export-btn"
              aria-label="Download mathematical document as accessible HTML file"
              disabled
            >
              <div class="export-btn-icon">
                <svg
                  class="icon"
                  aria-hidden="true"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7,10 12,15 17,10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
              </div>
              <div class="export-btn-content">
                <span class="export-btn-title">Export HTML</span>
                <span class="export-btn-subtitle" id="export-subtitle"
                  >Standalone document</span
                >
              </div>
            </button>
            <span class="sr-only" id="exportHelp">
              Download the converted content as a standalone HTML file with
              accessibility features, working MathJax equations, and offline
              capability.
            </span>
            <!-- SCORM Export Button - Matching Current Export Button Structure -->
            <button
              id="exportSCORMButton"
              class="scorm-export-btn"
              aria-describedby="scorm-description"
              disabled
            >
              <div class="scorm-export-btn-icon">
                <svg
                  class="icon"
                  aria-hidden="true"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7,10 12,15 17,10" />
                  <line x1="12" x2="12" y1="15" y2="3" />
                  <rect x="9" y="1" width="6" height="2" rx="1" />
                </svg>
              </div>

              <div class="scorm-export-btn-content">
                <span class="scorm-export-btn-title">Export SCORM</span>
                <span class="scorm-export-btn-subtitle">LMS package</span>
              </div>
            </button>

            <!-- Screen reader description -->
            <div id="scorm-description" class="sr-only">
              Export as SCORM 2004 3rd Edition package for Learning Management
              Systems. Includes all accessibility features and mathematical
              interactivity compatible with most LMS platforms.
            </div>
          </div>
        </div>
        <fieldset class="examples-fieldset">
          <legend class="examples-legend">Mathematical Examples Library</legend>
          <div class="examples-container">
            <label for="example-select" class="sr-only"
              >Select an example to load</label
            >
            <select
              id="example-select"
              class="example-select"
              aria-describedby="example-help"
            >
              <option value="">Choose an example...</option>
              <!-- Your existing options -->
              <option value="mathematical-foundations">
                Mathematical Foundations
              </option>
              <option value="advanced-calculus">Advanced Calculus</option>
              <option value="linear-algebra">Linear Algebra</option>
              <option value="statistics">Statistics &amp; Probability</option>
              <option value="complex-analysis">Complex Analysis</option>
              <option value="differential-equations">
                Differential Equations
              </option>
              <option value="topology">Topology</option>
              <option value="algebraic-structures">Abstract Algebra</option>
            </select>
            <button
              id="random-example-btn"
              class="random-example-btn"
              aria-label="Load random example"
            >
              <span aria-hidden="true">🎲</span> Random
            </button>
            <div id="example-help" class="sr-only">
              Select an example from the dropdown or click random to load a
              demonstration
            </div>
          </div>
        </fieldset>
      </div>

      <div class="workspace">
        <section class="panel input-panel">
          <header class="panel-header">
            <label for="input">LaTeX Input</label>
          </header>
          <div class="panel-content">
            <textarea
              id="input"
              placeholder="Loading..."
              readonly
              aria-describedby="inputHelp"
            ></textarea>
            <div id="inputHelp" class="sr-only">
              Enter your LaTeX mathematical expressions here. The output will be
              automatically converted to HTML and rendered with MathJax.
            </div>
          </div>
        </section>

        <section class="panel output-panel">
          <header class="panel-header">HTML Output with MathJax</header>
          <div class="panel-content">
            <div
              id="output"
              class="output-content tex2jax_process"
              aria-live="polite"
              role="region"
              aria-label="Converted HTML output"
            >
              <p>Output will appear here once the module loads...</p>
            </div>
          </div>
        </section>
      </div>

      <footer class="controls">
        <div class="control-group">
          <label for="arguments">Pandoc Arguments:</label>
          <input
            type="text"
            id="arguments"
            value="-s --from latex --to html5 --mathjax --html-q-tags --wrap=preserve"
            aria-describedby="argsHelp"
          />
          <div id="argsHelp" class="sr-only">
            Command line arguments passed to Pandoc. Default converts from LaTeX
            to HTML with MathJax support.
          </div>
        </div>

        <!-- 🧪 PANDOC ENHANCEMENT INVESTIGATION CONTROLS -->
        <details
          class="control-group investigation-controls-details"
          id="investigation-details"
          style="
            margin-top: 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            overflow: hidden;
          "
        >
          <summary
            class="investigation-summary"
            aria-expanded="false"
            aria-controls="investigation-content"
            style="
              font-weight: 600;
              color: var(--heading-color);
              padding: 1rem;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              background: var(--surface-color);
              border: none;
              outline: none;
              transition: all 0.3s ease;
              position: relative;
              user-select: none;
              width: 100%;
              box-sizing: border-box;
              margin: 0;
            "
          >
            <svg
              class="action-icon coffee-icon"
              height="24"
              width="24"
              viewBox="0 0 21 21"
              aria-hidden="true"
            >
              <g
                fill="none"
                fill-rule="evenodd"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                transform="translate(4 2)"
              >
                <path
                  d="m2.5 6.5h6c1.1045695 0 2 .8954305 2 2v2.5c0 2.4852814-2.01471863 4.5-4.5 4.5h-1c-2.48528137 0-4.5-2.0147186-4.5-4.5v-2.5c0-1.1045695.8954305-2 2-2zm8 2h1c1.1045695 0 2 .8954305 2 2s-.8954305 2-2 2h-1"
                />
                <path d="m4.5 4.5v-4" />
                <path d="m6.5 4.5v-2" />
              </g>
            </svg>
            Pandoc Enhancement Investigation
            <svg
              class="investigation-chevron"
              height="20"
              width="20"
              viewBox="0 0 24 24"
              aria-hidden="true"
              style="
                margin-left: auto;
                transition: transform 0.3s ease;
                transform: rotate(0deg);
              "
            >
              <path
                d="M6 9l6 6 6-6"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </summary>
          <div
            id="investigation-content"
            class="investigation-content"
            style="padding: 0 1rem 1rem 1rem; margin-left: 0.5rem"
          >
            <!-- Checkbox removed - preset dropdown now serves as the single control -->
            <div class="form-group" style="margin-bottom: 0.5rem">
              <label
                for="pandoc-enhancement-preset"
                style="
                  display: block;
                  margin-bottom: 0.25rem;
                  font-size: 0.9rem;
                "
                >Enhancement Preset:</label
              >
              <select
                id="pandoc-enhancement-preset"
                aria-describedby="preset-help"
              >
                <option value="">None (Standard Arguments)</option>
                <option value="semantic">Semantic HTML Focus</option>
                <option value="accessibility">Accessibility Enhanced</option>
                <option value="structure">Document Structure</option>
                <option value="theorem">Theorem Environment Focus</option>
                <option value="custom">Custom Arguments</option>
              </select>
              <div id="preset-help" class="sr-only">
                Choose enhancement level for Pandoc argument processing. Select
                'None' to use standard arguments only.
              </div>
            </div>

            <!-- Custom Arguments Input (initially hidden) -->
            <div
              class="form-group"
              id="custom-args-container"
              style="margin-bottom: 0.75rem; display: none"
            >
              <label
                for="custom-pandoc-args"
                style="
                  display: block;
                  margin-bottom: 0.25rem;
                  font-size: 0.9rem;
                  font-weight: 500;
                "
                >Custom Pandoc Arguments:</label
              >
              <textarea
                id="custom-pandoc-args"
                style="
                  width: 100%;
                  padding: 0.4rem;
                  border: 1px solid var(--sidebar-border);
                  border-radius: 4px;
                  background: var(--body-bg);
                  font-family: monospace;
                  font-size: 0.85rem;
                  min-height: 60px;
                  resize: vertical;
                "
                placeholder="Enter custom Pandoc arguments, e.g:&#10;--section-divs --wrap=preserve&#10;--html-q-tags"
                aria-describedby="custom-args-help"
              ></textarea>
              <div
                id="custom-args-help"
                style="
                  font-size: 0.8rem;
                  color: var(--text-secondary);
                  margin-top: 0.25rem;
                "
              >
                Enter additional Pandoc arguments separated by spaces. These
                will be added to the base arguments.
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 0.75rem">
              <input
                type="checkbox"
                id="pandoc-comparison-mode"
                aria-describedby="comparison-help"
              />
              <label for="pandoc-comparison-mode" style="font-weight: 500"
                >Show Comparison View</label
              >
              <div id="comparison-help" class="sr-only">
                Display side-by-side comparison of standard versus enhanced
                conversion output
              </div>
            </div>

            <div class="form-group" style="margin-bottom: 0.75rem">
              <input
                type="checkbox"
                id="hide-latex-input"
                aria-describedby="hide-input-help"
              />
              <label for="hide-latex-input" style="font-weight: 500"
                >Hide LaTeX Input Panel</label
              >
              <div id="hide-input-help" class="sr-only">
                Hide the LaTeX input panel to provide more space for comparison
                view
              </div>
            </div>
            <div
              class="form-group"
              style="margin: 0; display: flex; align-items: center; gap: 0.5rem"
            >
              <input
                type="checkbox"
                id="export-enhanced-pandoc"
                aria-describedby="export-enhanced-help"
                style="margin: 0"
              />
              <label
                for="export-enhanced-pandoc"
                style="display: flex; align-items: center; gap: 0.5rem"
              >
                <svg
                  class="action-icon coffee-icon"
                  height="24"
                  width="24"
                  viewBox="0 0 21 21"
                  aria-hidden="true"
                >
                  <g
                    fill="none"
                    fill-rule="evenodd"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    transform="translate(4 2)"
                  >
                    <path
                      d="m2.5 6.5h6c1.1045695 0 2 .8954305 2 2v2.5c0 2.4852814-2.01471863 4.5-4.5 4.5h-1c-2.48528137 0-4.5-2.0147186-4.5-4.5v-2.5c0-1.1045695.8954305-2 2-2zm8 2h1c1.1045695 0 2 .8954305 2 2s-.8954305 2-2 2h-1"
                    />
                    <path d="m4.5 4.5v-4" />
                    <path d="m6.5 4.5v-2" />
                  </g>
                </svg>
                Use Enhanced Pandoc for Export
              </label>
            </div>
            <div
              id="export-enhanced-help"
              style="
                font-size: 0.8rem;
                color: var(--text-secondary);
                margin-top: 0.5rem;
                margin-left: 1.5rem;
              "
            >
              Apply investigation findings to export: Use enhanced Pandoc
              arguments to potentially eliminate post-processing and generate
              better semantic HTML natively.
            </div>
            <div
              id="export-enhanced-status"
              style="
                font-size: 0.8rem;
                margin-top: 0.5rem;
                margin-left: 1.5rem;
                font-style: italic;
                color: var(--text-secondary);
              "
            >
              <span id="export-method-indicator"
                >Standard export method will be used.</span
              >
            </div>

            <div id="investigation-info" aria-live="polite">
              <strong>Investigation Goal:</strong> Test different Pandoc
              argument combinations to improve HTML output quality and semantic
              structure. Select a preset above to enable enhanced processing.
              <div
                id="preset-explanation"
                style="
                  margin-top: 0.5rem;
                  padding-top: 0.5rem;
                  border-top: 1px solid var(--border-color);
                "
              >
                <em
                  >Select an enhancement preset above to see technical details
                  about the Pandoc arguments and their expected HTML output
                  improvements.</em
                >
              </div>
              <div style="margin-top: 0.75rem">
                <button
                  id="refresh-output-button"
                  type="button"
                  aria-describedby="refresh-help"
                >
                  <svg
                    class="heading-icon reset-heading-icon"
                    height="20"
                    width="20"
                    viewBox="0 0 21 21"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <g
                      fill="none"
                      fill-rule="evenodd"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      transform="matrix(0 1 1 0 2.5 2.5)"
                    >
                      <path
                        d="m3.98652376 1.07807068c-2.38377179 1.38514556-3.98652376 3.96636605-3.98652376 6.92192932 0 4.418278 3.581722 8 8 8s8-3.581722 8-8-3.581722-8-8-8"
                      ></path>
                      <path
                        d="m4 1v4h-4"
                        transform="matrix(1 0 0 -1 0 6)"
                      ></path>
                    </g>
                  </svg>
                  Refresh Output to Use These Enhancement Settings
                </button>
                <div
                  id="refresh-help"
                  style="
                    font-size: 0.8rem;
                    color: var(--text-secondary);
                    margin-top: 0.25rem;
                    text-align: center;
                  "
                >
                  Re-processes the current input content with the investigation
                  settings above
                </div>
              </div>
            </div>
          </div>
        </details>
      </footer>
    </main>
    <script>
      /**
       * Enhanced Investigation Details/Summary Accessibility Manager
       * Provides proper ARIA attributes and screen reader support
       */
      (function () {
        "use strict";

        /**
         * Initialize investigation details accessibility
         */
        function initializeInvestigationDetails() {
          const details = document.getElementById("investigation-details");
          const summary = details?.querySelector(".investigation-summary");
          const content = document.getElementById("investigation-content");

          if (!details || !summary || !content) {
            console.warn("Investigation details elements not found");
            return;
          }

          // Set initial ARIA states
          updateAriaStates();

          // Listen for toggle events
          details.addEventListener("toggle", handleToggle);

          // Enhanced keyboard support
          summary.addEventListener("keydown", handleKeydown);

          // Mouse interaction
          summary.addEventListener("click", handleClick);

          console.log("✅ Investigation details accessibility initialized");

          /**
           * Update ARIA attributes based on current state
           */
          function updateAriaStates() {
            const isOpen = details.hasAttribute("open");

            // Update aria-expanded on summary
            summary.setAttribute("aria-expanded", isOpen.toString());

            // Update content visibility for screen readers
            if (isOpen) {
              content.removeAttribute("aria-hidden");
              content.setAttribute("aria-live", "polite");
            } else {
              content.setAttribute("aria-hidden", "true");
              content.removeAttribute("aria-live");
            }
          }

          /**
           * Handle details toggle event
           */
          function handleToggle() {
            updateAriaStates();
            announceStateChange();

            // Optional: Save state to localStorage for persistence
            try {
              localStorage.setItem(
                "investigation-details-open",
                details.hasAttribute("open")
              );
            } catch (e) {
              // Silently fail if localStorage is not available
            }
          }

          /**
           * Handle keyboard interaction
           */
          function handleKeydown(event) {
            // Only handle Enter and Space - let details handle the rest
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();

              // Toggle the details
              if (details.hasAttribute("open")) {
                details.removeAttribute("open");
              } else {
                details.setAttribute("open", "");
              }

              // Manually trigger toggle event for our handler
              details.dispatchEvent(new Event("toggle"));
            }
          }

          /**
           * Handle mouse click
           */
          function handleClick() {
            // Let the browser handle the toggle, our toggle event will fire
            // This ensures consistent behavior between mouse and keyboard
          }

          /**
           * Announce state change to screen readers
           */
          function announceStateChange() {
            const isOpen = details.hasAttribute("open");
            const message = isOpen
              ? "Investigation controls expanded. Form controls are now available."
              : "Investigation controls collapsed.";

            announceToScreenReader(message);
          }

          /**
           * Announce message to screen readers
           */
          function announceToScreenReader(message) {
            const announcement = document.createElement("div");
            announcement.setAttribute("aria-live", "polite");
            announcement.setAttribute("aria-atomic", "true");
            announcement.setAttribute("role", "status");
            announcement.textContent = message;

            // Screen reader only styles
            announcement.style.cssText = `
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      `;

            document.body.appendChild(announcement);

            // Remove after screen readers have processed it
            setTimeout(() => {
              if (document.body.contains(announcement)) {
                document.body.removeChild(announcement);
              }
            }, 1000);
          }

          /**
           * Restore saved state on page load
           */
          function restoreSavedState() {
            try {
              const savedState = localStorage.getItem(
                "investigation-details-open"
              );
              if (savedState === "true") {
                details.setAttribute("open", "");
                updateAriaStates();
              }
            } catch (e) {
              // Silently fail if localStorage is not available
            }
          }

          // Restore state after a short delay to ensure DOM is ready
          setTimeout(restoreSavedState, 100);
        }

        /**
         * Initialize when DOM is ready
         */
        if (document.readyState === "loading") {
          document.addEventListener(
            "DOMContentLoaded",
            initializeInvestigationDetails
          );
        } else {
          initializeInvestigationDetails();
        }

        // Export for external access if needed
        window.InvestigationDetailsManager = {
          initialize: initializeInvestigationDetails,
        };
      })();
    </script>
    <!-- Enhanced Theme Toggle Script with System Preference Detection -->
    <script>
      // Enhanced Theme Management with System Preference Support
      (function () {
        "use strict";

        // Logging configuration
        const LOG_LEVELS = {
          ERROR: 0,
          WARN: 1,
          INFO: 2,
          DEBUG: 3,
        };

        const DEFAULT_LOG_LEVEL = LOG_LEVELS.WARN;
        const ENABLE_ALL_LOGGING = false;
        const DISABLE_ALL_LOGGING = false;

        function shouldLog(level) {
          if (DISABLE_ALL_LOGGING) return false;
          if (ENABLE_ALL_LOGGING) return true;
          return level <= DEFAULT_LOG_LEVEL;
        }

        function logError(message, ...args) {
          if (shouldLog(LOG_LEVELS.ERROR)) console.error(message, ...args);
        }

        function logWarn(message, ...args) {
          if (shouldLog(LOG_LEVELS.WARN)) console.warn(message, ...args);
        }

        function logInfo(message, ...args) {
          if (shouldLog(LOG_LEVELS.INFO)) console.log(message, ...args);
        }

        function logDebug(message, ...args) {
          if (shouldLog(LOG_LEVELS.DEBUG)) console.log(message, ...args);
        }

        // Theme configuration
        const THEME_CONFIG = {
          defaultTheme: "light",
          storageKey: "pandoc-playground-theme",
          enableTransitions: true,
          respectSystemPreference: true,
        };

        // Get DOM elements
        const themeToggle = document.getElementById("theme-toggle");
        const themeIcon = themeToggle?.querySelector(".theme-toggle-icon");
        const themeText = themeToggle?.querySelector(".theme-toggle-text");

        /**
         * Get user's preferred theme based on storage and system preferences
         * @returns {string} 'light' or 'dark'
         */
        function getPreferredTheme() {
          // Check stored preference first
          const stored = localStorage.getItem(THEME_CONFIG.storageKey);
          if (stored) {
            logDebug("Using stored theme preference:", stored);
            return stored;
          }

          // Check system preference if enabled
          if (THEME_CONFIG.respectSystemPreference) {
            if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
              logInfo("Using system preference: dark");
              return "dark";
            }
            if (window.matchMedia("(prefers-color-scheme: light)").matches) {
              logInfo("Using system preference: light");
              return "light";
            }
          }

          // Default fallback
          logDebug("Using default theme:", THEME_CONFIG.defaultTheme);
          return THEME_CONFIG.defaultTheme;
        }

        /**
         * Set theme and update UI elements
         * @param {string} theme - 'light' or 'dark'
         */
        function setTheme(theme) {
          if (theme !== "light" && theme !== "dark") {
            logWarn("Invalid theme:", theme, "defaulting to light");
            theme = "light";
          }

          // Apply theme to document
          document.documentElement.setAttribute("data-theme", theme);

          // Store preference
          localStorage.setItem(THEME_CONFIG.storageKey, theme);

          // SVG icon definitions
          const lightModeIcon = `<svg height="24" width="24" viewBox="210 0 21 21" class="action-icon theme-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="m220.5 2.5v2"/><path d="m227 5-1.5 1.5"/><circle cx="220.5" cy="11.5" r="4"/><path d="m214 5 1.5 1.5"/><path d="m220.5 20.5v-2"/><path d="m227 18-1.5-1.5"/><path d="m214 18 1.5-1.5"/><path d="m211.5 11.5h2"/><path d="m227.5 11.5h2"/></g></svg>`;

          const darkModeIcon = `<svg height="24" width="24" viewBox="0 0 21 21" class="action-icon theme-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="m7.5.5c1.3280962 0 2.5698071.36985953 3.6277499 1.01219586-3.14075981.19184303-5.6277499 2.79938976-5.6277499 5.98780414 0 3.1884144 2.48699009 5.7959611 5.6269199 5.9885898-1.0571128.6415507-2.2988237 1.0114102-3.6269199 1.0114102-3.86599325 0-7-3.1340068-7-7 0-3.86599325 3.13400675-7 7-7z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" transform="translate(4 3)"/></svg>`;

          // Update theme toggle UI
          if (theme === "dark") {
            if (themeIcon) themeIcon.innerHTML = lightModeIcon;
            if (themeText) themeText.textContent = "Light";
            if (themeToggle)
              themeToggle.setAttribute("aria-label", "Switch to light mode");
          } else {
            if (themeIcon) themeIcon.innerHTML = darkModeIcon;
            if (themeText) themeText.textContent = "Dark";
            if (themeToggle)
              themeToggle.setAttribute("aria-label", "Switch to dark mode");
          }

          // Update aria-pressed state for better accessibility
          if (themeToggle) {
            themeToggle.setAttribute("aria-pressed", theme === "dark");
          }

          // Announce theme change to screen readers
          announceThemeChange(theme);

          logInfo("✅ Theme set to:", theme);
        }

        /**
         * Toggle between light and dark themes
         * @returns {string} The new theme that was set
         */
        function toggleTheme() {
          const current =
            document.documentElement.getAttribute("data-theme") || "light";
          const newTheme = current === "light" ? "dark" : "light";
          setTheme(newTheme);
          return newTheme;
        }

        /**
         * Announce theme change to screen readers
         * @param {string} theme - The new theme
         */
        function announceThemeChange(theme) {
          const announcement = document.createElement("div");
          announcement.setAttribute("aria-live", "polite");
          announcement.setAttribute("role", "status");
          announcement.textContent = `Theme changed to ${theme} mode`;

          // Screen reader only styles
          announcement.style.cssText = `
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      `;

          document.body.appendChild(announcement);
          setTimeout(() => {
            if (document.body.contains(announcement)) {
              document.body.removeChild(announcement);
            }
          }, 1000);
        }

        /**
         * Setup smooth transitions for theme changes
         */
        function setupThemeTransitions() {
          // Check for reduced motion preference
          if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
            logInfo(
              "⚠️ Respecting reduced motion preference - transitions disabled"
            );
            return;
          }

          const style = document.createElement("style");
          style.id = "theme-transitions";
          style.textContent = `
        :root {
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        body {
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        .theme-toggle {
          transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
      `;
          document.head.appendChild(style);
          logDebug("✅ Theme transitions enabled");
        }

        /**
         * Initialise theme management system
         */
        function initialiseThemeSystem() {
          logInfo("🎨 Initialising theme management system...");

          if (THEME_CONFIG.enableTransitions) {
            setupThemeTransitions();
          }

          // Set initial theme
          const initialTheme = getPreferredTheme();
          setTheme(initialTheme);

          // Setup theme toggle button
          if (themeToggle) {
            // Click handler
            themeToggle.addEventListener("click", function (event) {
              event.preventDefault();
              toggleTheme();
            });

            // Keyboard support (Enter and Space)
            themeToggle.addEventListener("keydown", function (event) {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                toggleTheme();
              }
            });

            logDebug(
              "✅ Theme toggle button initialised with full keyboard support"
            );
          }

          // Listen for system theme changes
          if (THEME_CONFIG.respectSystemPreference && window.matchMedia) {
            const mediaQuery = window.matchMedia(
              "(prefers-color-scheme: dark)"
            );

            // Use modern addEventListener or fallback to addListener
            const addListener =
              mediaQuery.addEventListener || mediaQuery.addListener;
            if (addListener) {
              const handler = function (e) {
                // Only auto-switch if user hasn't manually set a preference
                if (!localStorage.getItem(THEME_CONFIG.storageKey)) {
                  setTheme(e.matches ? "dark" : "light");
                  logInfo(
                    "🔄 Auto-switched theme based on system preference:",
                    e.matches ? "dark" : "light"
                  );
                }
              };

              if (mediaQuery.addEventListener) {
                mediaQuery.addEventListener("change", handler);
              } else {
                mediaQuery.addListener(handler);
              }

              logInfo("✅ System theme preference monitoring enabled");
            }
          }

          logInfo("✅ Theme management system fully initialised");

          // Log current configuration for debugging
          logDebug("🎨 Theme Configuration:", {
            defaultTheme: THEME_CONFIG.defaultTheme,
            enableTransitions: THEME_CONFIG.enableTransitions,
            respectSystemPreference: THEME_CONFIG.respectSystemPreference,
            currentTheme: document.documentElement.getAttribute("data-theme"),
            systemPrefersDark: window.matchMedia("(prefers-color-scheme: dark)")
              .matches,
          });
        }

        // Export functions for global access
        window.setTheme = setTheme;
        window.getPreferredTheme = getPreferredTheme;
        window.toggleTheme = toggleTheme;

        // Initialise when DOM is ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initialiseThemeSystem);
        } else {
          initialiseThemeSystem();
        }

        logInfo("✅ Enhanced theme management module loaded");
      })();
    </script>

    <!-- Application State Setup -->
    <script>
      // Setup global app elements for module access
      document.addEventListener("DOMContentLoaded", function () {
        // Make key elements globally available for modules
        window.appElements = {
          inputTextarea: document.getElementById("input"),
          outputDiv: document.getElementById("output"),
          argumentsInput: document.getElementById("arguments"),
          exportButton: document.getElementById("exportButton"),
          statusDot: document.getElementById("statusDot"),
          statusText: document.getElementById("statusText"),
          statusProgress: document.getElementById("statusProgress"),
          statusProgressBar: document.getElementById("statusProgressBar"),
          exampleSelect: document.getElementById("example-select"),
          randomExampleBtn: document.getElementById("random-example-btn"),
        };

        console.log("✅ Global app elements setup complete");
      });
    </script>

    <!-- Modular JavaScript Architecture -->
    <script src="js/plugins/prism.js"></script>
    <!-- Core Application Modules (Load Order is Critical) -->
    <script src="js/export/app-config.js"></script>
    <!-- UI Systems (Load Early) -->
    <script src="./js/ui/universal-modal.js"></script>
    <script src="./js/ui/universal-notifications.js"></script>
    <!-- Foundation utilities -->
    <script src="js/export/mathjax-manager.js"></script>
    <!-- MathJax controls -->
    <script src="js/export/latex-processor.js"></script>
    <!-- LaTeX processing -->
    <script src="js/export/content-generator.js"></script>
    <!-- CSS & structure -->
    <script src="js/export/template-system.js"></script>
    <!-- HTML generation -->
    <script src="js/export/download-monitor.js"></script>
    <script src="js/export/export-manager.js"></script>
    <script src="./js/export/scorm-export-manager.js"></script>
    <script src="js/export/source-viewer.js"></script>
    <!-- Export orchestration -->

    <!-- Application Feature Modules -->
    <script src="js/pandoc/example-system.js"></script>
    <!-- Example management -->
    <script src="js/pandoc/status-manager.js"></script>
    <!-- Status indicators -->
    <script src="js/pandoc/conversion-engine.js"></script>
    <!-- LaTeX conversion -->
    <script src="js/pandoc/event-manager.js"></script>
    <!-- Event handling -->

    <!-- Main Application Coordinator -->
    <script src="js/pandoc/app-state-manager.js"></script>
    <!-- Application lifecycle -->
    <!-- Live LaTeX Editor -->
    <script src="js/pandoc/live-latex-editor.js"></script>
    <!-- Live syntax highlighting -->
    <!-- Development Tools (Optional) -->
    <script src="js/pandoc/layout-debugger.js"></script>
    <!-- Layout debugging -->

    <!-- Testing Framework -->
    <!-- <script src="js/export/test-commands.js"></script> -->

    <script src="js/testing/test-utilities.js"></script>
    <script src="./js/testing/individual/test-app-config.js"></script>
    <script src="./js/testing/individual/test-mathjax-manager.js"></script>
    <script src="./js/testing/individual/test-latex-processor.js"></script>
    <script src="./js/testing/individual/test-content-generator.js"></script>
    <script src="./js/testing/individual/test-template-system.js"></script>
    <script src="./js/testing/integration/test-export-pipeline.js"></script>
    <script src="./js/testing/integration/test-modular-integration.js"></script>
    <script src="./js/testing/integration/test-accessibility-integration.js"></script>
    <script src="./js/testing/integration/test-performance.js"></script>
    <script src="./js/testing/individual/test-export-manager.js"></script>
    <script src="./js/testing/individual/test-example-system.js"></script>
    <script src="./js/testing/individual/test-status-manager.js"></script>
    <script src="./js/testing/individual/test-conversion-engine.js"></script>
    <script src="./js/testing/individual/test-event-manager.js"></script>
    <script src="./js/testing/individual/test-app-state-manager.js"></script>
    <script src="./js/testing/individual/test-layout-debugger.js"></script>
    <script src="./js/testing/individual/test-table-enhancements.js"></script>
    <script src="./js/testing/individual/test-scorm-export-manager.js"></script>
    <script src="./js/testing/individual/test-download-monitor.js"></script>
    <script src="js/testing/individual/test-source-viewer.js"></script>
    <script src="./js/testing/test-framework.js"></script>
    <script src="./js/testing/test-registry.js"></script>
    <script src="./js/testing/comprehensive/test-runner.js"></script>
    <!-- JS Migration testing -->
    <script src="./js/testing/migration/test-initialization-js-migration.js"></script>
    <script src="./js/testing/migration/test-mathjax-controls-js-migration.js"></script>
    <script src="./js/testing/migration/test-reading-tools-setup-js-migration.js"></script>
    <script src="./js/testing/migration/test-theme-management-js-migration.js"></script>
    <script src="./js/testing/migration/test-form-initialization-js-migration.js"></script>
    <script src="./js/testing/migration/test-focus-tracking-js-migration.js"></script>
    <script src="./js/testing/migration/test-reading-accessibility-manager-class-js-migration.js"></script>
    <script src="./js/testing/migration/test-enhanced-javascript-orchestrator-optimization.js"></script>
    <script src="./js/testing/migration/test-accessibility-configuration.js"></script>

    <!-- JS Migration testing ends -->

    <!-- Temporary Foundation Test -->
    <script>
      // Quick validation that TestUtilities is working
      if (typeof TestUtilities !== "undefined") {
        console.log("✅ TestUtilities loaded successfully");

        // Test the core runTestSuite function
        const sampleTests = {
          basicTest: () => true,
          mathTest: () => 2 + 2 === 4,
          stringTest: () => "hello".toUpperCase() === "HELLO",
        };

        const result = TestUtilities.runTestSuite(
          "Foundation Test",
          sampleTests
        );
        console.log("Foundation test result:", result);

        // Test performance measurement
        const perfResult = TestUtilities.measurePerformance(() => {
          Math.sqrt(Math.random() * 1000);
        }, 100);
        console.log("Performance test result:", perfResult);

        // Make foundation test available globally for console testing
        window.testFoundation = () =>
          TestUtilities.runTestSuite("Foundation Test", sampleTests);
      } else {
        console.error("❌ TestUtilities failed to load");
      }
    </script>

    <!-- Testing framework -->

    <!-- Investigation Controls Event Handlers -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Handle preset selection to show/hide custom arguments and update explanations
        const presetSelect = document.getElementById(
          "pandoc-enhancement-preset"
        );
        const customArgsContainer = document.getElementById(
          "custom-args-container"
        );
        const presetExplanation = document.getElementById("preset-explanation");

        if (presetSelect && customArgsContainer && presetExplanation) {
          // Define preset explanations with technical precision
          const presetExplanations = {
            "": {
              title: "Standard Arguments Only",
              description:
                "Using base Pandoc arguments: <code>--from latex --to html5 --mathjax</code>. No additional enhancements will be applied. This is the default, stable conversion mode.",
            },
            semantic: {
              title: "Semantic HTML Focus",
              args: "--section-divs --html-q-tags --wrap=preserve",
              description:
                "Produces semantic HTML5 structure: <code>--section-divs</code> wraps sections in &lt;section&gt; elements instead of &lt;div&gt;, <code>--html-q-tags</code> generates proper &lt;q&gt; elements for quotes, <code>--wrap=preserve</code> maintains source line breaks for better readability.",
            },
            accessibility: {
              title: "Accessibility Enhanced",
              args: "--section-divs --id-prefix=content- --html-q-tags --number-sections",
              description:
                "Enhances screen reader navigation: <code>--section-divs</code> creates semantic sections, <code>--id-prefix=content-</code> adds consistent ID prefixes for better landmarks, <code>--html-q-tags</code> uses semantic quote elements, <code>--number-sections</code> automatically numbers headings for structured navigation.",
            },
            structure: {
              title: "Document Structure",
              args: "--section-divs --wrap=preserve --standalone --toc",
              description:
                "Creates comprehensive document structure: <code>--section-divs</code> for semantic sections, <code>--wrap=preserve</code> maintains formatting, <code>--standalone</code> generates complete HTML document with head/body, <code>--toc</code> automatically generates table of contents navigation.",
            },
            theorem: {
              title: "Theorem Environment Focus",
              args: "--section-divs --wrap=preserve --html-q-tags --from=latex+fancy_lists",
              description:
                "Optimises mathematical content processing: <code>--section-divs</code> for semantic structure, <code>--wrap=preserve</code> maintains LaTeX formatting, <code>--html-q-tags</code> for proper quotes, <code>--from=latex+fancy_lists</code> enables enhanced LaTeX list processing for theorem environments.",
            },
            custom: {
              title: "Custom Arguments",
              description:
                "Define your own Pandoc arguments in the text area below. Arguments will be validated and applied during conversion. Use this for testing specific Pandoc features or combining multiple enhancement strategies.",
            },
          };

          presetSelect.addEventListener("change", function () {
            const selectedPreset = this.value;

            // Show/hide custom arguments container
            if (selectedPreset === "custom") {
              customArgsContainer.style.display = "block";
            } else {
              customArgsContainer.style.display = "none";
            }

            // Update preset explanation
            const explanation =
              presetExplanations[selectedPreset] || presetExplanations[""];
            let explanationHTML = `<strong style="color: var(--heading-color);">${explanation.title}</strong>`;

            if (explanation.args) {
              explanationHTML += `<br><code style="background: var(--body-bg); padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8rem;">${explanation.args}</code>`;
            }

            explanationHTML += `<br><span style="margin-top: 0.25rem; display: inline-block;">${explanation.description}</span>`;

            presetExplanation.innerHTML = explanationHTML;

            // Announce change to screen readers
            if (selectedPreset && selectedPreset !== "") {
              const announcement = `Preset changed to ${
                explanation.title
              }. ${explanation.description.replace(/<[^>]*>/g, "")}`;
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(announcement);
              }
            }
          });
        }

        // Handle hide/show LaTeX input panel
        const hideInputCheckbox = document.getElementById("hide-latex-input");
        const inputPanel = document.querySelector(".input-panel");
        const workspace = document.querySelector(".workspace");

        if (hideInputCheckbox && inputPanel && workspace) {
          hideInputCheckbox.addEventListener("change", function () {
            if (this.checked) {
              inputPanel.style.display = "none";
              // Adjust workspace layout to single column
              workspace.style.display = "block";
              const outputPanel = document.querySelector(".output-panel");
              if (outputPanel) {
                outputPanel.style.borderLeft = "none";
                outputPanel.style.width = "100%";
              }
            } else {
              inputPanel.style.display = "flex";
              // Restore workspace layout
              workspace.style.display = "flex";
              const outputPanel = document.querySelector(".output-panel");
              if (outputPanel) {
                outputPanel.style.borderLeft = "";
                outputPanel.style.width = "";
              }
            }
          });
        }

        // Handle export enhancement checkbox
        const exportEnhancedCheckbox = document.getElementById(
          "export-enhanced-pandoc"
        );
        const exportSubtitle = document.getElementById("export-subtitle");
        const exportMethodIndicator = document.getElementById(
          "export-method-indicator"
        );

        if (exportEnhancedCheckbox && exportSubtitle && exportMethodIndicator) {
          exportEnhancedCheckbox.addEventListener("change", function () {
            if (this.checked) {
              exportSubtitle.textContent = "Enhanced Semantic HTML";
              exportMethodIndicator.textContent =
                "Enhanced Pandoc export method will be used (investigation mode).";
              exportMethodIndicator.style.color = "var(--link-color)";
              exportMethodIndicator.style.fontWeight = "500";

              // Announce change to screen readers
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Enhanced Pandoc export enabled. Export will use investigation settings for better semantic HTML."
                );
              }
            } else {
              exportSubtitle.textContent = "Accessible HTML with MathJax";
              exportMethodIndicator.textContent =
                "Standard export method will be used.";
              exportMethodIndicator.style.color = "var(--text-secondary)";
              exportMethodIndicator.style.fontWeight = "normal";

              // Announce change to screen readers
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Enhanced Pandoc export disabled. Standard export method will be used."
                );
              }
            }
          });
        }

        // Handle refresh output button
        const refreshButton = document.getElementById("refresh-output-button");
        if (refreshButton) {
          refreshButton.addEventListener("click", function () {
            // Check if conversion engine is available and ready
            if (
              window.ConversionEngine &&
              window.ConversionEngine.isEngineReady()
            ) {
              // Provide user feedback
              const originalText = this.textContent;
              this.textContent = "🔄 Refreshing...";
              this.disabled = true;

              // Announce to screen readers
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Refreshing output with current investigation settings"
                );
              }

              // Trigger conversion with current settings
              try {
                window.ConversionEngine.convertInput();

                // Reset button after a short delay
                setTimeout(() => {
                  this.textContent = originalText;
                  this.disabled = false;
                }, 1000);
              } catch (error) {
                console.error("Error refreshing output:", error);
                this.textContent = "❌ Refresh Failed";
                setTimeout(() => {
                  this.textContent = originalText;
                  this.disabled = false;
                }, 2000);
              }
            } else {
              // Conversion engine not ready
              console.warn("Conversion engine not ready for refresh");
              if (window.AppConfig && window.AppConfig.announceToScreenReader) {
                window.AppConfig.announceToScreenReader(
                  "Cannot refresh: conversion engine not ready"
                );
              }
            }
          });
        }

        console.log("✅ Investigation controls event handlers setup complete");
      });
    </script>
    <!-- Application Initialization Message -->
    <script>
      console.log("=== ENHANCED PANDOC-WASM MATHEMATICAL PLAYGROUND ===");
      console.log("- LayoutDebugger.enable() - Enable layout debugging");
      console.log(
        "- window.AppStateManager.getApplicationStatus() - Check app status"
      );
      console.log("");
      console.log("====================================================");
    </script>
  </body>
</html>
