<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Color Adjuster</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .svg-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .svg-wrapper {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .svg-wrapper h3 {
            margin-top: 0;
            text-align: center;
        }
        .svg-content-wrapper {
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .svg-content {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            object-position: center;
        }
        #fileInput {
            display: none;
        }
        .btn {
            display: inline-block;
            background-color: #007bff;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        #colorInfo, #paletteSelection, #colorSwapInterface {
            margin-top: 20px;
        }
        select, button {
            font-size: 16px;
            padding: 5px 10px;
        }
        #colorSwapInterface {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .color-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .color-swatch {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }
        #paletteMessage {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            color: #856404;
        }
		
			  /* Filters */

.protanopia {
    -webkit-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#protanopia);
    -moz-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#protanopia);
    -ms-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#protanopia);
    -o-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#protanopia);
    filter: url(https://matthewdeeprose.github.io/daltonlens.svg#protanopia);
}

.deuteranopia {
    -webkit-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#deuteranopia);
    -moz-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#deuteranopia);
    -ms-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#deuteranopia);
    -o-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#deuteranopia);
    filter: url(https://matthewdeeprose.github.io/daltonlens.svg#deuteranopia);
}

.tritanopia {
    -webkit-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#tritanopia);
    -moz-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#tritanopia);
    -ms-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#tritanopia);
    -o-filter: url(https://matthewdeeprose.github.io/daltonlens.svg#tritanopia);
    filter: url(https://matthewdeeprose.github.io/daltonlens.svg#tritanopia);
}
		
    </style>
</head>
<body>
<h2>Normal</h2>
<div class="normal">
<img src="https://daltonlens.org/images/rgbspan.png">
</div>

<h2>Protanopia (Viénot, Brettel & Mollon 1999)</h2>
<div class="protanopia">
<img src="https://daltonlens.org/images/rgbspan.png">
</div>

<h2>Deuteranopia (Viénot, Brettel & Mollon 1999)</h2>
<div class="deuteranopia">
<img src="https://daltonlens.org/images/rgbspan.png">
</div>

<h2>Tritanopia (Brettel, Viénot & Mollon 1997)</h2>
<div class="tritanopia">
<img src="https://daltonlens.org/images/rgbspan.png">
</div>

    <div class="container">
        <h1>SVG Color Adjuster</h1>
        <input type="file" id="fileInput" accept=".svg" aria-label="Upload SVG file">
        <button id="uploadBtn" class="btn">Upload SVG</button>
        <button id="resetBtn" class="btn" disabled>Reset Colors</button>
        <button id="saveBtn" class="btn" disabled>Save SVG</button>

        <div class="svg-container">
            <div class="svg-wrapper">
                <h3>Original (Trichromacy)</h3>
                <div id="trichromacy" class="trichromacy svg-content-wrapper"></div>
            </div>
            <div class="svg-wrapper">
                <h3>Protanopia</h3>
                <div id="protanopia" class="protanopia svg-content-wrapper"></div>
            </div>
            <div class="svg-wrapper">
                <h3>Deuteranopia</h3>
                <div id="deuteranopia" class="deuteranopia svg-content-wrapper"></div>
            </div>
            <div class="svg-wrapper">
                <h3>Tritanopia</h3>
                <div id="tritanopia" class="tritanopia svg-content-wrapper"></div>
            </div>
        </div>

        <div id="colorInfo"></div>
        <div id="paletteSelection">
            <label for="paletteSelect">Select a color blind friendly palette:</label>
            <select id="paletteSelect"></select>
            <div id="paletteMessage"></div>
        </div>
        <div id="colorSwapInterface"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.1.2/svg.min.js"></script>
    <script>
        // Global variables
        let originalSvg;
        let svgColors = [];
        let selectedPalette = [];

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const saveBtn = document.getElementById('saveBtn');
        const colorInfo = document.getElementById('colorInfo');
        const paletteSelect = document.getElementById('paletteSelect');
        const colorSwapInterface = document.getElementById('colorSwapInterface');

        // Event Listeners
        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        resetBtn.addEventListener('click', resetColors);
        saveBtn.addEventListener('click', saveSvg);
        paletteSelect.addEventListener('change', handlePaletteSelection);

        // File upload handler
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'image/svg+xml') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalSvg = e.target.result;
                    displaySvg(originalSvg);
                    identifyColors();
                    loadPalettes();
                    resetBtn.disabled = false;
                    saveBtn.disabled = false;
                };
                reader.readAsText(file);
            } else {
                alert('Please upload a valid SVG file.');
            }
        }

        // Display SVG in all containers
        function displaySvg(svgContent) {
            const containers = ['trichromacy', 'protanopia', 'deuteranopia', 'tritanopia'];
            containers.forEach(id => {
                const container = document.getElementById(id);
                container.innerHTML = svgContent;
                const svg = container.querySelector('svg');
                if (svg) {
                    // Remove any existing width and height attributes
                    svg.removeAttribute('width');
                    svg.removeAttribute('height');

                    // Add class for styling
                    svg.classList.add('svg-content');

                    // Ensure viewBox is set
                    if (!svg.getAttribute('viewBox')) {
                        const bbox = svg.getBBox();
                        svg.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
                    }

                    // Set preserveAspectRatio to see the whole SVG
                    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                }
            });
        }

        // Identify unique colors in the SVG
        function identifyColors() {
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(originalSvg, 'image/svg+xml');
            const elements = svgDoc.querySelectorAll('*');
            const uniqueColors = new Set();

            elements.forEach(el => {
                const fill = el.getAttribute('fill');
                const stroke = el.getAttribute('stroke');
                if (fill && fill !== 'none') uniqueColors.add(fill);
                if (stroke && stroke !== 'none') uniqueColors.add(stroke);
            });

            svgColors = Array.from(uniqueColors);
            displayColorInfo();
        }

        // Display color information
        function displayColorInfo() {
            colorInfo.innerHTML = '<h3>Colors used in SVG:</h3>';
            svgColors.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-item';
                colorDiv.innerHTML = `
                    <div class="color-swatch" style="background-color: ${color};"></div>
                    <span>${color}</span>
                `;
                colorInfo.appendChild(colorDiv);
            });
        }

        // Load color palettes from https://matthewdeeprose.github.io/cvdp.json
        function loadPalettes() {
            fetch('https://matthewdeeprose.github.io/cvdp.json')
                .then(response => response.json())
                .then(data => {
                    const palettes = data.palettes;
                    paletteSelect.innerHTML = '<option value="">Select a palette</option>';
                    
                    let largestPalette = null;
                    let largestPaletteSize = 0;

                    for (const [name, colors] of Object.entries(palettes)) {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = `${name} (${colors.length} colors)`;
                        paletteSelect.appendChild(option);

                        if (colors.length > largestPaletteSize) {
                            largestPalette = name;
                            largestPaletteSize = colors.length;
                        }
                    }

                    if (svgColors.length > largestPaletteSize) {
                        paletteSelect.value = largestPalette;
                        displayPaletteMessage(svgColors.length, largestPaletteSize);
                    }

                    // Trigger palette selection to update the interface
                    handlePaletteSelection();
                })
                .catch(error => console.error('Error loading palettes:', error));
        }

        function displayPaletteMessage(svgColorCount, paletteColorCount) {
            const messageDiv = document.getElementById('paletteMessage');
            messageDiv.textContent = `Your SVG contains ${svgColorCount} colors, which exceeds the ${paletteColorCount} colors available in the largest palette. Some colors may not be replaced.`;
        }

        // Handle palette selection
        function handlePaletteSelection() {
            const selectedPaletteName = paletteSelect.value;
            if (selectedPaletteName) {
                fetch('https://matthewdeeprose.github.io/cvdp.json')
                    .then(response => response.json())
                    .then(data => {
                        selectedPalette = data.palettes[selectedPaletteName];
                        displayColorSwapInterface();
                        
                        // Clear the message if a palette is manually selected
                        if (svgColors.length <= selectedPalette.length) {
                            document.getElementById('paletteMessage').textContent = '';
                        }
                    })
                    .catch(error => console.error('Error loading selected palette:', error));
            } else {
                colorSwapInterface.innerHTML = '';
                document.getElementById('paletteMessage').textContent = '';
            }
        }

        // Display color swap interface
        function displayColorSwapInterface() {
            colorSwapInterface.innerHTML = '<h3>Swap Colors:</h3>';
            svgColors.forEach((originalColor, index) => {
                const swapDiv = document.createElement('div');
                swapDiv.className = 'color-item';
                swapDiv.innerHTML = `
                    <div class="color-swatch" style="background-color: ${originalColor};"></div>
                    <span>${originalColor}</span>
                    <select aria-label="Select new color for ${originalColor}">
                        <option value="">Keep original</option>
                        ${selectedPalette.map(newColor => `<option value="${newColor}">${newColor}</option>`).join('')}
                    </select>
                `;
                const select = swapDiv.querySelector('select');
                select.addEventListener('change', () => updateSvgColors(originalColor, select.value));
                colorSwapInterface.appendChild(swapDiv);
            });
        }

        // Update SVG colors
        function updateSvgColors(originalColor, newColor) {
            if (newColor) {
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(originalSvg, 'image/svg+xml');
                const elements = svgDoc.querySelectorAll('*');

                elements.forEach(el => {
                    if (el.getAttribute('fill') === originalColor) {
                        el.setAttribute('fill', newColor);
                    }
                    if (el.getAttribute('stroke') === originalColor) {
                        el.setAttribute('stroke', newColor);
                    }
                });

                const serializer = new XMLSerializer();
                const updatedSvg = serializer.serializeToString(svgDoc);
                displaySvg(updatedSvg);
            }
        }

        // Reset colors to original
        function resetColors() {
            displaySvg(originalSvg);
            paletteSelect.value = '';
            colorSwapInterface.innerHTML = '';
            document.getElementById('paletteMessage').textContent = '';
        }

        // Save updated SVG
        function saveSvg() {
            const svgContent = document.getElementById('trichromacy').innerHTML;
            const blob = new Blob([svgContent], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'updated_svg.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
